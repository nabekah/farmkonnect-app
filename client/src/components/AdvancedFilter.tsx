import React, { useState, useCallback, useMemo } from 'react';\nimport { X, Save, Trash2, ChevronDown } from 'lucide-react';\n\nexport type FilterOperator = 'equals' | 'contains' | 'startsWith' | 'endsWith' | 'greaterThan' | 'lessThan' | 'between' | 'in' | 'notEquals';\nexport type FilterLogic = 'AND' | 'OR';\n\nexport interface FilterField {\n  id: string;\n  name: string;\n  label: string;\n  type: 'text' | 'number' | 'date' | 'select' | 'multiselect' | 'range';\n  options?: Array<{ label: string; value: string | number }>;\n}\n\nexport interface FilterCondition {\n  id: string;\n  fieldId: string;\n  operator: FilterOperator;\n  value: any;\n  value2?: any; // For 'between' operator\n}\n\nexport interface FilterGroup {\n  id: string;\n  logic: FilterLogic;\n  conditions: FilterCondition[];\n}\n\nexport interface FilterPreset {\n  id: string;\n  name: string;\n  description: string;\n  filters: FilterGroup[];\n  createdAt: number;\n  updatedAt: number;\n}\n\nexport interface AdvancedFilterProps {\n  fields: FilterField[];\n  onApply: (filters: FilterGroup[]) => void;\n  onSavePreset?: (preset: FilterPreset) => void;\n  presets?: FilterPreset[];\n  onDeletePreset?: (presetId: string) => void;\n}\n\n/**\n * Advanced Filter Component\n */\nexport const AdvancedFilter: React.FC<AdvancedFilterProps> = ({\n  fields,\n  onApply,\n  onSavePreset,\n  presets = [],\n  onDeletePreset,\n}) => {\n  const [filterGroups, setFilterGroups] = useState<FilterGroup[]>([\n    {\n      id: `group_${Date.now()}`,\n      logic: 'AND',\n      conditions: [],\n    },\n  ]);\n\n  const [showPresets, setShowPresets] = useState(false);\n  const [presetName, setPresetName] = useState('');\n  const [presetDescription, setPresetDescription] = useState('');\n\n  const getFieldLabel = useCallback(\n    (fieldId: string) => {\n      return fields.find((f) => f.id === fieldId)?.label || fieldId;\n    },\n    [fields]\n  );\n\n  const getOperatorLabel = (operator: FilterOperator): string => {\n    const labels: Record<FilterOperator, string> = {\n      equals: 'Equals',\n      contains: 'Contains',\n      startsWith: 'Starts With',\n      endsWith: 'Ends With',\n      greaterThan: 'Greater Than',\n      lessThan: 'Less Than',\n      between: 'Between',\n      in: 'In',\n      notEquals: 'Not Equals',\n    };\n    return labels[operator];\n  };\n\n  const addCondition = (groupId: string) => {\n    setFilterGroups((prev) =>\n      prev.map((group) =>\n        group.id === groupId\n          ? {\n              ...group,\n              conditions: [\n                ...group.conditions,\n                {\n                  id: `cond_${Date.now()}`,\n                  fieldId: fields[0]?.id || '',\n                  operator: 'equals',\n                  value: '',\n                },\n              ],\n            }\n          : group\n      )\n    );\n  };\n\n  const removeCondition = (groupId: string, conditionId: string) => {\n    setFilterGroups((prev) =>\n      prev.map((group) =>\n        group.id === groupId\n          ? {\n              ...group,\n              conditions: group.conditions.filter((c) => c.id !== conditionId),\n            }\n          : group\n      )\n    );\n  };\n\n  const updateCondition = (groupId: string, conditionId: string, updates: Partial<FilterCondition>) => {\n    setFilterGroups((prev) =>\n      prev.map((group) =>\n        group.id === groupId\n          ? {\n              ...group,\n              conditions: group.conditions.map((c) =>\n                c.id === conditionId ? { ...c, ...updates } : c\n              ),\n            }\n          : group\n      )\n    );\n  };\n\n  const addGroup = () => {\n    setFilterGroups((prev) => [\n      ...prev,\n      {\n        id: `group_${Date.now()}`,\n        logic: 'AND',\n        conditions: [],\n      },\n    ]);\n  };\n\n  const removeGroup = (groupId: string) => {\n    if (filterGroups.length > 1) {\n      setFilterGroups((prev) => prev.filter((g) => g.id !== groupId));\n    }\n  };\n\n  const updateGroupLogic = (groupId: string, logic: FilterLogic) => {\n    setFilterGroups((prev) =>\n      prev.map((group) => (group.id === groupId ? { ...group, logic } : group))\n    );\n  };\n\n  const handleApply = () => {\n    onApply(filterGroups);\n  };\n\n  const handleSavePreset = () => {\n    if (!presetName.trim() || !onSavePreset) return;\n\n    const preset: FilterPreset = {\n      id: `preset_${Date.now()}`,\n      name: presetName,\n      description: presetDescription,\n      filters: filterGroups,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n\n    onSavePreset(preset);\n    setPresetName('');\n    setPresetDescription('');\n  };\n\n  const handleLoadPreset = (preset: FilterPreset) => {\n    setFilterGroups(preset.filters);\n  };\n\n  const handleDeletePreset = (presetId: string) => {\n    if (onDeletePreset) {\n      onDeletePreset(presetId);\n    }\n  };\n\n  const hasActiveFilters = useMemo(\n    () => filterGroups.some((g) => g.conditions.length > 0),\n    [filterGroups]\n  );\n\n  return (\n    <div className=\"space-y-4 p-4 bg-white rounded-lg border border-gray-200\">\n      <div className=\"flex justify-between items-center\">\n        <h3 className=\"text-lg font-semibold\">Advanced Filters</h3>\n        <button\n          onClick={() => setShowPresets(!showPresets)}\n          className=\"text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1\"\n        >\n          <ChevronDown size={16} className={showPresets ? 'rotate-180' : ''} />\n          Presets\n        </button>\n      </div>\n\n      {showPresets && (\n        <div className=\"bg-gray-50 p-3 rounded space-y-2\">\n          <div className=\"space-y-2\">\n            <input\n              type=\"text\"\n              placeholder=\"Preset name\"\n              value={presetName}\n              onChange={(e) => setPresetName(e.target.value)}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded text-sm\"\n            />\n            <input\n              type=\"text\"\n              placeholder=\"Description (optional)\"\n              value={presetDescription}\n              onChange={(e) => setPresetDescription(e.target.value)}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded text-sm\"\n            />\n            <button\n              onClick={handleSavePreset}\n              disabled={!presetName.trim()}\n              className=\"w-full px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center gap-2\"\n            >\n              <Save size={16} />\n              Save as Preset\n            </button>\n          </div>\n\n          {presets.length > 0 && (\n            <div className=\"space-y-1 border-t pt-2\">\n              {presets.map((preset) => (\n                <div key={preset.id} className=\"flex justify-between items-center p-2 bg-white rounded text-sm\">\n                  <div\n                    className=\"flex-1 cursor-pointer hover:text-blue-600\"\n                    onClick={() => handleLoadPreset(preset)}\n                  >\n                    <div className=\"font-medium\">{preset.name}</div>\n                    {preset.description && <div className=\"text-gray-500 text-xs\">{preset.description}</div>}\n                  </div>\n                  <button\n                    onClick={() => handleDeletePreset(preset.id)}\n                    className=\"p-1 text-red-600 hover:bg-red-50 rounded\"\n                  >\n                    <Trash2 size={14} />\n                  </button>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n\n      <div className=\"space-y-3\">\n        {filterGroups.map((group, groupIndex) => (\n          <div key={group.id} className=\"border border-gray-200 rounded p-3 space-y-2\">\n            <div className=\"flex justify-between items-center\">\n              <select\n                value={group.logic}\n                onChange={(e) => updateGroupLogic(group.id, e.target.value as FilterLogic)}\n                className=\"px-2 py-1 border border-gray-300 rounded text-sm font-medium\"\n              >\n                <option value=\"AND\">AND</option>\n                <option value=\"OR\">OR</option>\n              </select>\n              {filterGroups.length > 1 && (\n                <button\n                  onClick={() => removeGroup(group.id)}\n                  className=\"p-1 text-red-600 hover:bg-red-50 rounded\"\n                >\n                  <X size={16} />\n                </button>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              {group.conditions.map((condition) => {\n                const field = fields.find((f) => f.id === condition.fieldId);\n                return (\n                  <div key={condition.id} className=\"flex gap-2 items-start\">\n                    <select\n                      value={condition.fieldId}\n                      onChange={(e) =>\n                        updateCondition(group.id, condition.id, { fieldId: e.target.value })\n                      }\n                      className=\"px-2 py-1 border border-gray-300 rounded text-sm flex-1\"\n                    >\n                      {fields.map((f) => (\n                        <option key={f.id} value={f.id}>\n                          {f.label}\n                        </option>\n                      ))}\n                    </select>\n\n                    <select\n                      value={condition.operator}\n                      onChange={(e) =>\n                        updateCondition(group.id, condition.id, {\n                          operator: e.target.value as FilterOperator,\n                        })\n                      }\n                      className=\"px-2 py-1 border border-gray-300 rounded text-sm flex-1\"\n                    >\n                      <option value=\"equals\">Equals</option>\n                      <option value=\"contains\">Contains</option>\n                      <option value=\"startsWith\">Starts With</option>\n                      <option value=\"endsWith\">Ends With</option>\n                      <option value=\"greaterThan\">Greater Than</option>\n                      <option value=\"lessThan\">Less Than</option>\n                      <option value=\"between\">Between</option>\n                      <option value=\"notEquals\">Not Equals</option>\n                    </select>\n\n                    {field?.type === 'select' || field?.type === 'multiselect' ? (\n                      <select\n                        value={condition.value}\n                        onChange={(e) =>\n                          updateCondition(group.id, condition.id, { value: e.target.value })\n                        }\n                        className=\"px-2 py-1 border border-gray-300 rounded text-sm flex-1\"\n                      >\n                        <option value=\"\">Select...</option>\n                        {field.options?.map((opt) => (\n                          <option key={opt.value} value={opt.value}>\n                            {opt.label}\n                          </option>\n                        ))}\n                      </select>\n                    ) : (\n                      <input\n                        type={field?.type === 'date' ? 'date' : field?.type === 'number' ? 'number' : 'text'}\n                        value={condition.value}\n                        onChange={(e) =>\n                          updateCondition(group.id, condition.id, { value: e.target.value })\n                        }\n                        className=\"px-2 py-1 border border-gray-300 rounded text-sm flex-1\"\n                      />\n                    )}\n\n                    {condition.operator === 'between' && (\n                      <input\n                        type={field?.type === 'date' ? 'date' : field?.type === 'number' ? 'number' : 'text'}\n                        value={condition.value2 || ''}\n                        onChange={(e) =>\n                          updateCondition(group.id, condition.id, { value2: e.target.value })\n                        }\n                        className=\"px-2 py-1 border border-gray-300 rounded text-sm flex-1\"\n                        placeholder=\"To\"\n                      />\n                    )}\n\n                    <button\n                      onClick={() => removeCondition(group.id, condition.id)}\n                      className=\"p-1 text-red-600 hover:bg-red-50 rounded\"\n                    >\n                      <X size={16} />\n                    </button>\n                  </div>\n                );\n              })}\n            </div>\n\n            <button\n              onClick={() => addCondition(group.id)}\n              className=\"w-full px-3 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded border border-blue-200\"\n            >\n              + Add Condition\n            </button>\n          </div>\n        ))}\n      </div>\n\n      <button\n        onClick={addGroup}\n        className=\"w-full px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 rounded border border-gray-300\"\n      >\n        + Add Filter Group\n      </button>\n\n      <div className=\"flex gap-2\">\n        <button\n          onClick={handleApply}\n          disabled={!hasActiveFilters}\n          className=\"flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400 font-medium\"\n        >\n          Apply Filters\n        </button>\n        <button\n          onClick={() =>\n            setFilterGroups([\n              {\n                id: `group_${Date.now()}`,\n                logic: 'AND',\n                conditions: [],\n              },\n            ])\n          }\n          className=\"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded border border-gray-300\"\n        >\n          Reset\n        </button>\n      </div>\n    </div>\n  );\n};\n\nexport default AdvancedFilter;\n
