import React, { useState, useCallback, useMemo } from 'react';\nimport { X, Plus, Save, Trash2, Copy, ChevronDown, Filter } from 'lucide-react';\n\nexport type FilterOperator =\n  | 'equals'\n  | 'not_equals'\n  | 'contains'\n  | 'not_contains'\n  | 'greater_than'\n  | 'less_than'\n  | 'between'\n  | 'in'\n  | 'not_in';\n\nexport type FieldType = 'text' | 'number' | 'date' | 'select' | 'multiselect' | 'range' | 'boolean';\n\nexport interface FilterField {\n  id: string;\n  name: string;\n  type: FieldType;\n  options?: Array<{ value: string; label: string }>;\n}\n\nexport interface FilterCondition {\n  id: string;\n  fieldId: string;\n  operator: FilterOperator;\n  value: any;\n  value2?: any; // For between operator\n}\n\nexport interface FilterGroup {\n  id: string;\n  logic: 'AND' | 'OR';\n  conditions: FilterCondition[];\n  groups: FilterGroup[];\n}\n\nexport interface FilterPreset {\n  id: string;\n  name: string;\n  description: string;\n  filter: FilterGroup;\n  createdAt: number;\n  updatedAt: number;\n  isPublic: boolean;\n}\n\ninterface AdvancedFilteringUIProps {\n  fields: FilterField[];\n  onApplyFilter: (filter: FilterGroup) => void;\n  onSavePreset: (preset: FilterPreset) => void;\n  presets: FilterPreset[];\n  onLoadPreset: (preset: FilterPreset) => void;\n  onDeletePreset: (presetId: string) => void;\n}\n\nconst AdvancedFilteringUI: React.FC<AdvancedFilteringUIProps> = ({\n  fields,\n  onApplyFilter,\n  onSavePreset,\n  presets,\n  onLoadPreset,\n  onDeletePreset,\n}) => {\n  const [filterGroup, setFilterGroup] = useState<FilterGroup>({\n    id: `group-${Date.now()}`,\n    logic: 'AND',\n    conditions: [],\n    groups: [],\n  });\n\n  const [showPresets, setShowPresets] = useState(false);\n  const [presetName, setPresetName] = useState('');\n  const [presetDescription, setPresetDescription] = useState('');\n  const [isPublic, setIsPublic] = useState(false);\n  const [expandedGroups, setExpandedGroups] = useState<Set<string>>(new Set([filterGroup.id]));\n\n  const getFieldById = useCallback(\n    (fieldId: string) => fields.find((f) => f.id === fieldId),\n    [fields]\n  );\n\n  const getOperatorOptions = useCallback((fieldType: FieldType): FilterOperator[] => {\n    const operatorMap: Record<FieldType, FilterOperator[]> = {\n      text: ['equals', 'not_equals', 'contains', 'not_contains', 'in', 'not_in'],\n      number: ['equals', 'not_equals', 'greater_than', 'less_than', 'between', 'in'],\n      date: ['equals', 'not_equals', 'greater_than', 'less_than', 'between'],\n      select: ['equals', 'not_equals', 'in', 'not_in'],\n      multiselect: ['in', 'not_in', 'contains'],\n      range: ['between', 'greater_than', 'less_than'],\n      boolean: ['equals', 'not_equals'],\n    };\n    return operatorMap[fieldType] || [];\n  }, []);\n\n  const addCondition = useCallback((groupId: string) => {\n    setFilterGroup((prev) => {\n      const updateGroup = (g: FilterGroup): FilterGroup => {\n        if (g.id === groupId) {\n          return {\n            ...g,\n            conditions: [\n              ...g.conditions,\n              {\n                id: `cond-${Date.now()}`,\n                fieldId: fields[0]?.id || '',\n                operator: 'equals' as FilterOperator,\n                value: '',\n              },\n            ],\n          };\n        }\n        return {\n          ...g,\n          groups: g.groups.map(updateGroup),\n        };\n      };\n      return updateGroup(prev);\n    });\n  }, [fields]);\n\n  const removeCondition = useCallback((groupId: string, conditionId: string) => {\n    setFilterGroup((prev) => {\n      const updateGroup = (g: FilterGroup): FilterGroup => {\n        if (g.id === groupId) {\n          return {\n            ...g,\n            conditions: g.conditions.filter((c) => c.id !== conditionId),\n          };\n        }\n        return {\n          ...g,\n          groups: g.groups.map(updateGroup),\n        };\n      };\n      return updateGroup(prev);\n    });\n  }, []);\n\n  const updateCondition = useCallback(\n    (groupId: string, conditionId: string, updates: Partial<FilterCondition>) => {\n      setFilterGroup((prev) => {\n        const updateGroup = (g: FilterGroup): FilterGroup => {\n          if (g.id === groupId) {\n            return {\n              ...g,\n              conditions: g.conditions.map((c) =>\n                c.id === conditionId ? { ...c, ...updates } : c\n              ),\n            };\n          }\n          return {\n            ...g,\n            groups: g.groups.map(updateGroup),\n          };\n        };\n        return updateGroup(prev);\n      });\n    },\n    []\n  );\n\n  const addGroup = useCallback((parentGroupId: string) => {\n    setFilterGroup((prev) => {\n      const updateGroup = (g: FilterGroup): FilterGroup => {\n        if (g.id === parentGroupId) {\n          const newGroup: FilterGroup = {\n            id: `group-${Date.now()}`,\n            logic: 'AND',\n            conditions: [],\n            groups: [],\n          };\n          return {\n            ...g,\n            groups: [...g.groups, newGroup],\n          };\n        }\n        return {\n          ...g,\n          groups: g.groups.map(updateGroup),\n        };\n      };\n      return updateGroup(prev);\n    });\n  }, []);\n\n  const removeGroup = useCallback((parentGroupId: string, groupId: string) => {\n    setFilterGroup((prev) => {\n      const updateGroup = (g: FilterGroup): FilterGroup => {\n        if (g.id === parentGroupId) {\n          return {\n            ...g,\n            groups: g.groups.filter((gr) => gr.id !== groupId),\n          };\n        }\n        return {\n          ...g,\n          groups: g.groups.map(updateGroup),\n        };\n      };\n      return updateGroup(prev);\n    });\n  }, []);\n\n  const updateGroupLogic = useCallback((groupId: string, logic: 'AND' | 'OR') => {\n    setFilterGroup((prev) => {\n      const updateGroup = (g: FilterGroup): FilterGroup => {\n        if (g.id === groupId) {\n          return { ...g, logic };\n        }\n        return {\n          ...g,\n          groups: g.groups.map(updateGroup),\n        };\n      };\n      return updateGroup(prev);\n    });\n  }, []);\n\n  const toggleGroupExpanded = useCallback((groupId: string) => {\n    setExpandedGroups((prev) => {\n      const next = new Set(prev);\n      if (next.has(groupId)) {\n        next.delete(groupId);\n      } else {\n        next.add(groupId);\n      }\n      return next;\n    });\n  }, []);\n\n  const handleApplyFilter = useCallback(() => {\n    onApplyFilter(filterGroup);\n  }, [filterGroup, onApplyFilter]);\n\n  const handleSavePreset = useCallback(() => {\n    if (!presetName.trim()) return;\n\n    const preset: FilterPreset = {\n      id: `preset-${Date.now()}`,\n      name: presetName,\n      description: presetDescription,\n      filter: filterGroup,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      isPublic,\n    };\n\n    onSavePreset(preset);\n    setPresetName('');\n    setPresetDescription('');\n    setIsPublic(false);\n  }, [presetName, presetDescription, isPublic, filterGroup, onSavePreset]);\n\n  const handleLoadPreset = useCallback(\n    (preset: FilterPreset) => {\n      setFilterGroup(preset.filter);\n      setExpandedGroups(new Set([preset.filter.id]));\n      onLoadPreset(preset);\n    },\n    [onLoadPreset]\n  );\n\n  const conditionCount = useMemo(() => {\n    let count = 0;\n    const countConditions = (g: FilterGroup) => {\n      count += g.conditions.length;\n      g.groups.forEach(countConditions);\n    };\n    countConditions(filterGroup);\n    return count;\n  }, [filterGroup]);\n\n  const renderCondition = (groupId: string, condition: FilterCondition, index: number) => {\n    const field = getFieldById(condition.fieldId);\n    const operators = field ? getOperatorOptions(field.type) : [];\n\n    return (\n      <div key={condition.id} className=\"flex gap-2 items-end mb-2 p-2 bg-slate-50 rounded\">\n        <select\n          value={condition.fieldId}\n          onChange={(e) =>\n            updateCondition(groupId, condition.id, { fieldId: e.target.value })\n          }\n          className=\"px-2 py-1 border border-slate-300 rounded text-sm flex-1\"\n        >\n          {fields.map((f) => (\n            <option key={f.id} value={f.id}>\n              {f.name}\n            </option>\n          ))}\n        </select>\n\n        <select\n          value={condition.operator}\n          onChange={(e) =>\n            updateCondition(groupId, condition.id, { operator: e.target.value as FilterOperator })\n          }\n          className=\"px-2 py-1 border border-slate-300 rounded text-sm\"\n        >\n          {operators.map((op) => (\n            <option key={op} value={op}>\n              {op.replace(/_/g, ' ')}\n            </option>\n          ))}\n        </select>\n\n        {field && field.type === 'select' && field.options ? (\n          <select\n            value={condition.value}\n            onChange={(e) => updateCondition(groupId, condition.id, { value: e.target.value })}\n            className=\"px-2 py-1 border border-slate-300 rounded text-sm flex-1\"\n          >\n            <option value=\"\">Select...</option>\n            {field.options.map((opt) => (\n              <option key={opt.value} value={opt.value}>\n                {opt.label}\n              </option>\n            ))}\n          </select>\n        ) : field && field.type === 'date' ? (\n          <input\n            type=\"date\"\n            value={condition.value}\n            onChange={(e) => updateCondition(groupId, condition.id, { value: e.target.value })}\n            className=\"px-2 py-1 border border-slate-300 rounded text-sm flex-1\"\n          />\n        ) : field && field.type === 'number' ? (\n          <input\n            type=\"number\"\n            value={condition.value}\n            onChange={(e) => updateCondition(groupId, condition.id, { value: e.target.value })}\n            className=\"px-2 py-1 border border-slate-300 rounded text-sm flex-1\"\n            placeholder=\"Value\"\n          />\n        ) : (\n          <input\n            type=\"text\"\n            value={condition.value}\n            onChange={(e) => updateCondition(groupId, condition.id, { value: e.target.value })}\n            className=\"px-2 py-1 border border-slate-300 rounded text-sm flex-1\"\n            placeholder=\"Value\"\n          />\n        )}\n\n        {condition.operator === 'between' && (\n          <input\n            type={field?.type === 'number' ? 'number' : 'text'}\n            value={condition.value2 || ''}\n            onChange={(e) => updateCondition(groupId, condition.id, { value2: e.target.value })}\n            className=\"px-2 py-1 border border-slate-300 rounded text-sm flex-1\"\n            placeholder=\"To\"\n          />\n        )}\n\n        <button\n          onClick={() => removeCondition(groupId, condition.id)}\n          className=\"p-1 text-red-600 hover:bg-red-50 rounded\"\n          title=\"Remove condition\"\n        >\n          <X size={18} />\n        </button>\n      </div>\n    );\n  };\n\n  const renderGroup = (group: FilterGroup, level: number = 0): React.ReactNode => {\n    const isExpanded = expandedGroups.has(group.id);\n    const isRoot = level === 0;\n\n    return (\n      <div\n        key={group.id}\n        className={`border rounded p-3 mb-2 ${isRoot ? 'border-blue-300 bg-blue-50' : 'border-slate-300 bg-slate-50'}`}\n      >\n        <div className=\"flex items-center gap-2 mb-2\">\n          {!isRoot && (\n            <button\n              onClick={() => toggleGroupExpanded(group.id)}\n              className=\"p-1 hover:bg-slate-200 rounded\"\n            >\n              <ChevronDown\n                size={18}\n                className={`transform transition-transform ${isExpanded ? '' : '-rotate-90'}`}\n              />\n            </button>\n          )}\n\n          <div className=\"flex gap-2 items-center\">\n            <button\n              onClick={() => updateGroupLogic(group.id, group.logic === 'AND' ? 'OR' : 'AND')}\n              className={`px-2 py-1 rounded text-sm font-semibold ${\n                group.logic === 'AND'\n                  ? 'bg-blue-500 text-white'\n                  : 'bg-orange-500 text-white'\n              }`}\n            >\n              {group.logic}\n            </button>\n          </div>\n\n          <div className=\"flex gap-1 ml-auto\">\n            <button\n              onClick={() => addCondition(group.id)}\n              className=\"p-1 text-blue-600 hover:bg-blue-100 rounded\"\n              title=\"Add condition\"\n            >\n              <Plus size={18} />\n            </button>\n            {!isRoot && (\n              <>\n                <button\n                  onClick={() => addGroup(group.id)}\n                  className=\"p-1 text-green-600 hover:bg-green-100 rounded\"\n                  title=\"Add nested group\"\n                >\n                  <Filter size={18} />\n                </button>\n                <button\n                  onClick={() => removeGroup(group.id, group.id)}\n                  className=\"p-1 text-red-600 hover:bg-red-100 rounded\"\n                  title=\"Remove group\"\n                >\n                  <Trash2 size={18} />\n                </button>\n              </>\n            )}\n          </div>\n        </div>\n\n        {isExpanded || isRoot ? (\n          <>\n            <div className=\"ml-2\">\n              {group.conditions.map((cond, idx) => renderCondition(group.id, cond, idx))}\n            </div>\n\n            {group.groups.length > 0 && (\n              <div className=\"ml-2 mt-2\">\n                {group.groups.map((g) => renderGroup(g, level + 1))}\n              </div>\n            )}\n          </>\n        ) : null}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"w-full max-w-4xl mx-auto p-4 bg-white rounded-lg border border-slate-200\">\n      <div className=\"flex items-center justify-between mb-4\">\n        <h2 className=\"text-xl font-bold flex items-center gap-2\">\n          <Filter size={24} />\n          Advanced Filtering\n        </h2>\n        <div className=\"text-sm text-slate-600\">\n          {conditionCount} condition{conditionCount !== 1 ? 's' : ''}\n        </div>\n      </div>\n\n      {/* Filter Builder */}\n      <div className=\"mb-4\">{renderGroup(filterGroup)}</div>\n\n      {/* Action Buttons */}\n      <div className=\"flex gap-2 mb-4\">\n        <button\n          onClick={handleApplyFilter}\n          className=\"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold\"\n        >\n          Apply Filter\n        </button>\n        <button\n          onClick={() => setShowPresets(!showPresets)}\n          className=\"px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700 font-semibold\"\n        >\n          Presets ({presets.length})\n        </button>\n      </div>\n\n      {/* Save Preset Section */}\n      <div className=\"mb-4 p-3 bg-slate-100 rounded\">\n        <h3 className=\"font-semibold mb-2\">Save as Preset</h3>\n        <div className=\"flex gap-2 mb-2\">\n          <input\n            type=\"text\"\n            value={presetName}\n            onChange={(e) => setPresetName(e.target.value)}\n            placeholder=\"Preset name\"\n            className=\"flex-1 px-2 py-1 border border-slate-300 rounded text-sm\"\n          />\n          <button\n            onClick={handleSavePreset}\n            disabled={!presetName.trim()}\n            className=\"px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-slate-400 flex items-center gap-1\"\n          >\n            <Save size={16} />\n            Save\n          </button>\n        </div>\n        <input\n          type=\"text\"\n          value={presetDescription}\n          onChange={(e) => setPresetDescription(e.target.value)}\n          placeholder=\"Description (optional)\"\n          className=\"w-full px-2 py-1 border border-slate-300 rounded text-sm mb-2\"\n        />\n        <label className=\"flex items-center gap-2 text-sm\">\n          <input\n            type=\"checkbox\"\n            checked={isPublic}\n            onChange={(e) => setIsPublic(e.target.checked)}\n            className=\"rounded\"\n          />\n          Make public\n        </label>\n      </div>\n\n      {/* Presets List */}\n      {showPresets && presets.length > 0 && (\n        <div className=\"p-3 bg-slate-100 rounded\">\n          <h3 className=\"font-semibold mb-2\">Saved Presets</h3>\n          <div className=\"space-y-2\">\n            {presets.map((preset) => (\n              <div key={preset.id} className=\"flex items-center justify-between p-2 bg-white rounded border\">\n                <div className=\"flex-1\">\n                  <div className=\"font-semibold text-sm\">{preset.name}</div>\n                  {preset.description && (\n                    <div className=\"text-xs text-slate-600\">{preset.description}</div>\n                  )}\n                </div>\n                <div className=\"flex gap-1\">\n                  <button\n                    onClick={() => handleLoadPreset(preset)}\n                    className=\"px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600\"\n                  >\n                    Load\n                  </button>\n                  <button\n                    onClick={() => onDeletePreset(preset.id)}\n                    className=\"px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600\"\n                  >\n                    Delete\n                  </button>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default AdvancedFilteringUI;\n
