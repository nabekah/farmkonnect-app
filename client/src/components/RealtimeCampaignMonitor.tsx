import React, { useState, useEffect, useCallback } from 'react';\nimport { AlertCircle, CheckCircle, Clock, Send, TrendingUp, Users, Zap } from 'lucide-react';\nimport { Card } from '@/components/ui/card';\nimport { Progress } from '@/components/ui/progress';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\n\nexport interface CampaignStatus {\n  campaignId: string;\n  campaignName: string;\n  status: 'draft' | 'scheduled' | 'running' | 'paused' | 'completed' | 'failed';\n  progress: number;\n  totalRecipients: number;\n  sent: number;\n  delivered: number;\n  opened: number;\n  clicked: number;\n  converted: number;\n  failed: number;\n  estimatedCompletion?: number;\n  startTime?: number;\n  endTime?: number;\n  errorMessage?: string;\n}\n\nexport interface CampaignAlert {\n  id: string;\n  campaignId: string;\n  type: 'warning' | 'error' | 'info';\n  message: string;\n  timestamp: number;\n  resolved: boolean;\n}\n\ninterface RealtimeCampaignMonitorProps {\n  campaigns: CampaignStatus[];\n  alerts?: CampaignAlert[];\n  onPauseCampaign?: (campaignId: string) => void;\n  onResumeCampaign?: (campaignId: string) => void;\n  onCancelCampaign?: (campaignId: string) => void;\n  refreshInterval?: number;\n}\n\nconst RealtimeCampaignMonitor: React.FC<RealtimeCampaignMonitorProps> = ({\n  campaigns,\n  alerts = [],\n  onPauseCampaign,\n  onResumeCampaign,\n  onCancelCampaign,\n  refreshInterval = 5000,\n}) => {\n  const [selectedCampaign, setSelectedCampaign] = useState<string | null>(\n    campaigns.length > 0 ? campaigns[0].campaignId : null\n  );\n  const [expandedAlerts, setExpandedAlerts] = useState<Set<string>>(new Set());\n  const [autoRefresh, setAutoRefresh] = useState(true);\n\n  // Get status color\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'running':\n        return 'bg-blue-100 text-blue-800';\n      case 'completed':\n        return 'bg-green-100 text-green-800';\n      case 'failed':\n        return 'bg-red-100 text-red-800';\n      case 'paused':\n        return 'bg-yellow-100 text-yellow-800';\n      case 'scheduled':\n        return 'bg-purple-100 text-purple-800';\n      default:\n        return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  // Get status icon\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case 'running':\n        return <Zap className=\"h-4 w-4\" />;\n      case 'completed':\n        return <CheckCircle className=\"h-4 w-4\" />;\n      case 'failed':\n        return <AlertCircle className=\"h-4 w-4\" />;\n      case 'paused':\n        return <Clock className=\"h-4 w-4\" />;\n      case 'scheduled':\n        return <Send className=\"h-4 w-4\" />;\n      default:\n        return null;\n    }\n  };\n\n  // Format time\n  const formatTime = (ms: number) => {\n    const seconds = Math.floor(ms / 1000);\n    const minutes = Math.floor(seconds / 60);\n    const hours = Math.floor(minutes / 60);\n\n    if (hours > 0) return `${hours}h ${minutes % 60}m`;\n    if (minutes > 0) return `${minutes}m ${seconds % 60}s`;\n    return `${seconds}s`;\n  };\n\n  // Calculate time remaining\n  const getTimeRemaining = (campaign: CampaignStatus) => {\n    if (!campaign.estimatedCompletion || campaign.status !== 'running') return null;\n    const remaining = campaign.estimatedCompletion - Date.now();\n    return remaining > 0 ? formatTime(remaining) : 'Completing...';\n  };\n\n  // Get engagement metrics\n  const getEngagementMetrics = (campaign: CampaignStatus) => {\n    return {\n      deliveryRate: campaign.sent > 0 ? ((campaign.delivered / campaign.sent) * 100).toFixed(1) : '0',\n      openRate: campaign.delivered > 0 ? ((campaign.opened / campaign.delivered) * 100).toFixed(1) : '0',\n      clickRate: campaign.opened > 0 ? ((campaign.clicked / campaign.opened) * 100).toFixed(1) : '0',\n      conversionRate: campaign.clicked > 0 ? ((campaign.converted / campaign.clicked) * 100).toFixed(1) : '0',\n    };\n  };\n\n  // Get active alerts for campaign\n  const getCampaignAlerts = (campaignId: string) => {\n    return alerts.filter((a) => a.campaignId === campaignId && !a.resolved);\n  };\n\n  // Toggle alert expansion\n  const toggleAlert = (alertId: string) => {\n    const newExpanded = new Set(expandedAlerts);\n    if (newExpanded.has(alertId)) {\n      newExpanded.delete(alertId);\n    } else {\n      newExpanded.add(alertId);\n    }\n    setExpandedAlerts(newExpanded);\n  };\n\n  const selectedCampaignData = campaigns.find((c) => c.campaignId === selectedCampaign);\n  const activeCampaigns = campaigns.filter((c) => c.status === 'running');\n  const metrics = selectedCampaignData ? getEngagementMetrics(selectedCampaignData) : null;\n  const campaignAlerts = selectedCampaignData ? getCampaignAlerts(selectedCampaignData.campaignId) : [];\n\n  return (\n    <div className=\"w-full space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold\">Campaign Monitor</h2>\n          <p className=\"text-sm text-gray-600 mt-1\">\n            {activeCampaigns.length} active campaign{activeCampaigns.length !== 1 ? 's' : ''}\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <label className=\"flex items-center gap-2 cursor-pointer\">\n            <input\n              type=\"checkbox\"\n              checked={autoRefresh}\n              onChange={(e) => setAutoRefresh(e.target.checked)}\n              className=\"rounded\"\n            />\n            <span className=\"text-sm\">Auto-refresh</span>\n          </label>\n        </div>\n      </div>\n\n      {/* Campaign List */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Campaign Selector */}\n        <div className=\"lg:col-span-1\">\n          <div className=\"space-y-2\">\n            <h3 className=\"font-semibold text-sm\">Campaigns</h3>\n            <div className=\"space-y-2 max-h-96 overflow-y-auto\">\n              {campaigns.length === 0 ? (\n                <Card className=\"p-4 text-center text-gray-500\">\n                  <p>No campaigns</p>\n                </Card>\n              ) : (\n                campaigns.map((campaign) => (\n                  <button\n                    key={campaign.campaignId}\n                    onClick={() => setSelectedCampaign(campaign.campaignId)}\n                    className={`w-full text-left p-3 rounded-lg border-2 transition-colors ${\n                      selectedCampaign === campaign.campaignId\n                        ? 'border-blue-500 bg-blue-50'\n                        : 'border-gray-200 hover:border-gray-300'\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1\">\n                        <p className=\"font-medium text-sm truncate\">{campaign.campaignName}</p>\n                        <div className=\"flex items-center gap-2 mt-1\">\n                          <Badge className={`text-xs ${getStatusColor(campaign.status)}`}>\n                            {getStatusIcon(campaign.status)}\n                            <span className=\"ml-1\">{campaign.status}</span>\n                          </Badge>\n                        </div>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"text-xs font-semibold text-blue-600\">{campaign.progress.toFixed(0)}%</p>\n                      </div>\n                    </div>\n                    <Progress value={campaign.progress} className=\"mt-2 h-1\" />\n                  </button>\n                ))\n              )}\n            </div>\n          </div>\n        </div>\n\n        {/* Campaign Details */}\n        <div className=\"lg:col-span-2 space-y-4\">\n          {selectedCampaignData ? (\n            <>\n              {/* Main Stats */}\n              <Card className=\"p-6\">\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <h3 className=\"font-semibold\">{selectedCampaignData.campaignName}</h3>\n                    <Badge className={`${getStatusColor(selectedCampaignData.status)}`}>\n                      {getStatusIcon(selectedCampaignData.status)}\n                      <span className=\"ml-1\">{selectedCampaignData.status}</span>\n                    </Badge>\n                  </div>\n\n                  {/* Progress Bar */}\n                  <div>\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <span className=\"text-sm font-medium\">Progress</span>\n                      <span className=\"text-sm font-semibold\">{selectedCampaignData.progress.toFixed(1)}%</span>\n                    </div>\n                    <Progress value={selectedCampaignData.progress} className=\"h-2\" />\n                  </div>\n\n                  {/* Time Info */}\n                  {selectedCampaignData.status === 'running' && (\n                    <div className=\"flex items-center justify-between text-sm\">\n                      <span className=\"text-gray-600\">Estimated completion:</span>\n                      <span className=\"font-medium\">{getTimeRemaining(selectedCampaignData)}</span>\n                    </div>\n                  )}\n\n                  {/* Recipient Stats Grid */}\n                  <div className=\"grid grid-cols-2 gap-4 pt-4 border-t\">\n                    <div className=\"text-center\">\n                      <Users className=\"h-5 w-5 mx-auto mb-2 text-blue-600\" />\n                      <p className=\"text-2xl font-bold\">{selectedCampaignData.totalRecipients.toLocaleString()}</p>\n                      <p className=\"text-xs text-gray-600\">Total Recipients</p>\n                    </div>\n                    <div className=\"text-center\">\n                      <Send className=\"h-5 w-5 mx-auto mb-2 text-green-600\" />\n                      <p className=\"text-2xl font-bold\">{selectedCampaignData.sent.toLocaleString()}</p>\n                      <p className=\"text-xs text-gray-600\">Sent</p>\n                    </div>\n                    <div className=\"text-center\">\n                      <CheckCircle className=\"h-5 w-5 mx-auto mb-2 text-purple-600\" />\n                      <p className=\"text-2xl font-bold\">{selectedCampaignData.delivered.toLocaleString()}</p>\n                      <p className=\"text-xs text-gray-600\">Delivered</p>\n                    </div>\n                    <div className=\"text-center\">\n                      <AlertCircle className=\"h-5 w-5 mx-auto mb-2 text-red-600\" />\n                      <p className=\"text-2xl font-bold\">{selectedCampaignData.failed.toLocaleString()}</p>\n                      <p className=\"text-xs text-gray-600\">Failed</p>\n                    </div>\n                  </div>\n                </div>\n              </Card>\n\n              {/* Engagement Metrics */}\n              <Card className=\"p-6\">\n                <h4 className=\"font-semibold mb-4 flex items-center gap-2\">\n                  <TrendingUp className=\"h-5 w-5\" />\n                  Engagement Metrics\n                </h4>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <p className=\"text-sm text-gray-600\">Delivery Rate</p>\n                    <p className=\"text-2xl font-bold text-blue-600\">{metrics?.deliveryRate}%</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-gray-600\">Open Rate</p>\n                    <p className=\"text-2xl font-bold text-purple-600\">{metrics?.openRate}%</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-gray-600\">Click Rate</p>\n                    <p className=\"text-2xl font-bold text-orange-600\">{metrics?.clickRate}%</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-gray-600\">Conversion Rate</p>\n                    <p className=\"text-2xl font-bold text-green-600\">{metrics?.conversionRate}%</p>\n                  </div>\n                </div>\n              </Card>\n\n              {/* Action Buttons */}\n              {selectedCampaignData.status === 'running' && (\n                <div className=\"flex gap-2\">\n                  <Button\n                    onClick={() => onPauseCampaign?.(selectedCampaignData.campaignId)}\n                    variant=\"outline\"\n                    className=\"flex-1\"\n                  >\n                    Pause\n                  </Button>\n                  <Button\n                    onClick={() => onCancelCampaign?.(selectedCampaignData.campaignId)}\n                    variant=\"outline\"\n                    className=\"flex-1 text-red-600 hover:text-red-700\"\n                  >\n                    Cancel\n                  </Button>\n                </div>\n              )}\n\n              {selectedCampaignData.status === 'paused' && (\n                <Button\n                  onClick={() => onResumeCampaign?.(selectedCampaignData.campaignId)}\n                  className=\"w-full\"\n                >\n                  Resume\n                </Button>\n              )}\n            </>\n          ) : (\n            <Card className=\"p-8 text-center text-gray-500\">\n              <p>Select a campaign to view details</p>\n            </Card>\n          )}\n        </div>\n      </div>\n\n      {/* Alerts Section */}\n      {campaignAlerts.length > 0 && (\n        <Card className=\"p-6 border-yellow-200 bg-yellow-50\">\n          <h4 className=\"font-semibold mb-4 flex items-center gap-2 text-yellow-900\">\n            <AlertCircle className=\"h-5 w-5\" />\n            Alerts ({campaignAlerts.length})\n          </h4>\n          <div className=\"space-y-2\">\n            {campaignAlerts.map((alert) => (\n              <div\n                key={alert.id}\n                className=\"p-3 bg-white rounded border border-yellow-200 cursor-pointer hover:bg-yellow-50\"\n                onClick={() => toggleAlert(alert.id)}\n              >\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium text-sm\">\n                      {alert.type === 'error' && '❌'} {alert.type === 'warning' && '⚠️'} {alert.type === 'info' && 'ℹ️'}\n                      {alert.message}\n                    </p>\n                    {expandedAlerts.has(alert.id) && (\n                      <p className=\"text-xs text-gray-600 mt-2\">\n                        {new Date(alert.timestamp).toLocaleString()}\n                      </p>\n                    )}\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </Card>\n      )}\n    </div>\n  );\n};\n\nexport default RealtimeCampaignMonitor;\n
