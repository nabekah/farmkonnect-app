import { EventEmitter } from 'events';\n\nexport type CropFamily = 'brassica' | 'legume' | 'nightshade' | 'cucurbit' | 'allium' | 'apiaceae' | 'amaranth' | 'grass';\nexport type SoilType = 'sandy' | 'loamy' | 'clay' | 'peaty' | 'chalky';\n\nexport interface Crop {\n  id: string;\n  name: string;\n  family: CropFamily;\n  growthDays: number;\n  soilPreference: SoilType[];\n  nitrogenDemand: 'low' | 'medium' | 'high';\n  pests: string[];\n  diseases: string[];\n  companionCrops: string[];\n  incompatibleCrops: string[];\n}\n\nexport interface RotationPlan {\n  id: string;\n  farmId: string;\n  fieldId: string;\n  year: number;\n  crops: Array<{\n    season: 'spring' | 'summer' | 'fall' | 'winter';\n    cropId: string;\n    cropName: string;\n    startDate: number;\n    endDate: number;\n    expectedYield: number;\n  }>;\n  soilHealth: {\n    nitrogen: number;\n    phosphorus: number;\n    potassium: number;\n    pH: number;\n  };\n  notes: string;\n  createdAt: number;\n  updatedAt: number;\n}\n\nexport interface RotationRecommendation {\n  id: string;\n  fieldId: string;\n  currentCrop: string;\n  recommendedCrops: Array<{\n    cropId: string;\n    cropName: string;\n    score: number; // 0-100\n    reason: string;\n    benefits: string[];\n  }>;\n  pestRisk: string[];\n  soilImpact: string;\n  generatedAt: number;\n}\n\nexport interface CropHistory {\n  id: string;\n  fieldId: string;\n  cropId: string;\n  year: number;\n  yield: number;\n  healthScore: number;\n  pestIssues: string[];\n  diseaseIssues: string[];\n  notes: string;\n}\n\n/**\n * Crop Rotation Planning Manager\n */\nexport class CropRotationManager extends EventEmitter {\n  private crops: Map<string, Crop> = new Map();\n  private rotationPlans: Map<string, RotationPlan> = new Map();\n  private recommendations: Map<string, RotationRecommendation> = new Map();\n  private cropHistory: Map<string, CropHistory> = new Map();\n\n  constructor() {\n    super();\n    this.initializeCrops();\n  }\n\n  /**\n   * Initialize default crops\n   */\n  private initializeCrops(): void {\n    const crops: Crop[] = [\n      {\n        id: 'crop-wheat',\n        name: 'Wheat',\n        family: 'grass',\n        growthDays: 150,\n        soilPreference: ['loamy', 'clay'],\n        nitrogenDemand: 'medium',\n        pests: ['armyworm', 'hessian fly'],\n        diseases: ['powdery mildew', 'rust'],\n        companionCrops: ['legume', 'allium'],\n        incompatibleCrops: ['corn', 'barley'],\n      },\n      {\n        id: 'crop-corn',\n        name: 'Corn',\n        family: 'grass',\n        growthDays: 120,\n        soilPreference: ['loamy'],\n        nitrogenDemand: 'high',\n        pests: ['corn borer', 'armyworm'],\n        diseases: ['corn smut', 'leaf blight'],\n        companionCrops: ['legume', 'cucurbit'],\n        incompatibleCrops: ['wheat', 'barley'],\n      },\n      {\n        id: 'crop-soybean',\n        name: 'Soybean',\n        family: 'legume',\n        growthDays: 140,\n        soilPreference: ['loamy', 'sandy'],\n        nitrogenDemand: 'low',\n        pests: ['japanese beetle', 'spider mite'],\n        diseases: ['root rot', 'stem canker'],\n        companionCrops: ['grass', 'brassica'],\n        incompatibleCrops: ['alfalfa'],\n      },\n      {\n        id: 'crop-tomato',\n        name: 'Tomato',\n        family: 'nightshade',\n        growthDays: 85,\n        soilPreference: ['loamy'],\n        nitrogenDemand: 'medium',\n        pests: ['hornworm', 'whitefly'],\n        diseases: ['early blight', 'late blight'],\n        companionCrops: ['basil', 'carrot'],\n        incompatibleCrops: ['potato', 'pepper'],\n      },\n      {\n        id: 'crop-potato',\n        name: 'Potato',\n        family: 'nightshade',\n        growthDays: 90,\n        soilPreference: ['sandy', 'loamy'],\n        nitrogenDemand: 'medium',\n        pests: ['colorado beetle', 'aphid'],\n        diseases: ['late blight', 'early blight'],\n        companionCrops: ['legume', 'allium'],\n        incompatibleCrops: ['tomato', 'pepper'],\n      },\n      {\n        id: 'crop-carrot',\n        name: 'Carrot',\n        family: 'apiaceae',\n        growthDays: 80,\n        soilPreference: ['sandy', 'loamy'],\n        nitrogenDemand: 'low',\n        pests: ['carrot rust fly', 'wireworm'],\n        diseases: ['leaf blight', 'root rot'],\n        companionCrops: ['tomato', 'onion'],\n        incompatibleCrops: ['dill', 'parsnip'],\n      },\n      {\n        id: 'crop-lettuce',\n        name: 'Lettuce',\n        family: 'amaranth',\n        growthDays: 60,\n        soilPreference: ['loamy'],\n        nitrogenDemand: 'medium',\n        pests: ['aphid', 'slug'],\n        diseases: ['downy mildew', 'bottom rot'],\n        companionCrops: ['carrot', 'radish'],\n        incompatibleCrops: ['cabbage'],\n      },\n      {\n        id: 'crop-cabbage',\n        name: 'Cabbage',\n        family: 'brassica',\n        growthDays: 100,\n        soilPreference: ['loamy', 'clay'],\n        nitrogenDemand: 'high',\n        pests: ['cabbage worm', 'flea beetle'],\n        diseases: ['clubroot', 'black rot'],\n        companionCrops: ['potato', 'onion'],\n        incompatibleCrops: ['tomato', 'strawberry'],\n      },\n    ];\n\n    for (const crop of crops) {\n      this.crops.set(crop.id, crop);\n    }\n  }\n\n  /**\n   * Get crop by ID\n   */\n  getCrop(cropId: string): Crop | null {\n    return this.crops.get(cropId) || null;\n  }\n\n  /**\n   * Get all crops\n   */\n  getAllCrops(): Crop[] {\n    return Array.from(this.crops.values());\n  }\n\n  /**\n   * Get crops by family\n   */\n  getCropsByFamily(family: CropFamily): Crop[] {\n    return Array.from(this.crops.values()).filter((c) => c.family === family);\n  }\n\n  /**\n   * Create rotation plan\n   */\n  createRotationPlan(\n    farmId: string,\n    fieldId: string,\n    year: number,\n    soilHealth: RotationPlan['soilHealth']\n  ): RotationPlan {\n    const planId = `plan_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const plan: RotationPlan = {\n      id: planId,\n      farmId,\n      fieldId,\n      year,\n      crops: [],\n      soilHealth,\n      notes: '',\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n\n    this.rotationPlans.set(planId, plan);\n    this.emit('plan:created', { planId, farmId, fieldId, year });\n    return plan;\n  }\n\n  /**\n   * Add crop to rotation plan\n   */\n  addCropToRotationPlan(\n    planId: string,\n    season: 'spring' | 'summer' | 'fall' | 'winter',\n    cropId: string,\n    startDate: number,\n    endDate: number,\n    expectedYield: number\n  ): RotationPlan | null {\n    const plan = this.rotationPlans.get(planId);\n    if (!plan) return null;\n\n    const crop = this.getCrop(cropId);\n    if (!crop) return null;\n\n    plan.crops.push({\n      season,\n      cropId,\n      cropName: crop.name,\n      startDate,\n      endDate,\n      expectedYield,\n    });\n\n    plan.updatedAt = Date.now();\n    this.emit('crop:added', { planId, cropId, season });\n    return plan;\n  }\n\n  /**\n   * Get rotation plan\n   */\n  getRotationPlan(planId: string): RotationPlan | null {\n    return this.rotationPlans.get(planId) || null;\n  }\n\n  /**\n   * Get rotation plans by field\n   */\n  getRotationPlansByField(fieldId: string): RotationPlan[] {\n    return Array.from(this.rotationPlans.values()).filter((p) => p.fieldId === fieldId);\n  }\n\n  /**\n   * Generate rotation recommendations\n   */\n  generateRotationRecommendations(fieldId: string, currentCropId: string): RotationRecommendation {\n    const recId = `rec_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const currentCrop = this.getCrop(currentCropId);\n    if (!currentCrop) throw new Error('Current crop not found');\n\n    const history = this.getCropHistory(fieldId);\n    const recommendedCrops: RotationRecommendation['recommendedCrops'] = [];\n\n    for (const crop of this.getAllCrops()) {\n      if (crop.id === currentCropId) continue;\n\n      let score = 50;\n      const benefits: string[] = [];\n      const reasons: string[] = [];\n\n      // Different family = good (avoids pest/disease buildup)\n      if (crop.family !== currentCrop.family) {\n        score += 15;\n        benefits.push('Different crop family reduces pest/disease risk');\n      }\n\n      // Legume after high-N crop = good\n      if (currentCrop.nitrogenDemand === 'high' && crop.family === 'legume') {\n        score += 20;\n        benefits.push('Legume replenishes soil nitrogen');\n      }\n\n      // Avoid incompatible crops\n      if (currentCrop.incompatibleCrops.includes(crop.name)) {\n        score -= 30;\n        reasons.push('Not compatible with previous crop');\n      }\n\n      // Check pest/disease history\n      const hasPestRisk = currentCrop.pests.some((p) => crop.pests.includes(p));\n      if (hasPestRisk) {\n        score -= 10;\n        reasons.push('Shared pest risk');\n      }\n\n      // Companion crop bonus\n      if (currentCrop.companionCrops.includes(crop.name)) {\n        score += 10;\n        benefits.push('Good companion crop');\n      }\n\n      recommendedCrops.push({\n        cropId: crop.id,\n        cropName: crop.name,\n        score: Math.max(0, Math.min(100, score)),\n        reason: reasons.length > 0 ? reasons.join('; ') : 'Good rotation choice',\n        benefits,\n      });\n    }\n\n    // Sort by score\n    recommendedCrops.sort((a, b) => b.score - a.score);\n\n    const recommendation: RotationRecommendation = {\n      id: recId,\n      fieldId,\n      currentCrop: currentCrop.name,\n      recommendedCrops: recommendedCrops.slice(0, 5), // Top 5\n      pestRisk: currentCrop.pests,\n      soilImpact: `Nitrogen demand: ${currentCrop.nitrogenDemand}`,\n      generatedAt: Date.now(),\n    };\n\n    this.recommendations.set(recId, recommendation);\n    this.emit('recommendation:generated', { recId, fieldId, currentCropId });\n    return recommendation;\n  }\n\n  /**\n   * Get recommendation\n   */\n  getRecommendation(recId: string): RotationRecommendation | null {\n    return this.recommendations.get(recId) || null;\n  }\n\n  /**\n   * Record crop history\n   */\n  recordCropHistory(\n    fieldId: string,\n    cropId: string,\n    year: number,\n    yield_: number,\n    healthScore: number,\n    pestIssues: string[] = [],\n    diseaseIssues: string[] = [],\n    notes: string = ''\n  ): CropHistory {\n    const historyId = `history_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const history: CropHistory = {\n      id: historyId,\n      fieldId,\n      cropId,\n      year,\n      yield: yield_,\n      healthScore,\n      pestIssues,\n      diseaseIssues,\n      notes,\n    };\n\n    this.cropHistory.set(historyId, history);\n    this.emit('history:recorded', { historyId, fieldId, cropId, year });\n    return history;\n  }\n\n  /**\n   * Get crop history for field\n   */\n  getCropHistory(fieldId: string): CropHistory[] {\n    return Array.from(this.cropHistory.values())\n      .filter((h) => h.fieldId === fieldId)\n      .sort((a, b) => b.year - a.year);\n  }\n\n  /**\n   * Get crop rotation statistics\n   */\n  getRotationStats(): {\n    totalCrops: number;\n    totalPlans: number;\n    totalRecommendations: number;\n    cropFamilies: Record<CropFamily, number>;\n  } {\n    const cropFamilies: Record<CropFamily, number> = {\n      brassica: 0,\n      legume: 0,\n      nightshade: 0,\n      cucurbit: 0,\n      allium: 0,\n      apiaceae: 0,\n      amaranth: 0,\n      grass: 0,\n    };\n\n    for (const crop of this.crops.values()) {\n      cropFamilies[crop.family]++;\n    }\n\n    return {\n      totalCrops: this.crops.size,\n      totalPlans: this.rotationPlans.size,\n      totalRecommendations: this.recommendations.size,\n      cropFamilies,\n    };\n  }\n}\n
