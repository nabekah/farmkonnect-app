import { EventEmitter } from 'events';\n\nexport type ApprovalStatus = 'draft' | 'submitted' | 'in_review' | 'approved' | 'rejected' | 'changes_requested';\nexport type ReviewerRole = 'admin' | 'manager' | 'compliance' | 'content';\n\nexport interface ApprovalStep {\n  id: string;\n  stepNumber: number;\n  name: string;\n  requiredRole: ReviewerRole;\n  description: string;\n  mandatory: boolean;\n}\n\nexport interface ReviewComment {\n  id: string;\n  reviewerId: string;\n  reviewerName: string;\n  comment: string;\n  type: 'suggestion' | 'issue' | 'approval';\n  timestamp: number;\n  resolved: boolean;\n}\n\nexport interface CampaignReview {\n  id: string;\n  campaignId: string;\n  stepId: string;\n  reviewerId: string;\n  reviewerName: string;\n  status: 'pending' | 'approved' | 'rejected' | 'changes_requested';\n  comments: ReviewComment[];\n  decision?: 'approved' | 'rejected' | 'changes_requested';\n  decisionReason?: string;\n  startedAt: number;\n  completedAt?: number;\n}\n\nexport interface ApprovalWorkflow {\n  id: string;\n  campaignId: string;\n  status: ApprovalStatus;\n  steps: ApprovalStep[];\n  currentStepIndex: number;\n  reviews: CampaignReview[];\n  submittedBy: string;\n  submittedAt?: number;\n  completedAt?: number;\n  rejectionReason?: string;\n  version: number;\n  createdAt: number;\n  updatedAt: number;\n}\n\nexport interface ApprovalHistory {\n  workflowId: string;\n  campaignId: string;\n  action: string;\n  actor: string;\n  timestamp: number;\n  details: Record<string, any>;\n}\n\nexport interface ApprovalMetrics {\n  totalSubmissions: number;\n  approvedCount: number;\n  rejectedCount: number;\n  averageReviewTime: number; // milliseconds\n  averageStepsToApproval: number;\n  approvalRate: number; // percentage\n}\n\nclass CampaignApprovalWorkflow extends EventEmitter {\n  private workflows: Map<string, ApprovalWorkflow> = new Map();\n  private reviews: Map<string, CampaignReview> = new Map();\n  private history: ApprovalHistory[] = [];\n  private defaultSteps: ApprovalStep[] = [];\n\n  constructor() {\n    super();\n    this.initializeDefaultSteps();\n  }\n\n  /**\n   * Initialize default approval steps\n   */\n  private initializeDefaultSteps(): void {\n    this.defaultSteps = [\n      {\n        id: 'step-content',\n        stepNumber: 1,\n        name: 'Content Review',\n        requiredRole: 'content',\n        description: 'Review campaign content for quality and compliance',\n        mandatory: true,\n      },\n      {\n        id: 'step-compliance',\n        stepNumber: 2,\n        name: 'Compliance Review',\n        requiredRole: 'compliance',\n        description: 'Verify compliance with regulations and policies',\n        mandatory: true,\n      },\n      {\n        id: 'step-manager',\n        stepNumber: 3,\n        name: 'Manager Approval',\n        requiredRole: 'manager',\n        description: 'Final approval from campaign manager',\n        mandatory: true,\n      },\n      {\n        id: 'step-admin',\n        stepNumber: 4,\n        name: 'Admin Sign-off',\n        requiredRole: 'admin',\n        description: 'Final authorization from administrator',\n        mandatory: false,\n      },\n    ];\n  }\n\n  /**\n   * Create approval workflow\n   */\n  createWorkflow(\n    campaignId: string,\n    submittedBy: string,\n    customSteps?: ApprovalStep[]\n  ): ApprovalWorkflow {\n    const workflow: ApprovalWorkflow = {\n      id: `wf-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      campaignId,\n      status: 'draft',\n      steps: customSteps || this.defaultSteps,\n      currentStepIndex: 0,\n      reviews: [],\n      submittedBy,\n      version: 1,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n\n    this.workflows.set(workflow.id, workflow);\n    this.emit('workflow:created', workflow);\n    return workflow;\n  }\n\n  /**\n   * Get workflow\n   */\n  getWorkflow(workflowId: string): ApprovalWorkflow | undefined {\n    return this.workflows.get(workflowId);\n  }\n\n  /**\n   * Get workflow by campaign\n   */\n  getWorkflowByCampaign(campaignId: string): ApprovalWorkflow | undefined {\n    for (const [, workflow] of this.workflows) {\n      if (workflow.campaignId === campaignId) {\n        return workflow;\n      }\n    }\n    return undefined;\n  }\n\n  /**\n   * Submit for approval\n   */\n  submitForApproval(workflowId: string): boolean {\n    const workflow = this.workflows.get(workflowId);\n    if (!workflow || workflow.status !== 'draft') return false;\n\n    workflow.status = 'submitted';\n    workflow.submittedAt = Date.now();\n    workflow.currentStepIndex = 0;\n    workflow.updatedAt = Date.now();\n\n    // Create first review\n    this.createReview(workflowId, workflow.steps[0]);\n\n    this.recordHistory(workflowId, 'submitted', workflow.submittedBy, {\n      campaignId: workflow.campaignId,\n    });\n\n    this.emit('workflow:submitted', workflow);\n    return true;\n  }\n\n  /**\n   * Create review\n   */\n  private createReview(workflowId: string, step: ApprovalStep): CampaignReview {\n    const workflow = this.workflows.get(workflowId);\n    if (!workflow) throw new Error('Workflow not found');\n\n    const review: CampaignReview = {\n      id: `rev-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      campaignId: workflow.campaignId,\n      stepId: step.id,\n      reviewerId: '',\n      reviewerName: '',\n      status: 'pending',\n      comments: [],\n      startedAt: Date.now(),\n    };\n\n    this.reviews.set(review.id, review);\n    workflow.reviews.push(review);\n    workflow.status = 'in_review';\n\n    this.emit('review:created', review);\n    return review;\n  }\n\n  /**\n   * Get pending reviews\n   */\n  getPendingReviews(workflowId: string): CampaignReview[] {\n    const workflow = this.workflows.get(workflowId);\n    if (!workflow) return [];\n\n    return workflow.reviews.filter((r) => r.status === 'pending');\n  }\n\n  /**\n   * Add review comment\n   */\n  addReviewComment(\n    reviewId: string,\n    reviewerId: string,\n    reviewerName: string,\n    comment: string,\n    type: 'suggestion' | 'issue' | 'approval'\n  ): ReviewComment | null {\n    const review = this.reviews.get(reviewId);\n    if (!review) return null;\n\n    const reviewComment: ReviewComment = {\n      id: `cmt-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      reviewerId,\n      reviewerName,\n      comment,\n      type,\n      timestamp: Date.now(),\n      resolved: false,\n    };\n\n    review.comments.push(reviewComment);\n    this.emit('comment:added', reviewComment);\n    return reviewComment;\n  }\n\n  /**\n   * Resolve comment\n   */\n  resolveComment(reviewId: string, commentId: string): boolean {\n    const review = this.reviews.get(reviewId);\n    if (!review) return false;\n\n    const comment = review.comments.find((c) => c.id === commentId);\n    if (!comment) return false;\n\n    comment.resolved = true;\n    this.emit('comment:resolved', comment);\n    return true;\n  }\n\n  /**\n   * Approve review\n   */\n  approveReview(\n    reviewId: string,\n    reviewerId: string,\n    reviewerName: string,\n    reason?: string\n  ): boolean {\n    const review = this.reviews.get(reviewId);\n    if (!review) return false;\n\n    review.status = 'approved';\n    review.decision = 'approved';\n    review.decisionReason = reason;\n    review.completedAt = Date.now();\n    review.reviewerId = reviewerId;\n    review.reviewerName = reviewerName;\n\n    // Move to next step\n    const workflow = this.workflows.get(this.findWorkflowByReview(reviewId)!);\n    if (workflow) {\n      if (workflow.currentStepIndex < workflow.steps.length - 1) {\n        workflow.currentStepIndex++;\n        this.createReview(workflow.id, workflow.steps[workflow.currentStepIndex]);\n      } else {\n        // All steps approved\n        workflow.status = 'approved';\n        workflow.completedAt = Date.now();\n        this.recordHistory(workflow.id, 'approved', reviewerId, { reason });\n      }\n    }\n\n    this.emit('review:approved', review);\n    return true;\n  }\n\n  /**\n   * Reject review\n   */\n  rejectReview(\n    reviewId: string,\n    reviewerId: string,\n    reviewerName: string,\n    reason: string\n  ): boolean {\n    const review = this.reviews.get(reviewId);\n    if (!review) return false;\n\n    review.status = 'rejected';\n    review.decision = 'rejected';\n    review.decisionReason = reason;\n    review.completedAt = Date.now();\n    review.reviewerId = reviewerId;\n    review.reviewerName = reviewerName;\n\n    // Mark workflow as rejected\n    const workflowId = this.findWorkflowByReview(reviewId);\n    if (workflowId) {\n      const workflow = this.workflows.get(workflowId);\n      if (workflow) {\n        workflow.status = 'rejected';\n        workflow.rejectionReason = reason;\n        workflow.completedAt = Date.now();\n        this.recordHistory(workflowId, 'rejected', reviewerId, { reason });\n      }\n    }\n\n    this.emit('review:rejected', review);\n    return true;\n  }\n\n  /**\n   * Request changes\n   */\n  requestChanges(\n    reviewId: string,\n    reviewerId: string,\n    reviewerName: string,\n    changes: string\n  ): boolean {\n    const review = this.reviews.get(reviewId);\n    if (!review) return false;\n\n    review.status = 'changes_requested';\n    review.decision = 'changes_requested';\n    review.decisionReason = changes;\n    review.completedAt = Date.now();\n    review.reviewerId = reviewerId;\n    review.reviewerName = reviewerName;\n\n    // Mark workflow as changes requested\n    const workflowId = this.findWorkflowByReview(reviewId);\n    if (workflowId) {\n      const workflow = this.workflows.get(workflowId);\n      if (workflow) {\n        workflow.status = 'changes_requested';\n        this.recordHistory(workflowId, 'changes_requested', reviewerId, { changes });\n      }\n    }\n\n    this.emit('review:changes_requested', review);\n    return true;\n  }\n\n  /**\n   * Find workflow by review\n   */\n  private findWorkflowByReview(reviewId: string): string | undefined {\n    for (const [workflowId, workflow] of this.workflows) {\n      if (workflow.reviews.some((r) => r.id === reviewId)) {\n        return workflowId;\n      }\n    }\n    return undefined;\n  }\n\n  /**\n   * Resubmit after changes\n   */\n  resubmitAfterChanges(workflowId: string): boolean {\n    const workflow = this.workflows.get(workflowId);\n    if (!workflow || workflow.status !== 'changes_requested') return false;\n\n    workflow.version++;\n    workflow.status = 'submitted';\n    workflow.currentStepIndex = 0;\n    workflow.reviews = [];\n    workflow.updatedAt = Date.now();\n\n    // Create new review cycle\n    this.createReview(workflowId, workflow.steps[0]);\n\n    this.recordHistory(workflowId, 'resubmitted', workflow.submittedBy, {});\n    this.emit('workflow:resubmitted', workflow);\n    return true;\n  }\n\n  /**\n   * Record history\n   */\n  private recordHistory(\n    workflowId: string,\n    action: string,\n    actor: string,\n    details: Record<string, any>\n  ): void {\n    const workflow = this.workflows.get(workflowId);\n    if (!workflow) return;\n\n    const historyEntry: ApprovalHistory = {\n      workflowId,\n      campaignId: workflow.campaignId,\n      action,\n      actor,\n      timestamp: Date.now(),\n      details,\n    };\n\n    this.history.push(historyEntry);\n    this.emit('history:recorded', historyEntry);\n  }\n\n  /**\n   * Get workflow history\n   */\n  getWorkflowHistory(workflowId: string): ApprovalHistory[] {\n    return this.history.filter((h) => h.workflowId === workflowId);\n  }\n\n  /**\n   * Get campaign history\n   */\n  getCampaignHistory(campaignId: string): ApprovalHistory[] {\n    return this.history.filter((h) => h.campaignId === campaignId);\n  }\n\n  /**\n   * Get reviewer workload\n   */\n  getReviewerWorkload(reviewerId: string): CampaignReview[] {\n    return Array.from(this.reviews.values()).filter(\n      (r) => r.reviewerId === reviewerId && r.status === 'pending'\n    );\n  }\n\n  /**\n   * Get approval metrics\n   */\n  getApprovalMetrics(): ApprovalMetrics {\n    const completedWorkflows = Array.from(this.workflows.values()).filter(\n      (w) => w.status === 'approved' || w.status === 'rejected'\n    );\n\n    const approvedCount = Array.from(this.workflows.values()).filter(\n      (w) => w.status === 'approved'\n    ).length;\n    const rejectedCount = Array.from(this.workflows.values()).filter(\n      (w) => w.status === 'rejected'\n    ).length;\n\n    const reviewTimes = completedWorkflows\n      .map((w) => (w.completedAt || Date.now()) - (w.submittedAt || Date.now()))\n      .filter((t) => t > 0);\n\n    const averageReviewTime = reviewTimes.length > 0 ? reviewTimes.reduce((a, b) => a + b, 0) / reviewTimes.length : 0;\n\n    const stepCounts = completedWorkflows.map((w) => w.reviews.length);\n    const averageStepsToApproval = stepCounts.length > 0 ? stepCounts.reduce((a, b) => a + b, 0) / stepCounts.length : 0;\n\n    const totalSubmissions = completedWorkflows.length;\n    const approvalRate = totalSubmissions > 0 ? (approvedCount / totalSubmissions) * 100 : 0;\n\n    return {\n      totalSubmissions,\n      approvedCount,\n      rejectedCount,\n      averageReviewTime,\n      averageStepsToApproval,\n      approvalRate,\n    };\n  }\n\n  /**\n   * Get workflow status summary\n   */\n  getStatusSummary(): Record<ApprovalStatus, number> {\n    const summary: Record<ApprovalStatus, number> = {\n      draft: 0,\n      submitted: 0,\n      in_review: 0,\n      approved: 0,\n      rejected: 0,\n      changes_requested: 0,\n    };\n\n    for (const [, workflow] of this.workflows) {\n      summary[workflow.status]++;\n    }\n\n    return summary;\n  }\n\n  /**\n   * Cleanup\n   */\n  destroy(): void {\n    // Cleanup if needed\n  }\n}\n\nexport default CampaignApprovalWorkflow;\n
