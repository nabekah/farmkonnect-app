import { EventEmitter } from 'events';\n\nexport type Theme = 'light' | 'dark' | 'auto';\nexport type Language = 'en' | 'es' | 'fr' | 'de' | 'pt' | 'zh';\n\nexport interface NotificationPreferences {\n  email: boolean;\n  sms: boolean;\n  push: boolean;\n  inApp: boolean;\n  dailyDigest: boolean;\n  alerts: {\n    highTemperature: boolean;\n    lowSoilMoisture: boolean;\n    pestIncidents: boolean;\n    taskAssigned: boolean;\n    reportReady: boolean;\n  };\n}\n\nexport interface DashboardPreferences {\n  layout: 'grid' | 'list' | 'compact';\n  itemsPerPage: number;\n  defaultView: 'farms' | 'tasks' | 'analytics' | 'reports';\n  showCompletedTasks: boolean;\n  autoRefresh: boolean;\n  refreshInterval: number; // in seconds\n  widgets: string[];\n}\n\nexport interface PrivacyPreferences {\n  profileVisibility: 'public' | 'private' | 'team';\n  activityTracking: boolean;\n  dataCollection: boolean;\n  shareAnalytics: boolean;\n}\n\nexport interface UserPreferences {\n  userId: string;\n  theme: Theme;\n  language: Language;\n  timezone: string;\n  notifications: NotificationPreferences;\n  dashboard: DashboardPreferences;\n  privacy: PrivacyPreferences;\n  customSettings: Record<string, any>;\n  updatedAt: number;\n}\n\nexport interface PreferenceUpdate {\n  userId: string;\n  field: string;\n  oldValue: any;\n  newValue: any;\n  timestamp: number;\n}\n\n/**\n * User Preferences Manager\n */\nexport class UserPreferencesManager extends EventEmitter {\n  private preferences: Map<string, UserPreferences> = new Map();\n  private preferenceHistory: PreferenceUpdate[] = [];\n  private defaultPreferences: UserPreferences = {\n    userId: '',\n    theme: 'auto',\n    language: 'en',\n    timezone: 'UTC',\n    notifications: {\n      email: true,\n      sms: false,\n      push: true,\n      inApp: true,\n      dailyDigest: true,\n      alerts: {\n        highTemperature: true,\n        lowSoilMoisture: true,\n        pestIncidents: true,\n        taskAssigned: true,\n        reportReady: true,\n      },\n    },\n    dashboard: {\n      layout: 'grid',\n      itemsPerPage: 10,\n      defaultView: 'farms',\n      showCompletedTasks: false,\n      autoRefresh: true,\n      refreshInterval: 60,\n      widgets: ['metrics', 'recommendations', 'alerts', 'activity'],\n    },\n    privacy: {\n      profileVisibility: 'team',\n      activityTracking: true,\n      dataCollection: true,\n      shareAnalytics: false,\n    },\n    customSettings: {},\n    updatedAt: Date.now(),\n  };\n\n  constructor() {\n    super();\n  }\n\n  /**\n   * Get or create user preferences\n   */\n  getUserPreferences(userId: string): UserPreferences {\n    if (!this.preferences.has(userId)) {\n      const prefs = { ...this.defaultPreferences, userId, updatedAt: Date.now() };\n      this.preferences.set(userId, prefs);\n      this.emit('preferences:created', { userId });\n    }\n    return this.preferences.get(userId)!;\n  }\n\n  /**\n   * Update preference\n   */\n  updatePreference(userId: string, field: string, value: any): boolean {\n    const prefs = this.getUserPreferences(userId);\n    const oldValue = this.getNestedValue(prefs, field);\n\n    if (oldValue === value) return false;\n\n    this.setNestedValue(prefs, field, value);\n    prefs.updatedAt = Date.now();\n\n    const update: PreferenceUpdate = {\n      userId,\n      field,\n      oldValue,\n      newValue: value,\n      timestamp: Date.now(),\n    };\n\n    this.preferenceHistory.push(update);\n    this.emit('preference:updated', update);\n    return true;\n  }\n\n  /**\n   * Update multiple preferences\n   */\n  updatePreferences(userId: string, updates: Record<string, any>): number {\n    let count = 0;\n    for (const [field, value] of Object.entries(updates)) {\n      if (this.updatePreference(userId, field, value)) {\n        count++;\n      }\n    }\n    return count;\n  }\n\n  /**\n   * Set theme\n   */\n  setTheme(userId: string, theme: Theme): boolean {\n    return this.updatePreference(userId, 'theme', theme);\n  }\n\n  /**\n   * Set language\n   */\n  setLanguage(userId: string, language: Language): boolean {\n    return this.updatePreference(userId, 'language', language);\n  }\n\n  /**\n   * Set timezone\n   */\n  setTimezone(userId: string, timezone: string): boolean {\n    return this.updatePreference(userId, 'timezone', timezone);\n  }\n\n  /**\n   * Update notification preferences\n   */\n  updateNotificationPreferences(userId: string, notifications: Partial<NotificationPreferences>): boolean {\n    const prefs = this.getUserPreferences(userId);\n    const oldValue = prefs.notifications;\n    prefs.notifications = { ...prefs.notifications, ...notifications };\n    prefs.updatedAt = Date.now();\n\n    const update: PreferenceUpdate = {\n      userId,\n      field: 'notifications',\n      oldValue,\n      newValue: prefs.notifications,\n      timestamp: Date.now(),\n    };\n\n    this.preferenceHistory.push(update);\n    this.emit('preference:updated', update);\n    return true;\n  }\n\n  /**\n   * Update dashboard preferences\n   */\n  updateDashboardPreferences(userId: string, dashboard: Partial<DashboardPreferences>): boolean {\n    const prefs = this.getUserPreferences(userId);\n    const oldValue = prefs.dashboard;\n    prefs.dashboard = { ...prefs.dashboard, ...dashboard };\n    prefs.updatedAt = Date.now();\n\n    const update: PreferenceUpdate = {\n      userId,\n      field: 'dashboard',\n      oldValue,\n      newValue: prefs.dashboard,\n      timestamp: Date.now(),\n    };\n\n    this.preferenceHistory.push(update);\n    this.emit('preference:updated', update);\n    return true;\n  }\n\n  /**\n   * Update privacy preferences\n   */\n  updatePrivacyPreferences(userId: string, privacy: Partial<PrivacyPreferences>): boolean {\n    const prefs = this.getUserPreferences(userId);\n    const oldValue = prefs.privacy;\n    prefs.privacy = { ...prefs.privacy, ...privacy };\n    prefs.updatedAt = Date.now();\n\n    const update: PreferenceUpdate = {\n      userId,\n      field: 'privacy',\n      oldValue,\n      newValue: prefs.privacy,\n      timestamp: Date.now(),\n    };\n\n    this.preferenceHistory.push(update);\n    this.emit('preference:updated', update);\n    return true;\n  }\n\n  /**\n   * Reset to defaults\n   */\n  resetToDefaults(userId: string): boolean {\n    const newPrefs = { ...this.defaultPreferences, userId, updatedAt: Date.now() };\n    this.preferences.set(userId, newPrefs);\n    this.emit('preferences:reset', { userId });\n    return true;\n  }\n\n  /**\n   * Get preference history\n   */\n  getPreferenceHistory(userId?: string, limit: number = 50): PreferenceUpdate[] {\n    let history = this.preferenceHistory;\n    if (userId) {\n      history = history.filter((h) => h.userId === userId);\n    }\n    return history.slice(-limit);\n  }\n\n  /**\n   * Get nested value\n   */\n  private getNestedValue(obj: any, path: string): any {\n    const keys = path.split('.');\n    let value = obj;\n    for (const key of keys) {\n      value = value?.[key];\n    }\n    return value;\n  }\n\n  /**\n   * Set nested value\n   */\n  private setNestedValue(obj: any, path: string, value: any): void {\n    const keys = path.split('.');\n    let current = obj;\n    for (let i = 0; i < keys.length - 1; i++) {\n      const key = keys[i];\n      if (!current[key]) {\n        current[key] = {};\n      }\n      current = current[key];\n    }\n    current[keys[keys.length - 1]] = value;\n  }\n\n  /**\n   * Get preferences summary\n   */\n  getPreferencesSummary(userId: string): {\n    theme: Theme;\n    language: Language;\n    timezone: string;\n    notificationsEnabled: number;\n    dashboardWidgets: number;\n    privacyLevel: string;\n  } {\n    const prefs = this.getUserPreferences(userId);\n    const enabledNotifications = Object.values(prefs.notifications.alerts).filter(Boolean).length;\n\n    return {\n      theme: prefs.theme,\n      language: prefs.language,\n      timezone: prefs.timezone,\n      notificationsEnabled: enabledNotifications,\n      dashboardWidgets: prefs.dashboard.widgets.length,\n      privacyLevel: prefs.privacy.profileVisibility,\n    };\n  }\n\n  /**\n   * Export preferences\n   */\n  exportPreferences(userId: string): string {\n    const prefs = this.getUserPreferences(userId);\n    return JSON.stringify(prefs, null, 2);\n  }\n\n  /**\n   * Import preferences\n   */\n  importPreferences(userId: string, preferencesJson: string): boolean {\n    try {\n      const imported = JSON.parse(preferencesJson);\n      const prefs = this.getUserPreferences(userId);\n\n      Object.assign(prefs, imported, { userId, updatedAt: Date.now() });\n      this.emit('preferences:imported', { userId });\n      return true;\n    } catch (error) {\n      return false;\n    }\n  }\n}\n
