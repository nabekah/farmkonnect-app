import { describe, it, expect, beforeEach } from 'vitest';\nimport { FinancialReportsGenerator, ReportType, ReportFormat } from './financial-reports';\n\n/**\n * Financial Reports Generator Tests\n */\ndescribe('Financial Reports Generator', () => {\n  let generator: FinancialReportsGenerator;\n\n  beforeEach(() => {\n    generator = new FinancialReportsGenerator();\n  });\n\n  it('should generate a summary report', () => {\n    const report = generator.generateReport(\n      'farm-1',\n      'summary',\n      'pdf',\n      Date.now() - 30 * 24 * 60 * 60 * 1000,\n      Date.now()\n    );\n\n    expect(report).not.toBeNull();\n    expect(report.type).toBe('summary');\n    expect(report.format).toBe('pdf');\n    expect(report.status).toBe('completed');\n    expect(report.data.revenue).toBeGreaterThan(0);\n  });\n\n  it('should generate a detailed report', () => {\n    const report = generator.generateReport(\n      'farm-1',\n      'detailed',\n      'excel',\n      Date.now() - 30 * 24 * 60 * 60 * 1000,\n      Date.now()\n    );\n\n    expect(report.type).toBe('detailed');\n    expect(report.format).toBe('excel');\n    expect(report.data.topExpenses.length).toBeGreaterThan(0);\n  });\n\n  it('should generate a forecast report', () => {\n    const report = generator.generateReport(\n      'farm-1',\n      'forecast',\n      'json',\n      Date.now(),\n      Date.now() + 90 * 24 * 60 * 60 * 1000\n    );\n\n    expect(report.type).toBe('forecast');\n    expect(report.data.trends.length).toBeGreaterThan(0);\n  });\n\n  it('should export report as CSV', () => {\n    const report = generator.generateReport(\n      'farm-1',\n      'summary',\n      'csv',\n      Date.now() - 30 * 24 * 60 * 60 * 1000,\n      Date.now()\n    );\n\n    const csv = generator.exportReport(report.id, 'csv');\n\n    expect(typeof csv).toBe('string');\n    expect(csv).toContain('Financial Report');\n    expect(csv).toContain('Revenue');\n  });\n\n  it('should export report as JSON', () => {\n    const report = generator.generateReport(\n      'farm-1',\n      'summary',\n      'json',\n      Date.now() - 30 * 24 * 60 * 60 * 1000,\n      Date.now()\n    );\n\n    const json = generator.exportReport(report.id, 'json');\n\n    expect(typeof json).toBe('string');\n    const parsed = JSON.parse(json);\n    expect(parsed.id).toBe(report.id);\n  });\n\n  it('should create a report schedule', () => {\n    const schedule = generator.createSchedule(\n      'farm-1',\n      'summary',\n      'pdf',\n      'monthly',\n      ['user@example.com', 'admin@example.com']\n    );\n\n    expect(schedule).not.toBeNull();\n    expect(schedule.frequency).toBe('monthly');\n    expect(schedule.recipients.length).toBe(2);\n    expect(schedule.enabled).toBe(true);\n  });\n\n  it('should update a schedule', () => {\n    const schedule = generator.createSchedule(\n      'farm-1',\n      'summary',\n      'pdf',\n      'monthly',\n      ['user@example.com']\n    );\n\n    const updated = generator.updateSchedule(schedule.id, {\n      frequency: 'weekly',\n      recipients: ['user@example.com', 'new@example.com'],\n    });\n\n    expect(updated.frequency).toBe('weekly');\n    expect(updated.recipients.length).toBe(2);\n  });\n\n  it('should delete a schedule', () => {\n    const schedule = generator.createSchedule(\n      'farm-1',\n      'summary',\n      'pdf',\n      'monthly',\n      ['user@example.com']\n    );\n\n    const deleted = generator.deleteSchedule(schedule.id);\n\n    expect(deleted).toBe(true);\n    expect(generator.getFarmSchedules('farm-1').length).toBe(0);\n  });\n\n  it('should get farm schedules', () => {\n    generator.createSchedule('farm-1', 'summary', 'pdf', 'monthly', ['user@example.com']);\n    generator.createSchedule('farm-1', 'detailed', 'excel', 'weekly', ['user@example.com']);\n    generator.createSchedule('farm-2', 'summary', 'pdf', 'monthly', ['user@example.com']);\n\n    const farm1Schedules = generator.getFarmSchedules('farm-1');\n    const farm2Schedules = generator.getFarmSchedules('farm-2');\n\n    expect(farm1Schedules.length).toBe(2);\n    expect(farm2Schedules.length).toBe(1);\n  });\n\n  it('should get report by ID', () => {\n    const report = generator.generateReport(\n      'farm-1',\n      'summary',\n      'pdf',\n      Date.now() - 30 * 24 * 60 * 60 * 1000,\n      Date.now()\n    );\n\n    const retrieved = generator.getReport(report.id);\n\n    expect(retrieved).not.toBeNull();\n    expect(retrieved?.id).toBe(report.id);\n  });\n\n  it('should get farm reports', () => {\n    generator.generateReport('farm-1', 'summary', 'pdf', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now());\n    generator.generateReport('farm-1', 'detailed', 'excel', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now());\n    generator.generateReport('farm-2', 'summary', 'pdf', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now());\n\n    const farm1Reports = generator.getFarmReports('farm-1');\n    const farm2Reports = generator.getFarmReports('farm-2');\n\n    expect(farm1Reports.length).toBe(2);\n    expect(farm2Reports.length).toBe(1);\n  });\n\n  it('should get all templates', () => {\n    const templates = generator.getAllTemplates();\n\n    expect(templates.length).toBeGreaterThan(0);\n    expect(templates.some((t) => t.type === 'summary')).toBe(true);\n    expect(templates.some((t) => t.type === 'detailed')).toBe(true);\n  });\n\n  it('should create custom template', () => {\n    const template = generator.createTemplate(\n      'Custom Report',\n      'summary',\n      ['overview', 'custom_section'],\n      true,\n      false\n    );\n\n    expect(template).not.toBeNull();\n    expect(template.name).toBe('Custom Report');\n    expect(template.sections).toContain('custom_section');\n  });\n\n  it('should send report to recipients', () => {\n    const report = generator.generateReport(\n      'farm-1',\n      'summary',\n      'pdf',\n      Date.now() - 30 * 24 * 60 * 60 * 1000,\n      Date.now()\n    );\n\n    const result = generator.sendReport(report.id, ['user1@example.com', 'user2@example.com']);\n\n    expect(result.sent).toBe(2);\n    expect(result.failed).toBe(0);\n  });\n\n  it('should get statistics', () => {\n    generator.generateReport('farm-1', 'summary', 'pdf', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now());\n    generator.generateReport('farm-1', 'detailed', 'excel', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now());\n    generator.createSchedule('farm-1', 'summary', 'pdf', 'monthly', ['user@example.com']);\n\n    const stats = generator.getStatistics();\n\n    expect(stats.totalReports).toBe(2);\n    expect(stats.totalSchedules).toBe(1);\n    expect(stats.totalTemplates).toBeGreaterThan(0);\n    expect(stats.activeSchedules).toBe(1);\n  });\n\n  it('should emit report:generated event', (done) => {\n    generator.on('report:generated', (report) => {\n      expect(report.type).toBe('summary');\n      done();\n    });\n\n    generator.generateReport(\n      'farm-1',\n      'summary',\n      'pdf',\n      Date.now() - 30 * 24 * 60 * 60 * 1000,\n      Date.now()\n    );\n  });\n\n  it('should emit schedule:created event', (done) => {\n    generator.on('schedule:created', (schedule) => {\n      expect(schedule.frequency).toBe('monthly');\n      done();\n    });\n\n    generator.createSchedule('farm-1', 'summary', 'pdf', 'monthly', ['user@example.com']);\n  });\n\n  it('should emit schedule:updated event', (done) => {\n    const schedule = generator.createSchedule('farm-1', 'summary', 'pdf', 'monthly', ['user@example.com']);\n\n    generator.on('schedule:updated', (updated) => {\n      expect(updated.frequency).toBe('weekly');\n      done();\n    });\n\n    generator.updateSchedule(schedule.id, { frequency: 'weekly' });\n  });\n\n  it('should emit schedule:deleted event', (done) => {\n    const schedule = generator.createSchedule('farm-1', 'summary', 'pdf', 'monthly', ['user@example.com']);\n\n    generator.on('schedule:deleted', (scheduleId) => {\n      expect(scheduleId).toBe(schedule.id);\n      done();\n    });\n\n    generator.deleteSchedule(schedule.id);\n  });\n\n  it('should calculate correct profit margin', () => {\n    const report = generator.generateReport(\n      'farm-1',\n      'summary',\n      'json',\n      Date.now() - 30 * 24 * 60 * 60 * 1000,\n      Date.now()\n    );\n\n    const expectedMargin = (report.data.profit / report.data.revenue) * 100;\n    expect(report.data.profitMargin).toBeCloseTo(expectedMargin, 1);\n  });\n\n  it('should handle multiple reports for same farm', () => {\n    const reports = [\n      generator.generateReport('farm-1', 'summary', 'pdf', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now()),\n      generator.generateReport('farm-1', 'detailed', 'excel', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now()),\n      generator.generateReport('farm-1', 'forecast', 'json', Date.now(), Date.now() + 90 * 24 * 60 * 60 * 1000),\n    ];\n\n    const farmReports = generator.getFarmReports('farm-1');\n\n    expect(farmReports.length).toBe(3);\n    expect(farmReports.map((r) => r.type)).toContain('summary');\n    expect(farmReports.map((r) => r.type)).toContain('detailed');\n    expect(farmReports.map((r) => r.type)).toContain('forecast');\n  });\n\n  it('should handle report export errors', () => {\n    expect(() => {\n      generator.exportReport('nonexistent-report', 'pdf');\n    }).toThrow();\n  });\n\n  it('should handle schedule update errors', () => {\n    expect(() => {\n      generator.updateSchedule('nonexistent-schedule', { frequency: 'weekly' });\n    }).toThrow();\n  });\n\n  it('should track report statistics by type', () => {\n    generator.generateReport('farm-1', 'summary', 'pdf', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now());\n    generator.generateReport('farm-1', 'summary', 'pdf', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now());\n    generator.generateReport('farm-1', 'detailed', 'excel', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now());\n\n    const stats = generator.getStatistics();\n\n    expect(stats.reportsByType.summary).toBe(2);\n    expect(stats.reportsByType.detailed).toBe(1);\n  });\n\n  it('should track report statistics by format', () => {\n    generator.generateReport('farm-1', 'summary', 'pdf', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now());\n    generator.generateReport('farm-1', 'summary', 'excel', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now());\n    generator.generateReport('farm-1', 'detailed', 'excel', Date.now() - 30 * 24 * 60 * 60 * 1000, Date.now());\n\n    const stats = generator.getStatistics();\n\n    expect(stats.reportsByFormat.pdf).toBe(1);\n    expect(stats.reportsByFormat.excel).toBe(2);\n  });\n});\n
