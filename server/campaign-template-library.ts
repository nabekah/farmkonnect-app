import { EventEmitter } from 'events';\n\nexport type TemplateCategory = 'welcome' | 're-engagement' | 'seasonal' | 'promotional' | 'transactional' | 'educational' | 'custom';\nexport type TemplateStatus = 'draft' | 'published' | 'archived';\n\nexport interface TemplateBlock {\n  id: string;\n  type: 'text' | 'image' | 'button' | 'divider' | 'spacer' | 'section';\n  content: string;\n  styling?: {\n    fontSize?: number;\n    fontWeight?: 'normal' | 'bold';\n    color?: string;\n    alignment?: 'left' | 'center' | 'right';\n    backgroundColor?: string;\n    padding?: number;\n  };\n  variables?: string[]; // e.g., ['firstName', 'farmName']\n}\n\nexport interface TemplateVariable {\n  name: string;\n  type: 'string' | 'number' | 'date' | 'email';\n  defaultValue?: string;\n  required: boolean;\n  description: string;\n}\n\nexport interface CampaignTemplate {\n  id: string;\n  name: string;\n  description: string;\n  category: TemplateCategory;\n  status: TemplateStatus;\n  blocks: TemplateBlock[];\n  variables: TemplateVariable[];\n  previewImage?: string;\n  performanceMetrics?: {\n    averageOpenRate: number;\n    averageClickRate: number;\n    averageConversionRate: number;\n    usageCount: number;\n  };\n  tags: string[];\n  createdBy: string;\n  createdAt: number;\n  updatedAt: number;\n  version: number;\n}\n\nexport interface TemplateVariant {\n  id: string;\n  templateId: string;\n  name: string;\n  blocks: TemplateBlock[];\n  performanceMetrics?: {\n    openRate: number;\n    clickRate: number;\n    conversionRate: number;\n  };\n  createdAt: number;\n}\n\nexport interface TemplateCustomization {\n  templateId: string;\n  customizations: {\n    blocks?: TemplateBlock[];\n    variables?: Record<string, any>;\n    styling?: Record<string, any>;\n  };\n}\n\nexport interface TemplatePerformanceBenchmark {\n  templateId: string;\n  category: TemplateCategory;\n  industry?: string;\n  openRate: number;\n  clickRate: number;\n  conversionRate: number;\n  unsubscribeRate: number;\n  bounceRate: number;\n  sampleSize: number;\n}\n\nclass CampaignTemplateLibrary extends EventEmitter {\n  private templates: Map<string, CampaignTemplate> = new Map();\n  private variants: Map<string, TemplateVariant> = new Map();\n  private benchmarks: Map<string, TemplatePerformanceBenchmark> = new Map();\n  private templateUsage: Map<string, number> = new Map();\n  private prebuiltTemplates: CampaignTemplate[] = [];\n\n  constructor() {\n    super();\n    this.initializePrebuiltTemplates();\n  }\n\n  /**\n   * Initialize prebuilt templates\n   */\n  private initializePrebuiltTemplates(): void {\n    // Welcome series template\n    const welcomeTemplate: CampaignTemplate = {\n      id: 'tpl-welcome-001',\n      name: 'Welcome Series - Day 1',\n      description: 'First email in welcome series for new subscribers',\n      category: 'welcome',\n      status: 'published',\n      blocks: [\n        {\n          id: 'blk-1',\n          type: 'text',\n          content: 'Welcome to {{farmName}}!',\n          styling: { fontSize: 32, fontWeight: 'bold', alignment: 'center' },\n          variables: ['farmName'],\n        },\n        {\n          id: 'blk-2',\n          type: 'text',\n          content: 'Hi {{firstName}}, we\\'re excited to have you on board.',\n          styling: { fontSize: 16, alignment: 'center' },\n          variables: ['firstName'],\n        },\n        {\n          id: 'blk-3',\n          type: 'button',\n          content: 'Get Started',\n          styling: { backgroundColor: '#4CAF50', color: '#FFFFFF' },\n        },\n      ],\n      variables: [\n        { name: 'firstName', type: 'string', required: true, description: 'Recipient first name' },\n        { name: 'farmName', type: 'string', required: true, description: 'Farm or organization name' },\n      ],\n      performanceMetrics: {\n        averageOpenRate: 45.2,\n        averageClickRate: 12.8,\n        averageConversionRate: 3.5,\n        usageCount: 1250,\n      },\n      tags: ['welcome', 'onboarding', 'new-subscriber'],\n      createdBy: 'system',\n      createdAt: Date.now() - 90 * 24 * 60 * 60 * 1000,\n      updatedAt: Date.now() - 90 * 24 * 60 * 60 * 1000,\n      version: 1,\n    };\n\n    // Re-engagement template\n    const reengagementTemplate: CampaignTemplate = {\n      id: 'tpl-reeng-001',\n      name: 'Re-engagement Campaign',\n      description: 'Win back inactive subscribers',\n      category: 're-engagement',\n      status: 'published',\n      blocks: [\n        {\n          id: 'blk-1',\n          type: 'text',\n          content: 'We miss you, {{firstName}}!',\n          styling: { fontSize: 28, fontWeight: 'bold' },\n          variables: ['firstName'],\n        },\n        {\n          id: 'blk-2',\n          type: 'text',\n          content: 'It\\'s been a while. Check out what\\'s new.',\n          styling: { fontSize: 14 },\n        },\n        {\n          id: 'blk-3',\n          type: 'button',\n          content: 'See What\\'s New',\n          styling: { backgroundColor: '#2196F3' },\n        },\n      ],\n      variables: [\n        { name: 'firstName', type: 'string', required: true, description: 'Recipient first name' },\n      ],\n      performanceMetrics: {\n        averageOpenRate: 28.5,\n        averageClickRate: 8.2,\n        averageConversionRate: 2.1,\n        usageCount: 850,\n      },\n      tags: ['re-engagement', 'inactive', 'winback'],\n      createdBy: 'system',\n      createdAt: Date.now() - 60 * 24 * 60 * 60 * 1000,\n      updatedAt: Date.now() - 60 * 24 * 60 * 60 * 1000,\n      version: 1,\n    };\n\n    // Seasonal template\n    const seasonalTemplate: CampaignTemplate = {\n      id: 'tpl-seasonal-001',\n      name: 'Seasonal Promotion',\n      description: 'Seasonal promotional campaign',\n      category: 'seasonal',\n      status: 'published',\n      blocks: [\n        {\n          id: 'blk-1',\n          type: 'image',\n          content: 'seasonal-banner.jpg',\n        },\n        {\n          id: 'blk-2',\n          type: 'text',\n          content: '{{seasonName}} Special Offer',\n          styling: { fontSize: 36, fontWeight: 'bold', alignment: 'center' },\n          variables: ['seasonName'],\n        },\n        {\n          id: 'blk-3',\n          type: 'text',\n          content: 'Get {{discountPercent}}% off this season',\n          styling: { fontSize: 24, color: '#FF5722' },\n          variables: ['discountPercent'],\n        },\n        {\n          id: 'blk-4',\n          type: 'button',\n          content: 'Shop Now',\n          styling: { backgroundColor: '#FF5722' },\n        },\n      ],\n      variables: [\n        { name: 'seasonName', type: 'string', required: true, description: 'Season name' },\n        { name: 'discountPercent', type: 'number', required: true, description: 'Discount percentage' },\n      ],\n      performanceMetrics: {\n        averageOpenRate: 52.3,\n        averageClickRate: 18.7,\n        averageConversionRate: 6.2,\n        usageCount: 2100,\n      },\n      tags: ['seasonal', 'promotion', 'sale'],\n      createdBy: 'system',\n      createdAt: Date.now() - 30 * 24 * 60 * 60 * 1000,\n      updatedAt: Date.now() - 30 * 24 * 60 * 60 * 1000,\n      version: 1,\n    };\n\n    this.prebuiltTemplates = [welcomeTemplate, reengagementTemplate, seasonalTemplate];\n    this.templates.set(welcomeTemplate.id, welcomeTemplate);\n    this.templates.set(reengagementTemplate.id, reengagementTemplate);\n    this.templates.set(seasonalTemplate.id, seasonalTemplate);\n  }\n\n  /**\n   * Get all prebuilt templates\n   */\n  getPrebuiltTemplates(): CampaignTemplate[] {\n    return this.prebuiltTemplates;\n  }\n\n  /**\n   * Get templates by category\n   */\n  getTemplatesByCategory(category: TemplateCategory): CampaignTemplate[] {\n    return Array.from(this.templates.values()).filter(\n      (t) => t.category === category && t.status !== 'archived'\n    );\n  }\n\n  /**\n   * Create template\n   */\n  createTemplate(\n    name: string,\n    description: string,\n    category: TemplateCategory,\n    blocks: TemplateBlock[],\n    variables: TemplateVariable[],\n    createdBy: string\n  ): CampaignTemplate {\n    const template: CampaignTemplate = {\n      id: `tpl-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      name,\n      description,\n      category,\n      status: 'draft',\n      blocks,\n      variables,\n      tags: [],\n      createdBy,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      version: 1,\n    };\n\n    this.templates.set(template.id, template);\n    this.emit('template:created', template);\n    return template;\n  }\n\n  /**\n   * Get template\n   */\n  getTemplate(templateId: string): CampaignTemplate | undefined {\n    return this.templates.get(templateId);\n  }\n\n  /**\n   * Update template\n   */\n  updateTemplate(\n    templateId: string,\n    updates: Partial<CampaignTemplate>\n  ): boolean {\n    const template = this.templates.get(templateId);\n    if (!template) return false;\n\n    // Increment version if content changed\n    if (updates.blocks || updates.variables) {\n      template.version++;\n    }\n\n    Object.assign(template, updates, { updatedAt: Date.now() });\n    this.emit('template:updated', template);\n    return true;\n  }\n\n  /**\n   * Publish template\n   */\n  publishTemplate(templateId: string): boolean {\n    const template = this.templates.get(templateId);\n    if (!template) return false;\n\n    template.status = 'published';\n    template.updatedAt = Date.now();\n    this.emit('template:published', template);\n    return true;\n  }\n\n  /**\n   * Archive template\n   */\n  archiveTemplate(templateId: string): boolean {\n    const template = this.templates.get(templateId);\n    if (!template) return false;\n\n    template.status = 'archived';\n    template.updatedAt = Date.now();\n    this.emit('template:archived', template);\n    return true;\n  }\n\n  /**\n   * Duplicate template\n   */\n  duplicateTemplate(templateId: string, newName: string, createdBy: string): CampaignTemplate | null {\n    const original = this.templates.get(templateId);\n    if (!original) return null;\n\n    const duplicate: CampaignTemplate = {\n      id: `tpl-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      name: newName,\n      description: original.description,\n      category: original.category,\n      status: 'draft',\n      blocks: JSON.parse(JSON.stringify(original.blocks)),\n      variables: JSON.parse(JSON.stringify(original.variables)),\n      tags: [...original.tags],\n      createdBy,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      version: 1,\n    };\n\n    this.templates.set(duplicate.id, duplicate);\n    this.emit('template:duplicated', { original: templateId, duplicate: duplicate.id });\n    return duplicate;\n  }\n\n  /**\n   * Create template variant\n   */\n  createVariant(\n    templateId: string,\n    name: string,\n    blocks: TemplateBlock[]\n  ): TemplateVariant | null {\n    const template = this.templates.get(templateId);\n    if (!template) return null;\n\n    const variant: TemplateVariant = {\n      id: `var-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      templateId,\n      name,\n      blocks,\n      createdAt: Date.now(),\n    };\n\n    this.variants.set(variant.id, variant);\n    this.emit('variant:created', variant);\n    return variant;\n  }\n\n  /**\n   * Get variants for template\n   */\n  getVariants(templateId: string): TemplateVariant[] {\n    return Array.from(this.variants.values()).filter((v) => v.templateId === templateId);\n  }\n\n  /**\n   * Update variant performance\n   */\n  updateVariantPerformance(\n    variantId: string,\n    openRate: number,\n    clickRate: number,\n    conversionRate: number\n  ): boolean {\n    const variant = this.variants.get(variantId);\n    if (!variant) return false;\n\n    variant.performanceMetrics = { openRate, clickRate, conversionRate };\n    this.emit('variant:performance_updated', variant);\n    return true;\n  }\n\n  /**\n   * Record template usage\n   */\n  recordTemplateUsage(templateId: string): void {\n    const count = this.templateUsage.get(templateId) || 0;\n    this.templateUsage.set(templateId, count + 1);\n\n    const template = this.templates.get(templateId);\n    if (template && template.performanceMetrics) {\n      template.performanceMetrics.usageCount = count + 1;\n    }\n  }\n\n  /**\n   * Get template usage\n   */\n  getTemplateUsage(templateId: string): number {\n    return this.templateUsage.get(templateId) || 0;\n  }\n\n  /**\n   * Search templates\n   */\n  searchTemplates(query: string): CampaignTemplate[] {\n    const lowerQuery = query.toLowerCase();\n    return Array.from(this.templates.values()).filter(\n      (t) =>\n        t.status !== 'archived' &&\n        (t.name.toLowerCase().includes(lowerQuery) ||\n          t.description.toLowerCase().includes(lowerQuery) ||\n          t.tags.some((tag) => tag.toLowerCase().includes(lowerQuery)))\n    );\n  }\n\n  /**\n   * Get templates by tag\n   */\n  getTemplatesByTag(tag: string): CampaignTemplate[] {\n    return Array.from(this.templates.values()).filter(\n      (t) => t.status !== 'archived' && t.tags.includes(tag)\n    );\n  }\n\n  /**\n   * Add tag to template\n   */\n  addTagToTemplate(templateId: string, tag: string): boolean {\n    const template = this.templates.get(templateId);\n    if (!template) return false;\n\n    if (!template.tags.includes(tag)) {\n      template.tags.push(tag);\n      template.updatedAt = Date.now();\n      this.emit('template:tag_added', { templateId, tag });\n    }\n    return true;\n  }\n\n  /**\n   * Remove tag from template\n   */\n  removeTagFromTemplate(templateId: string, tag: string): boolean {\n    const template = this.templates.get(templateId);\n    if (!template) return false;\n\n    const index = template.tags.indexOf(tag);\n    if (index > -1) {\n      template.tags.splice(index, 1);\n      template.updatedAt = Date.now();\n      this.emit('template:tag_removed', { templateId, tag });\n    }\n    return true;\n  }\n\n  /**\n   * Set performance benchmark\n   */\n  setPerformanceBenchmark(\n    templateId: string,\n    category: TemplateCategory,\n    metrics: Omit<TemplatePerformanceBenchmark, 'templateId' | 'category'>\n  ): TemplatePerformanceBenchmark {\n    const benchmark: TemplatePerformanceBenchmark = {\n      templateId,\n      category,\n      ...metrics,\n    };\n\n    this.benchmarks.set(templateId, benchmark);\n    this.emit('benchmark:set', benchmark);\n    return benchmark;\n  }\n\n  /**\n   * Get performance benchmark\n   */\n  getPerformanceBenchmark(templateId: string): TemplatePerformanceBenchmark | undefined {\n    return this.benchmarks.get(templateId);\n  }\n\n  /**\n   * Get category benchmarks\n   */\n  getCategoryBenchmarks(category: TemplateCategory): TemplatePerformanceBenchmark[] {\n    return Array.from(this.benchmarks.values()).filter((b) => b.category === category);\n  }\n\n  /**\n   * Get template recommendations\n   */\n  getRecommendations(category: TemplateCategory, limit: number = 5): CampaignTemplate[] {\n    const templates = this.getTemplatesByCategory(category).filter((t) => t.status === 'published');\n\n    return templates\n      .sort((a, b) => {\n        const aMetrics = a.performanceMetrics || { averageOpenRate: 0, usageCount: 0 };\n        const bMetrics = b.performanceMetrics || { averageOpenRate: 0, usageCount: 0 };\n\n        // Score based on open rate and usage\n        const aScore = aMetrics.averageOpenRate * 0.6 + (aMetrics.usageCount / 1000) * 0.4;\n        const bScore = bMetrics.averageOpenRate * 0.6 + (bMetrics.usageCount / 1000) * 0.4;\n\n        return bScore - aScore;\n      })\n      .slice(0, limit);\n  }\n\n  /**\n   * Get library statistics\n   */\n  getLibraryStatistics(): Record<string, any> {\n    const allTemplates = Array.from(this.templates.values());\n    const publishedTemplates = allTemplates.filter((t) => t.status === 'published');\n    const draftTemplates = allTemplates.filter((t) => t.status === 'draft');\n\n    const categories = new Map<TemplateCategory, number>();\n    allTemplates.forEach((t) => {\n      categories.set(t.category, (categories.get(t.category) || 0) + 1);\n    });\n\n    const totalUsage = Array.from(this.templateUsage.values()).reduce((a, b) => a + b, 0);\n    const avgOpenRate =\n      publishedTemplates.length > 0\n        ? publishedTemplates.reduce(\n            (sum, t) => sum + (t.performanceMetrics?.averageOpenRate || 0),\n            0\n          ) / publishedTemplates.length\n        : 0;\n\n    return {\n      totalTemplates: allTemplates.length,\n      publishedTemplates: publishedTemplates.length,\n      draftTemplates: draftTemplates.length,\n      archivedTemplates: allTemplates.filter((t) => t.status === 'archived').length,\n      categoriesBreakdown: Object.fromEntries(categories),\n      totalUsage,\n      averageOpenRate: avgOpenRate.toFixed(2),\n      totalVariants: this.variants.size,\n    };\n  }\n\n  /**\n   * Export template\n   */\n  exportTemplate(templateId: string): string | null {\n    const template = this.templates.get(templateId);\n    if (!template) return null;\n\n    return JSON.stringify(template, null, 2);\n  }\n\n  /**\n   * Import template\n   */\n  importTemplate(templateData: string, createdBy: string): CampaignTemplate | null {\n    try {\n      const data = JSON.parse(templateData);\n      const template: CampaignTemplate = {\n        id: `tpl-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n        name: data.name,\n        description: data.description,\n        category: data.category,\n        status: 'draft',\n        blocks: data.blocks,\n        variables: data.variables,\n        tags: data.tags || [],\n        createdBy,\n        createdAt: Date.now(),\n        updatedAt: Date.now(),\n        version: 1,\n      };\n\n      this.templates.set(template.id, template);\n      this.emit('template:imported', template);\n      return template;\n    } catch (error) {\n      this.emit('template:import_error', error);\n      return null;\n    }\n  }\n\n  /**\n   * Cleanup\n   */\n  destroy(): void {\n    // Cleanup if needed\n  }\n}\n\nexport default CampaignTemplateLibrary;\n
