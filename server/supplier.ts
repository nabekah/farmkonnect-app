import { EventEmitter } from 'events';\n\nexport type SupplierCategory = 'seeds' | 'fertilizer' | 'pesticides' | 'equipment' | 'services' | 'other';\nexport type SupplierStatus = 'active' | 'inactive' | 'suspended' | 'blacklisted';\n\nexport interface Supplier {\n  id: string;\n  farmId: string;\n  name: string;\n  category: SupplierCategory;\n  contactPerson: string;\n  email: string;\n  phone: string;\n  address: string;\n  city: string;\n  state: string;\n  zipCode: string;\n  country: string;\n  status: SupplierStatus;\n  rating: number; // 1-5\n  totalOrders: number;\n  totalSpent: number;\n  averageDeliveryDays: number;\n  paymentTerms: string;\n  dateAdded: number;\n  lastOrderDate?: number;\n}\n\nexport interface PricingHistory {\n  id: string;\n  supplierId: string;\n  productName: string;\n  price: number;\n  quantity: number;\n  unit: string;\n  date: number;\n  notes: string;\n}\n\nexport interface SupplierOrder {\n  id: string;\n  supplierId: string;\n  farmId: string;\n  orderDate: number;\n  expectedDeliveryDate: number;\n  actualDeliveryDate?: number;\n  items: {\n    productName: string;\n    quantity: number;\n    unit: string;\n    unitPrice: number;\n    totalPrice: number;\n  }[];\n  totalAmount: number;\n  status: 'pending' | 'confirmed' | 'shipped' | 'delivered' | 'cancelled';\n  paymentStatus: 'unpaid' | 'partial' | 'paid';\n  notes: string;\n}\n\nexport interface SupplierPerformance {\n  supplierId: string;\n  totalOrders: number;\n  onTimeDelivery: number; // percentage\n  qualityRating: number; // 1-5\n  priceCompetitiveness: number; // 1-5\n  communicationRating: number; // 1-5\n  overallScore: number; // 1-5\n  issues: string[];\n  recommendations: string[];\n}\n\nexport interface SupplierComparison {\n  product: string;\n  suppliers: {\n    supplierId: string;\n    supplierName: string;\n    price: number;\n    quantity: number;\n    unit: string;\n    deliveryDays: number;\n    rating: number;\n  }[];\n  bestPrice: { supplierId: string; price: number };\n  bestRating: { supplierId: string; rating: number };\n  bestDelivery: { supplierId: string; days: number };\n}\n\n/**\n * Supplier Management System\n */\nexport class SupplierManager extends EventEmitter {\n  private suppliers: Map<string, Supplier> = new Map();\n  private pricingHistory: Map<string, PricingHistory> = new Map();\n  private orders: Map<string, SupplierOrder> = new Map();\n  private performances: Map<string, SupplierPerformance> = new Map();\n\n  constructor() {\n    super();\n  }\n\n  /**\n   * Add supplier\n   */\n  addSupplier(\n    farmId: string,\n    name: string,\n    category: SupplierCategory,\n    contactPerson: string,\n    email: string,\n    phone: string,\n    address: string,\n    city: string,\n    state: string,\n    zipCode: string,\n    country: string,\n    paymentTerms: string = 'Net 30'\n  ): Supplier {\n    const supplierId = `supplier_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const supplier: Supplier = {\n      id: supplierId,\n      farmId,\n      name,\n      category,\n      contactPerson,\n      email,\n      phone,\n      address,\n      city,\n      state,\n      zipCode,\n      country,\n      status: 'active',\n      rating: 0,\n      totalOrders: 0,\n      totalSpent: 0,\n      averageDeliveryDays: 0,\n      paymentTerms,\n      dateAdded: Date.now(),\n    };\n\n    this.suppliers.set(supplierId, supplier);\n    this.emit('supplier:added', { supplierId, farmId, name });\n    return supplier;\n  }\n\n  /**\n   * Get supplier\n   */\n  getSupplier(supplierId: string): Supplier | null {\n    return this.suppliers.get(supplierId) || null;\n  }\n\n  /**\n   * Get suppliers by farm\n   */\n  getSuppliersByFarm(farmId: string): Supplier[] {\n    return Array.from(this.suppliers.values()).filter((s) => s.farmId === farmId);\n  }\n\n  /**\n   * Get suppliers by category\n   */\n  getSuppliersByCategory(farmId: string, category: SupplierCategory): Supplier[] {\n    return Array.from(this.suppliers.values()).filter((s) => s.farmId === farmId && s.category === category);\n  }\n\n  /**\n   * Update supplier rating\n   */\n  updateSupplierRating(supplierId: string, rating: number): Supplier | null {\n    const supplier = this.suppliers.get(supplierId);\n    if (!supplier) return null;\n\n    supplier.rating = Math.min(5, Math.max(1, rating));\n    this.emit('supplier:rated', { supplierId, rating: supplier.rating });\n    return supplier;\n  }\n\n  /**\n   * Record pricing history\n   */\n  recordPricingHistory(\n    supplierId: string,\n    productName: string,\n    price: number,\n    quantity: number,\n    unit: string,\n    notes: string = ''\n  ): PricingHistory {\n    const historyId = `pricing_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const history: PricingHistory = {\n      id: historyId,\n      supplierId,\n      productName,\n      price,\n      quantity,\n      unit,\n      date: Date.now(),\n      notes,\n    };\n\n    this.pricingHistory.set(historyId, history);\n    this.emit('pricing:recorded', { historyId, supplierId, productName, price });\n    return history;\n  }\n\n  /**\n   * Get pricing history\n   */\n  getPricingHistory(supplierId: string, productName?: string): PricingHistory[] {\n    let history = Array.from(this.pricingHistory.values()).filter((h) => h.supplierId === supplierId);\n    if (productName) {\n      history = history.filter((h) => h.productName === productName);\n    }\n    return history.sort((a, b) => b.date - a.date);\n  }\n\n  /**\n   * Create order\n   */\n  createOrder(\n    supplierId: string,\n    farmId: string,\n    items: { productName: string; quantity: number; unit: string; unitPrice: number }[],\n    expectedDeliveryDays: number = 7,\n    notes: string = ''\n  ): SupplierOrder {\n    const orderId = `order_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const totalAmount = items.reduce((sum, item) => sum + item.quantity * item.unitPrice, 0);\n    const expectedDeliveryDate = Date.now() + expectedDeliveryDays * 86400000;\n\n    const order: SupplierOrder = {\n      id: orderId,\n      supplierId,\n      farmId,\n      orderDate: Date.now(),\n      expectedDeliveryDate,\n      items: items.map((item) => ({\n        ...item,\n        totalPrice: item.quantity * item.unitPrice,\n      })),\n      totalAmount,\n      status: 'pending',\n      paymentStatus: 'unpaid',\n      notes,\n    };\n\n    this.orders.set(orderId, order);\n    const supplier = this.suppliers.get(supplierId);\n    if (supplier) {\n      supplier.totalOrders += 1;\n      supplier.totalSpent += totalAmount;\n      supplier.lastOrderDate = Date.now();\n    }\n    this.emit('order:created', { orderId, supplierId, totalAmount });\n    return order;\n  }\n\n  /**\n   * Get orders\n   */\n  getOrders(supplierId?: string, status?: string): SupplierOrder[] {\n    let orders = Array.from(this.orders.values());\n    if (supplierId) {\n      orders = orders.filter((o) => o.supplierId === supplierId);\n    }\n    if (status) {\n      orders = orders.filter((o) => o.status === status);\n    }\n    return orders.sort((a, b) => b.orderDate - a.orderDate);\n  }\n\n  /**\n   * Update order status\n   */\n  updateOrderStatus(orderId: string, status: string): SupplierOrder | null {\n    const order = this.orders.get(orderId);\n    if (!order) return null;\n\n    order.status = status as any;\n    if (status === 'delivered') {\n      order.actualDeliveryDate = Date.now();\n      const supplier = this.suppliers.get(order.supplierId);\n      if (supplier) {\n        const deliveryDays = (order.actualDeliveryDate - order.orderDate) / 86400000;\n        supplier.averageDeliveryDays =\n          (supplier.averageDeliveryDays * (supplier.totalOrders - 1) + deliveryDays) / supplier.totalOrders;\n      }\n    }\n    this.emit('order:updated', { orderId, status });\n    return order;\n  }\n\n  /**\n   * Calculate supplier performance\n   */\n  calculateSupplierPerformance(supplierId: string): SupplierPerformance {\n    const supplier = this.suppliers.get(supplierId);\n    if (!supplier) throw new Error('Supplier not found');\n\n    const supplierOrders = this.getOrders(supplierId);\n    const deliveredOrders = supplierOrders.filter((o) => o.status === 'delivered');\n    const onTimeOrders = deliveredOrders.filter(\n      (o) => o.actualDeliveryDate! <= o.expectedDeliveryDate\n    ).length;\n    const onTimeDelivery = deliveredOrders.length > 0 ? (onTimeOrders / deliveredOrders.length) * 100 : 0;\n\n    const issues: string[] = [];\n    const recommendations: string[] = [];\n\n    if (onTimeDelivery < 80) {\n      issues.push('Late delivery rate exceeds 20%');\n      recommendations.push('Discuss delivery schedule with supplier');\n    }\n\n    if (supplier.rating < 3) {\n      issues.push('Low supplier rating');\n      recommendations.push('Review quality issues and address with supplier');\n    }\n\n    const performance: SupplierPerformance = {\n      supplierId,\n      totalOrders: supplierOrders.length,\n      onTimeDelivery,\n      qualityRating: supplier.rating,\n      priceCompetitiveness: 3, // Placeholder\n      communicationRating: 3, // Placeholder\n      overallScore: (supplier.rating + onTimeDelivery / 20) / 2,\n      issues,\n      recommendations,\n    };\n\n    this.performances.set(supplierId, performance);\n    return performance;\n  }\n\n  /**\n   * Compare suppliers\n   */\n  compareSuppliers(farmId: string, product: string): SupplierComparison {\n    const suppliers = this.getSuppliersByFarm(farmId);\n    const comparisons = suppliers\n      .map((supplier) => {\n        const pricing = this.getPricingHistory(supplier.id, product);\n        const latestPrice = pricing.length > 0 ? pricing[0] : null;\n        return {\n          supplierId: supplier.id,\n          supplierName: supplier.name,\n          price: latestPrice?.price || 0,\n          quantity: latestPrice?.quantity || 0,\n          unit: latestPrice?.unit || '',\n          deliveryDays: supplier.averageDeliveryDays,\n          rating: supplier.rating,\n        };\n      })\n      .filter((c) => c.price > 0);\n\n    const bestPrice = comparisons.reduce((best, current) =>\n      current.price < best.price ? current : best\n    );\n    const bestRating = comparisons.reduce((best, current) =>\n      current.rating > best.rating ? current : best\n    );\n    const bestDelivery = comparisons.reduce((best, current) =>\n      current.deliveryDays < best.deliveryDays ? current : best\n    );\n\n    return {\n      product,\n      suppliers: comparisons,\n      bestPrice: { supplierId: bestPrice.supplierId, price: bestPrice.price },\n      bestRating: { supplierId: bestRating.supplierId, rating: bestRating.rating },\n      bestDelivery: { supplierId: bestDelivery.supplierId, days: bestDelivery.deliveryDays },\n    };\n  }\n\n  /**\n   * Get statistics\n   */\n  getStatistics(): {\n    totalSuppliers: number;\n    activeSuppliers: number;\n    totalOrders: number;\n    totalSpent: number;\n    pricingRecords: number;\n  } {\n    const activeSuppliers = Array.from(this.suppliers.values()).filter((s) => s.status === 'active').length;\n    const totalSpent = Array.from(this.suppliers.values()).reduce((sum, s) => sum + s.totalSpent, 0);\n\n    return {\n      totalSuppliers: this.suppliers.size,\n      activeSuppliers,\n      totalOrders: this.orders.size,\n      totalSpent,\n      pricingRecords: this.pricingHistory.size,\n    };\n  }\n}\n
