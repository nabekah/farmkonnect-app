/**
 * Harvest Planning System
 * Manages harvest timing, labor, equipment, and post-harvest operations
 */

export interface HarvestPlan {
  fieldId: string;
  cropName: string;
  estimatedHarvestDate: Date;
  expectedYield: number; // kg/hectare\n  harvestMethod: 'manual' | 'mechanical' | 'combined';\n  laborRequirement: number; // person-days\n  equipmentNeeded: HarvestEquipment[];\n  postHarvestOperations: PostHarvestOperation[];\n  storageRequirement: number; // metric tons\n  marketingPlan: MarketingPlan;\n  riskFactors: RiskFactor[];\n  status: 'planned' | 'in_progress' | 'completed';\n}\n\nexport interface HarvestEquipment {\n  equipmentType: string;\n  quantity: number;\n  rentalCost?: number;\n  operatorRequired: boolean;\n}\n\nexport interface PostHarvestOperation {\n  operationType: string;\n  timing: string;\n  duration: number; // days\n  costEstimate: number;\n  description: string;\n}\n\nexport interface MarketingPlan {\n  targetMarkets: string[];\n  expectedPrice: number; // per kg\n  marketingChannels: string[];\n  storageLocation: string;\n  transportationMethod: string;\n}\n\nexport interface RiskFactor {\n  riskType: string;\n  probability: number; // 0-100\n  impact: string;\n  mitigationStrategy: string;\n}\n\n/**\n * Harvest Planning Implementation\n */\nexport class HarvestPlanner {\n  private harvestPlans: Map<string, HarvestPlan> = new Map();\n  private harvestReadinessIndicators: Map<string, HarvestIndicator[]> = new Map();\n\n  constructor() {\n    this.initializeHarvestIndicators();\n  }\n\n  private initializeHarvestIndicators(): void {\n    // Rice harvest indicators\n    this.harvestReadinessIndicators.set('rice', [\n      {\n        cropName: 'rice',\n        indicator: 'Grain moisture',\n        optimalRange: { min: 20, max: 25 },\n        unit: 'percentage',\n        checkMethod: 'moisture meter',\n      },\n      {\n        cropName: 'rice',\n        indicator: 'Grain color',\n        optimalRange: { min: 0, max: 0 },\n        unit: 'visual',\n        checkMethod: 'golden yellow color',\n      },\n      {\n        cropName: 'rice',\n        indicator: 'Panicle bending',\n        optimalRange: { min: 80, max: 100 },\n        unit: 'percentage',\n        checkMethod: 'visual inspection',\n      },\n      {\n        cropName: 'rice',\n        indicator: 'Days to maturity',\n        optimalRange: { min: 120, max: 130 },\n        unit: 'days',\n        checkMethod: 'calendar',\n      },\n    ]);\n\n    // Wheat harvest indicators\n    this.harvestReadinessIndicators.set('wheat', [\n      {\n        cropName: 'wheat',\n        indicator: 'Grain moisture',\n        optimalRange: { min: 12, max: 15 },\n        unit: 'percentage',\n        checkMethod: 'moisture meter',\n      },\n      {\n        cropName: 'wheat',\n        indicator: 'Straw color',\n        optimalRange: { min: 0, max: 0 },\n        unit: 'visual',\n        checkMethod: 'golden brown color',\n      },\n      {\n        cropName: 'wheat',\n        indicator: 'Grain hardness',\n        optimalRange: { min: 0, max: 0 },\n        unit: 'hardness',\n        checkMethod: 'cannot be dented with fingernail',\n      },\n    ]);\n\n    // Corn harvest indicators\n    this.harvestReadinessIndicators.set('corn', [\n      {\n        cropName: 'corn',\n        indicator: 'Grain moisture',\n        optimalRange: { min: 20, max: 25 },\n        unit: 'percentage',\n        checkMethod: 'moisture meter',\n      },\n      {\n        cropName: 'corn',\n        indicator: 'Kernel color',\n        optimalRange: { min: 0, max: 0 },\n        unit: 'visual',\n        checkMethod: 'dark color, hard kernel',\n      },\n      {\n        cropName: 'corn',\n        indicator: 'Cob color',\n        optimalRange: { min: 0, max: 0 },\n        unit: 'visual',\n        checkMethod: 'red or brown cob',\n      },\n    ]);\n  }\n\n  createHarvestPlan(\n    fieldId: string,\n    cropName: string,\n    estimatedYield: number,\n    fieldArea: number\n  ): HarvestPlan {\n    const harvestMethod = this.determineHarvestMethod(cropName, fieldArea);\n    const laborRequirement = this.calculateLaborRequirement(cropName, fieldArea, harvestMethod);\n    const equipmentNeeded = this.getRequiredEquipment(cropName, harvestMethod, fieldArea);\n    const postHarvestOps = this.getPostHarvestOperations(cropName);\n    const storageReq = (estimatedYield * fieldArea) / 1000; // Convert to metric tons\n    const riskFactors = this.identifyRiskFactors(cropName, fieldArea);\n\n    const plan: HarvestPlan = {\n      fieldId,\n      cropName,\n      estimatedHarvestDate: this.estimateHarvestDate(cropName),\n      expectedYield: estimatedYield,\n      harvestMethod,\n      laborRequirement,\n      equipmentNeeded,\n      postHarvestOperations: postHarvestOps,\n      storageRequirement: storageReq,\n      marketingPlan: this.createMarketingPlan(cropName),\n      riskFactors,\n      status: 'planned',\n    };\n\n    const planId = `harvest-plan-${fieldId}-${Date.now()}`;\n    this.harvestPlans.set(planId, plan);\n\n    return plan;\n  }\n\n  private determineHarvestMethod(\n    cropName: string,\n    fieldArea: number\n  ): 'manual' | 'mechanical' | 'combined' {\n    // Determine based on crop and field size\n    if (cropName.toLowerCase() === 'rice') {\n      return fieldArea > 5 ? 'mechanical' : 'manual';\n    } else if (cropName.toLowerCase() === 'wheat') {\n      return fieldArea > 3 ? 'mechanical' : 'combined';\n    } else if (cropName.toLowerCase() === 'corn') {\n      return fieldArea > 4 ? 'mechanical' : 'combined';\n    }\n    return 'manual';\n  }\n\n  private calculateLaborRequirement(\n    cropName: string,\n    fieldArea: number,\n    harvestMethod: string\n  ): number {\n    // Labor requirement in person-days\n    const baseRequirements: { [key: string]: number } = {\n      rice: 10,\n      wheat: 8,\n      corn: 12,\n    };\n\n    const base = baseRequirements[cropName.toLowerCase()] || 10;\n    const methodMultiplier = harvestMethod === 'manual' ? 1.5 : harvestMethod === 'mechanical' ? 0.5 : 1.0;\n\n    return Math.round(base * fieldArea * methodMultiplier);\n  }\n\n  private getRequiredEquipment(cropName: string, harvestMethod: string, fieldArea: number): HarvestEquipment[] {\n    const equipment: HarvestEquipment[] = [];\n\n    if (harvestMethod === 'mechanical' || harvestMethod === 'combined') {\n      if (cropName.toLowerCase() === 'rice') {\n        equipment.push(\n          { equipmentType: 'Combine Harvester', quantity: 1, rentalCost: 5000, operatorRequired: true },\n          { equipmentType: 'Thresher', quantity: 1, rentalCost: 2000, operatorRequired: true }\n        );\n      } else if (cropName.toLowerCase() === 'wheat') {\n        equipment.push(\n          { equipmentType: 'Combine Harvester', quantity: 1, rentalCost: 4500, operatorRequired: true }\n        );\n      } else if (cropName.toLowerCase() === 'corn') {\n        equipment.push(\n          { equipmentType: 'Corn Harvester', quantity: 1, rentalCost: 6000, operatorRequired: true }\n        );\n      }\n    }\n\n    if (harvestMethod === 'manual' || harvestMethod === 'combined') {\n      equipment.push(\n        { equipmentType: 'Sickles/Scythes', quantity: Math.ceil(fieldArea * 5), operatorRequired: false },\n        { equipmentType: 'Baskets', quantity: Math.ceil(fieldArea * 10), operatorRequired: false }\n      );\n    }\n\n    return equipment;\n  }\n\n  private getPostHarvestOperations(cropName: string): PostHarvestOperation[] {\n    const operations: PostHarvestOperation[] = [];\n\n    if (cropName.toLowerCase() === 'rice') {\n      operations.push(\n        {\n          operationType: 'Threshing',\n          timing: 'Immediately after harvest',\n          duration: 2,\n          costEstimate: 500,\n          description: 'Separate grain from straw',\n        },\n        {\n          operationType: 'Drying',\n          timing: 'After threshing',\n          duration: 3,\n          costEstimate: 300,\n          description: 'Reduce moisture to 12-14%',\n        },\n        {\n          operationType: 'Cleaning',\n          timing: 'After drying',\n          duration: 1,\n          costEstimate: 200,\n          description: 'Remove impurities and broken grains',\n        }\n      );\n    } else if (cropName.toLowerCase() === 'wheat') {\n      operations.push(\n        {\n          operationType: 'Threshing',\n          timing: 'Immediately after harvest',\n          duration: 2,\n          costEstimate: 400,\n          description: 'Separate grain from chaff',\n        },\n        {\n          operationType: 'Drying',\n          timing: 'After threshing',\n          duration: 2,\n          costEstimate: 250,\n          description: 'Reduce moisture to 10-12%',\n        }\n      );\n    }\n\n    return operations;\n  }\n\n  private createMarketingPlan(cropName: string): MarketingPlan {\n    const priceRanges: { [key: string]: number } = {\n      rice: 25,\n      wheat: 20,\n      corn: 15,\n    };\n\n    return {\n      targetMarkets: ['Local Market', 'Wholesale', 'Direct Consumer'],\n      expectedPrice: priceRanges[cropName.toLowerCase()] || 20,\n      marketingChannels: ['Direct Sales', 'Cooperative', 'Trader'],\n      storageLocation: 'Farm Storage',\n      transportationMethod: 'Truck',\n    };\n  }\n\n  private estimateHarvestDate(cropName: string): Date {\n    const date = new Date();\n    const daysToHarvest: { [key: string]: number } = {\n      rice: 120,\n      wheat: 140,\n      corn: 130,\n    };\n\n    const days = daysToHarvest[cropName.toLowerCase()] || 120;\n    date.setDate(date.getDate() + days);\n    return date;\n  }\n\n  private identifyRiskFactors(cropName: string, fieldArea: number): RiskFactor[] {\n    return [\n      {\n        riskType: 'Weather',\n        probability: 30,\n        impact: 'Unexpected rain during harvest',\n        mitigationStrategy: 'Monitor weather forecast and have backup drying facility',\n      },\n      {\n        riskType: 'Equipment Failure',\n        probability: 20,\n        impact: 'Mechanical breakdown during harvest',\n        mitigationStrategy: 'Maintain equipment and have backup equipment available',\n      },\n      {\n        riskType: 'Labor Shortage',\n        probability: 25,\n        impact: 'Insufficient labor for harvest',\n        mitigationStrategy: 'Plan ahead and hire labor in advance',\n      },\n      {\n        riskType: 'Market Price Fluctuation',\n        probability: 40,\n        impact: 'Lower prices at harvest time',\n        mitigationStrategy: 'Diversify marketing channels and consider contract farming',\n      },\n    ];\n  }\n\n  checkHarvestReadiness(cropName: string, indicators: { [key: string]: number }): boolean {\n    const readinessIndicators = this.harvestReadinessIndicators.get(cropName.toLowerCase());\n    if (!readinessIndicators) return false;\n\n    let readyCount = 0;\n    readinessIndicators.forEach(indicator => {\n      const value = indicators[indicator.indicator];\n      if (value !== undefined) {\n        if (value >= indicator.optimalRange.min && value <= indicator.optimalRange.max) {\n          readyCount++;\n        }\n      }\n    });\n\n    return readyCount >= readinessIndicators.length * 0.7; // 70% of indicators should be ready\n  }\n\n  getHarvestPlan(planId: string): HarvestPlan | undefined {\n    return this.harvestPlans.get(planId);\n  }\n\n  updateHarvestStatus(planId: string, status: 'planned' | 'in_progress' | 'completed'): void {\n    const plan = this.harvestPlans.get(planId);\n    if (plan) {\n      plan.status = status;\n    }\n  }\n}\n\ninterface HarvestIndicator {\n  cropName: string;\n  indicator: string;\n  optimalRange: { min: number; max: number };\n  unit: string;\n  checkMethod: string;\n}\n\nexport const harvestPlanner = new HarvestPlanner();\n
