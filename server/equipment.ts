import { EventEmitter } from 'events';\n\nexport type EquipmentStatus = 'operational' | 'maintenance' | 'repair' | 'retired';\nexport type MaintenanceType = 'routine' | 'preventive' | 'corrective' | 'emergency';\n\nexport interface Equipment {\n  id: string;\n  farmId: string;\n  name: string;\n  type: string; // e.g., 'Tractor', 'Harvester', 'Plow'\n  manufacturer: string;\n  model: string;\n  purchaseDate: number;\n  purchaseCost: number;\n  status: EquipmentStatus;\n  operatingHours: number;\n  lastServiceDate: number;\n  nextServiceDate: number;\n  fuelType: string;\n  fuelCapacity: number; // liters\n  currentFuelLevel: number; // liters\n  location: string;\n  notes: string;\n}\n\nexport interface MaintenanceRecord {\n  id: string;\n  equipmentId: string;\n  farmId: string;\n  type: MaintenanceType;\n  description: string;\n  date: number;\n  completedDate?: number;\n  cost: number;\n  technician: string;\n  parts: Array<{\n    name: string;\n    quantity: number;\n    cost: number;\n  }>;\n  hoursWorked: number;\n  notes: string;\n}\n\nexport interface MaintenanceSchedule {\n  id: string;\n  equipmentId: string;\n  farmId: string;\n  type: MaintenanceType;\n  description: string;\n  frequency: 'daily' | 'weekly' | 'monthly' | 'quarterly' | 'annually' | 'every_100h' | 'every_500h' | 'every_1000h';\n  lastPerformed: number;\n  nextDue: number;\n  estimatedCost: number;\n  priority: 'low' | 'medium' | 'high' | 'critical';\n}\n\nexport interface FuelLog {\n  id: string;\n  equipmentId: string;\n  farmId: string;\n  date: number;\n  amount: number; // liters\n  cost: number;\n  operatingHours: number;\n  location: string;\n  notes: string;\n}\n\nexport interface EquipmentUsage {\n  id: string;\n  equipmentId: string;\n  farmId: string;\n  fieldId: string;\n  date: number;\n  hoursUsed: number;\n  fuelUsed: number; // liters\n  task: string;\n  operator: string;\n  notes: string;\n}\n\nexport interface EquipmentCost {\n  equipmentId: string;\n  totalPurchaseCost: number;\n  totalMaintenanceCost: number;\n  totalFuelCost: number;\n  totalOperatingCost: number;\n  costPerHour: number;\n  costPerYear: number;\n}\n\n/**\n * Equipment & Machinery Tracker System\n */\nexport class EquipmentManager extends EventEmitter {\n  private equipment: Map<string, Equipment> = new Map();\n  private maintenanceRecords: Map<string, MaintenanceRecord> = new Map();\n  private maintenanceSchedules: Map<string, MaintenanceSchedule> = new Map();\n  private fuelLogs: Map<string, FuelLog> = new Map();\n  private usageLogs: Map<string, EquipmentUsage> = new Map();\n\n  constructor() {\n    super();\n  }\n\n  /**\n   * Register equipment\n   */\n  registerEquipment(\n    farmId: string,\n    name: string,\n    type: string,\n    manufacturer: string,\n    model: string,\n    purchaseDate: number,\n    purchaseCost: number,\n    fuelType: string,\n    fuelCapacity: number,\n    location: string,\n    notes: string = ''\n  ): Equipment {\n    const equipmentId = `equip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const equipment: Equipment = {\n      id: equipmentId,\n      farmId,\n      name,\n      type,\n      manufacturer,\n      model,\n      purchaseDate,\n      purchaseCost,\n      status: 'operational',\n      operatingHours: 0,\n      lastServiceDate: purchaseDate,\n      nextServiceDate: purchaseDate + 30 * 86400000, // 30 days\n      fuelType,\n      fuelCapacity,\n      currentFuelLevel: fuelCapacity,\n      location,\n      notes,\n    };\n\n    this.equipment.set(equipmentId, equipment);\n    this.emit('equipment:registered', { equipmentId, farmId, name });\n    return equipment;\n  }\n\n  /**\n   * Get equipment\n   */\n  getEquipment(equipmentId: string): Equipment | null {\n    return this.equipment.get(equipmentId) || null;\n  }\n\n  /**\n   * Get equipment by farm\n   */\n  getEquipmentByFarm(farmId: string): Equipment[] {\n    return Array.from(this.equipment.values()).filter((e) => e.farmId === farmId);\n  }\n\n  /**\n   * Update equipment status\n   */\n  updateEquipmentStatus(equipmentId: string, status: EquipmentStatus): Equipment | null {\n    const equipment = this.equipment.get(equipmentId);\n    if (!equipment) return null;\n\n    equipment.status = status;\n    this.emit('equipment:statusChanged', { equipmentId, status });\n    return equipment;\n  }\n\n  /**\n   * Record maintenance\n   */\n  recordMaintenance(\n    equipmentId: string,\n    farmId: string,\n    type: MaintenanceType,\n    description: string,\n    cost: number,\n    technician: string,\n    parts: Array<{ name: string; quantity: number; cost: number }>,\n    hoursWorked: number,\n    notes: string = ''\n  ): MaintenanceRecord {\n    const recordId = `maint_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const record: MaintenanceRecord = {\n      id: recordId,\n      equipmentId,\n      farmId,\n      type,\n      description,\n      date: Date.now(),\n      cost,\n      technician,\n      parts,\n      hoursWorked,\n      notes,\n    };\n\n    this.maintenanceRecords.set(recordId, record);\n    this.emit('maintenance:recorded', { recordId, equipmentId, type });\n    return record;\n  }\n\n  /**\n   * Complete maintenance\n   */\n  completeMaintenance(recordId: string): MaintenanceRecord | null {\n    const record = this.maintenanceRecords.get(recordId);\n    if (!record) return null;\n\n    record.completedDate = Date.now();\n    const equipment = this.equipment.get(record.equipmentId);\n    if (equipment) {\n      equipment.lastServiceDate = Date.now();\n      equipment.status = 'operational';\n    }\n\n    this.emit('maintenance:completed', { recordId });\n    return record;\n  }\n\n  /**\n   * Get maintenance history\n   */\n  getMaintenanceHistory(equipmentId: string): MaintenanceRecord[] {\n    return Array.from(this.maintenanceRecords.values())\n      .filter((r) => r.equipmentId === equipmentId)\n      .sort((a, b) => b.date - a.date);\n  }\n\n  /**\n   * Create maintenance schedule\n   */\n  createMaintenanceSchedule(\n    equipmentId: string,\n    farmId: string,\n    type: MaintenanceType,\n    description: string,\n    frequency: string,\n    estimatedCost: number,\n    priority: 'low' | 'medium' | 'high' | 'critical'\n  ): MaintenanceSchedule {\n    const scheduleId = `schedule_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const nextDue = this.calculateNextDueDate(Date.now(), frequency);\n\n    const schedule: MaintenanceSchedule = {\n      id: scheduleId,\n      equipmentId,\n      farmId,\n      type,\n      description,\n      frequency: frequency as any,\n      lastPerformed: Date.now(),\n      nextDue,\n      estimatedCost,\n      priority,\n    };\n\n    this.maintenanceSchedules.set(scheduleId, schedule);\n    this.emit('schedule:created', { scheduleId, equipmentId });\n    return schedule;\n  }\n\n  /**\n   * Calculate next due date\n   */\n  private calculateNextDueDate(baseDate: number, frequency: string): number {\n    const intervals: { [key: string]: number } = {\n      daily: 86400000,\n      weekly: 7 * 86400000,\n      monthly: 30 * 86400000,\n      quarterly: 90 * 86400000,\n      annually: 365 * 86400000,\n      every_100h: 100 * 3600000,\n      every_500h: 500 * 3600000,\n      every_1000h: 1000 * 3600000,\n    };\n\n    return baseDate + (intervals[frequency] || 30 * 86400000);\n  }\n\n  /**\n   * Get maintenance schedules\n   */\n  getMaintenanceSchedules(equipmentId: string): MaintenanceSchedule[] {\n    return Array.from(this.maintenanceSchedules.values()).filter((s) => s.equipmentId === equipmentId);\n  }\n\n  /**\n   * Record fuel log\n   */\n  recordFuelLog(\n    equipmentId: string,\n    farmId: string,\n    amount: number,\n    cost: number,\n    operatingHours: number,\n    location: string,\n    notes: string = ''\n  ): FuelLog {\n    const logId = `fuel_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const log: FuelLog = {\n      id: logId,\n      equipmentId,\n      farmId,\n      date: Date.now(),\n      amount,\n      cost,\n      operatingHours,\n      location,\n      notes,\n    };\n\n    this.fuelLogs.set(logId, log);\n\n    // Update equipment fuel level\n    const equipment = this.equipment.get(equipmentId);\n    if (equipment) {\n      equipment.currentFuelLevel = Math.min(equipment.fuelCapacity, equipment.currentFuelLevel + amount);\n      equipment.operatingHours += operatingHours;\n    }\n\n    this.emit('fuel:logged', { logId, equipmentId, amount });\n    return log;\n  }\n\n  /**\n   * Get fuel logs\n   */\n  getFuelLogs(equipmentId: string): FuelLog[] {\n    return Array.from(this.fuelLogs.values())\n      .filter((l) => l.equipmentId === equipmentId)\n      .sort((a, b) => b.date - a.date);\n  }\n\n  /**\n   * Record equipment usage\n   */\n  recordEquipmentUsage(\n    equipmentId: string,\n    farmId: string,\n    fieldId: string,\n    hoursUsed: number,\n    fuelUsed: number,\n    task: string,\n    operator: string,\n    notes: string = ''\n  ): EquipmentUsage {\n    const usageId = `usage_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const usage: EquipmentUsage = {\n      id: usageId,\n      equipmentId,\n      farmId,\n      fieldId,\n      date: Date.now(),\n      hoursUsed,\n      fuelUsed,\n      task,\n      operator,\n      notes,\n    };\n\n    this.usageLogs.set(usageId, usage);\n\n    // Update equipment\n    const equipment = this.equipment.get(equipmentId);\n    if (equipment) {\n      equipment.operatingHours += hoursUsed;\n      equipment.currentFuelLevel = Math.max(0, equipment.currentFuelLevel - fuelUsed);\n    }\n\n    this.emit('usage:recorded', { usageId, equipmentId, hoursUsed });\n    return usage;\n  }\n\n  /**\n   * Get usage logs\n   */\n  getUsageLogs(equipmentId: string): EquipmentUsage[] {\n    return Array.from(this.usageLogs.values())\n      .filter((u) => u.equipmentId === equipmentId)\n      .sort((a, b) => b.date - a.date);\n  }\n\n  /**\n   * Calculate equipment costs\n   */\n  calculateEquipmentCosts(equipmentId: string): EquipmentCost {\n    const equipment = this.equipment.get(equipmentId);\n    if (!equipment) throw new Error('Equipment not found');\n\n    const maintenanceRecords = this.getMaintenanceHistory(equipmentId);\n    const fuelLogs = this.getFuelLogs(equipmentId);\n\n    const totalMaintenanceCost = maintenanceRecords.reduce((sum, r) => sum + r.cost, 0);\n    const totalFuelCost = fuelLogs.reduce((sum, l) => sum + l.cost, 0);\n    const totalOperatingCost = equipment.purchaseCost + totalMaintenanceCost + totalFuelCost;\n\n    const yearsOwned = (Date.now() - equipment.purchaseDate) / (365 * 86400000);\n    const costPerHour = equipment.operatingHours > 0 ? totalOperatingCost / equipment.operatingHours : 0;\n    const costPerYear = yearsOwned > 0 ? totalOperatingCost / yearsOwned : 0;\n\n    return {\n      equipmentId,\n      totalPurchaseCost: equipment.purchaseCost,\n      totalMaintenanceCost,\n      totalFuelCost,\n      totalOperatingCost,\n      costPerHour,\n      costPerYear,\n    };\n  }\n\n  /**\n   * Get statistics\n   */\n  getStatistics(): {\n    totalEquipment: number;\n    operationalEquipment: number;\n    maintenanceEquipment: number;\n    totalMaintenanceRecords: number;\n    totalFuelCost: number;\n    averageFuelEfficiency: number;\n  } {\n    const allEquipment = Array.from(this.equipment.values());\n    const operationalCount = allEquipment.filter((e) => e.status === 'operational').length;\n    const maintenanceCount = allEquipment.filter((e) => e.status === 'maintenance').length;\n\n    const totalFuelCost = Array.from(this.fuelLogs.values()).reduce((sum, l) => sum + l.cost, 0);\n    const totalFuel = Array.from(this.fuelLogs.values()).reduce((sum, l) => sum + l.amount, 0);\n    const totalHours = Array.from(this.usageLogs.values()).reduce((sum, u) => sum + u.hoursUsed, 0);\n\n    const avgFuelEfficiency = totalHours > 0 ? totalFuel / totalHours : 0;\n\n    return {\n      totalEquipment: allEquipment.length,\n      operationalEquipment: operationalCount,\n      maintenanceEquipment: maintenanceCount,\n      totalMaintenanceRecords: this.maintenanceRecords.size,\n      totalFuelCost,\n      averageFuelEfficiency,\n    };\n  }\n}\n
