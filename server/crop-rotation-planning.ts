/**\n * Crop Rotation Planning System\n * Plans sustainable crop rotations to maintain soil health and prevent disease\n */\n\nexport interface CropRotationPlan {\n  fieldId: string;\n  rotationName: string;\n  duration: number; // years\n  crops: CropInRotation[];\n  soilImpact: SoilImpactAssessment;\n  diseaseRiskReduction: number; // percentage\n  yieldPrediction: number; // kg/hectare\n  profitabilityScore: number; // 0-100\n  environmentalBenefit: string;\n  recommendations: string[];\n}\n\nexport interface CropInRotation {\n  year: number;\n  cropName: string;\n  expectedYield: number;\n  soilNitrogenChange: number; // kg/hectare\n  soilPhosphorusChange: number;\n  soilPotassiumChange: number;\n  pestsControlled: string[];\n  diseasesControlled: string[];\n  organicMatterAddition: number; // percentage\n}\n\nexport interface SoilImpactAssessment {\n  nitrogenLevel: 'depleted' | 'balanced' | 'enriched';\n  organicMatterTrend: 'declining' | 'stable' | 'improving';\n  soilStructure: 'poor' | 'fair' | 'good' | 'excellent';\n  microbiologicalActivity: number; // 0-100\n  compactionRisk: number; // 0-100\n}\n\nexport interface RotationTemplate {\n  name: string;\n  description: string;\n  crops: string[];\n  duration: number;\n  suitableRegions: string[];\n  benefits: string[];\n  constraints: string[];\n}\n\n/**\n * Crop Rotation Planning Implementation\n */\nexport class CropRotationPlanner {\n  private rotationPlans: Map<string, CropRotationPlan> = new Map();\n  private rotationTemplates: RotationTemplate[] = [];\n  private cropCharacteristics: Map<string, CropCharacteristics> = new Map();\n\n  constructor() {\n    this.initializeRotationTemplates();\n    this.initializeCropCharacteristics();\n  }\n\n  private initializeRotationTemplates(): void {\n    this.rotationTemplates = [\n      {\n        name: 'Rice-Wheat-Legume',\n        description: '3-year rotation for South Asian farms',\n        crops: ['rice', 'wheat', 'legume'],\n        duration: 3,\n        suitableRegions: ['South Asia', 'Southeast Asia'],\n        benefits: [\n          'Nitrogen fixation by legumes',\n          'Reduced pest buildup',\n          'Improved soil structure',\n          'Diversified income',\n        ],\n        constraints: ['Requires irrigation management', 'Labor intensive'],\n      },\n      {\n        name: 'Corn-Soybean-Wheat',\n        description: '3-year rotation for temperate regions',\n        crops: ['corn', 'soybean', 'wheat'],\n        duration: 3,\n        suitableRegions: ['North America', 'Europe', 'East Asia'],\n        benefits: [\n          'Nitrogen fixation',\n          'Reduced corn pests',\n          'Improved soil health',\n          'Market diversity',\n        ],\n        constraints: ['Requires good drainage', 'Market price fluctuation'],\n      },\n      {\n        name: 'Cotton-Legume-Cereal',\n        description: '3-year rotation for cotton-growing regions',\n        crops: ['cotton', 'legume', 'cereal'],\n        duration: 3,\n        suitableRegions: ['India', 'Africa', 'Americas'],\n        benefits: [\n          'Reduced cotton pests',\n          'Nitrogen replenishment',\n          'Reduced chemical use',\n          'Improved profitability',\n        ],\n        constraints: ['Legume market limited', 'Pest carryover risk'],\n      },\n      {\n        name: 'Vegetable-Legume-Cereal',\n        description: 'Rotation for intensive vegetable farms',\n        crops: ['vegetable', 'legume', 'cereal'],\n        duration: 3,\n        suitableRegions: ['All regions'],\n        benefits: [\n          'Reduced vegetable pests',\n          'Nitrogen fixation',\n          'Soil structure improvement',\n          'High market value',\n        ],\n        constraints: ['High labor requirement', 'Market volatility'],\n      },\n    ];\n  }\n\n  private initializeCropCharacteristics(): void {\n    this.cropCharacteristics.set('rice', {\n      cropName: 'rice',\n      nitrogenDemand: 'high',\n      nitrogenConsumption: 100,\n      nitrogenFixation: 0,\n      phosphorusDemand: 'medium',\n      potassiumDemand: 'high',\n      organicMatterAddition: 2,\n      rootDepth: 'shallow',\n      allelopathicEffect: false,\n      pestAccumulation: ['stem_borer', 'leaf_folder'],\n      diseaseAccumulation: ['blast', 'sheath_blight'],\n      soilCompaction: 'high',\n      soilStructureImpact: 'negative',\n      compatibleFollowCrops: ['wheat', 'legume', 'vegetable'],\n    });\n\n    this.cropCharacteristics.set('wheat', {\n      cropName: 'wheat',\n      nitrogenDemand: 'high',\n      nitrogenConsumption: 120,\n      nitrogenFixation: 0,\n      phosphorusDemand: 'medium',\n      potassiumDemand: 'medium',\n      organicMatterAddition: 1.5,\n      rootDepth: 'medium',\n      allelopathicEffect: false,\n      pestAccumulation: ['armyworm', 'aphids'],\n      diseaseAccumulation: ['rust', 'powdery_mildew'],\n      soilCompaction: 'medium',\n      soilStructureImpact: 'neutral',\n      compatibleFollowCrops: ['legume', 'corn', 'rice'],\n    });\n\n    this.cropCharacteristics.set('legume', {\n      cropName: 'legume',\n      nitrogenDemand: 'low',\n      nitrogenConsumption: 0,\n      nitrogenFixation: 150,\n      phosphorusDemand: 'medium',\n      potassiumDemand: 'medium',\n      organicMatterAddition: 3,\n      rootDepth: 'deep',\n      allelopathicEffect: false,\n      pestAccumulation: [],\n      diseaseAccumulation: [],\n      soilCompaction: 'low',\n      soilStructureImpact: 'positive',\n      compatibleFollowCrops: ['rice', 'wheat', 'corn'],\n    });\n\n    this.cropCharacteristics.set('corn', {\n      cropName: 'corn',\n      nitrogenDemand: 'very_high',\n      nitrogenConsumption: 150,\n      nitrogenFixation: 0,\n      phosphorusDemand: 'high',\n      potassiumDemand: 'high',\n      organicMatterAddition: 1,\n      rootDepth: 'deep',\n      allelopathicEffect: true,\n      pestAccumulation: ['corn_borer', 'armyworm'],\n      diseaseAccumulation: ['leaf_blight'],\n      soilCompaction: 'high',\n      soilStructureImpact: 'negative',\n      compatibleFollowCrops: ['soybean', 'legume'],\n    });\n\n    this.cropCharacteristics.set('soybean', {\n      cropName: 'soybean',\n      nitrogenDemand: 'low',\n      nitrogenConsumption: 0,\n      nitrogenFixation: 180,\n      phosphorusDemand: 'medium',\n      potassiumDemand: 'medium',\n      organicMatterAddition: 2.5,\n      rootDepth: 'medium',\n      allelopathicEffect: false,\n      pestAccumulation: [],\n      diseaseAccumulation: [],\n      soilCompaction: 'low',\n      soilStructureImpact: 'positive',\n      compatibleFollowCrops: ['corn', 'wheat'],\n    });\n  }\n\n  createRotationPlan(\n    fieldId: string,\n    templateName: string,\n    currentSoilCondition: SoilImpactAssessment\n  ): CropRotationPlan | null {\n    const template = this.rotationTemplates.find(t => t.name === templateName);\n    if (!template) return null;\n\n    const cropsInRotation: CropInRotation[] = [];\n    let cumulativeNitrogenChange = 0;\n    let cumulativePhosphorusChange = 0;\n    let cumulativePotassiumChange = 0;\n    let totalPestsControlled = new Set<string>();\n    let totalDiseasesControlled = new Set<string>();\n    let totalOrganicMatterAddition = 0;\n\n    template.crops.forEach((cropName, index) => {\n      const characteristics = this.cropCharacteristics.get(cropName);\n      if (!characteristics) return;\n\n      const nitrogenChange = characteristics.nitrogenFixation - characteristics.nitrogenConsumption;\n      const phosphorusChange = characteristics.phosphorusDemand === 'high' ? -40 : -20;\n      const potassiumChange = characteristics.potassiumDemand === 'high' ? -30 : -15;\n\n      cropsInRotation.push({\n        year: index + 1,\n        cropName,\n        expectedYield: this.estimateYield(cropName),\n        soilNitrogenChange: nitrogenChange,\n        soilPhosphorusChange: phosphorusChange,\n        soilPotassiumChange: potassiumChange,\n        pestsControlled: characteristics.pestAccumulation,\n        diseasesControlled: characteristics.diseaseAccumulation,\n        organicMatterAddition: characteristics.organicMatterAddition,\n      });\n\n      cumulativeNitrogenChange += nitrogenChange;\n      cumulativePhosphorusChange += phosphorusChange;\n      cumulativePotassiumChange += potassiumChange;\n      characteristics.pestAccumulation.forEach(p => totalPestsControlled.add(p));\n      characteristics.diseaseAccumulation.forEach(d => totalDiseasesControlled.add(d));\n      totalOrganicMatterAddition += characteristics.organicMatterAddition;\n    });\n\n    const soilImpact = this.assessSoilImpact(cumulativeNitrogenChange, totalOrganicMatterAddition);\n    const diseaseRiskReduction = this.calculateDiseaseRiskReduction(totalDiseasesControlled);\n    const avgYield = cropsInRotation.reduce((sum, c) => sum + c.expectedYield, 0) / cropsInRotation.length;\n    const profitability = this.calculateProfitability(cropsInRotation);\n\n    const plan: CropRotationPlan = {\n      fieldId,\n      rotationName: templateName,\n      duration: template.duration,\n      crops: cropsInRotation,\n      soilImpact,\n      diseaseRiskReduction,\n      yieldPrediction: Math.round(avgYield),\n      profitabilityScore: profitability,\n      environmentalBenefit: this.assessEnvironmentalBenefit(template),\n      recommendations: this.generateRecommendations(template, soilImpact),\n    };\n\n    const planId = `rotation-${fieldId}-${Date.now()}`;\n    this.rotationPlans.set(planId, plan);\n\n    return plan;\n  }\n\n  private estimateYield(cropName: string): number {\n    const baseYields: { [key: string]: number } = {\n      rice: 5000,\n      wheat: 4500,\n      corn: 6000,\n      soybean: 2500,\n      legume: 1500,\n    };\n    return baseYields[cropName] || 3000;\n  }\n\n  private assessSoilImpact(\n    nitrogenChange: number,\n    organicMatterAddition: number\n  ): SoilImpactAssessment {\n    return {\n      nitrogenLevel: nitrogenChange > 50 ? 'enriched' : nitrogenChange < -50 ? 'depleted' : 'balanced',\n      organicMatterTrend: organicMatterAddition > 2 ? 'improving' : organicMatterAddition > 1 ? 'stable' : 'declining',\n      soilStructure: organicMatterAddition > 2.5 ? 'excellent' : 'good',\n      microbiologicalActivity: 60 + Math.min(40, organicMatterAddition * 10),\n      compactionRisk: Math.max(0, 50 - organicMatterAddition * 10),\n    };\n  }\n\n  private calculateDiseaseRiskReduction(diseasesControlled: Set<string>): number {\n    // Assume each disease controlled reduces risk by 15%\n    return Math.min(100, diseasesControlled.size * 15);\n  }\n\n  private calculateProfitability(crops: CropInRotation[]): number {\n    // Simple profitability calculation based on yield and crop value\n    const cropValues: { [key: string]: number } = {\n      rice: 25,\n      wheat: 20,\n      corn: 15,\n      soybean: 30,\n      legume: 10,\n    };\n\n    let totalValue = 0;\n    crops.forEach(crop => {\n      const value = cropValues[crop.cropName] || 15;\n      totalValue += (crop.expectedYield / 1000) * value;\n    });\n\n    return Math.min(100, Math.round((totalValue / 150) * 100));\n  }\n\n  private assessEnvironmentalBenefit(template: RotationTemplate): string {\n    return template.benefits.join(', ');\n  }\n\n  private generateRecommendations(template: RotationTemplate, soilImpact: SoilImpactAssessment): string[] {\n    const recommendations: string[] = [];\n\n    recommendations.push(`Follow the ${template.name} rotation pattern`);\n\n    if (soilImpact.nitrogenLevel === 'depleted') {\n      recommendations.push('Consider adding nitrogen-fixing legumes to replenish soil nitrogen');\n    }\n\n    if (soilImpact.organicMatterTrend === 'declining') {\n      recommendations.push('Increase organic matter through crop residue retention and composting');\n    }\n\n    if (soilImpact.compactionRisk > 60) {\n      recommendations.push('Implement conservation tillage to reduce soil compaction');\n    }\n\n    recommendations.push('Monitor soil health annually with soil testing');\n    recommendations.push('Keep detailed records of crop performance and soil conditions');\n\n    return recommendations;\n  }\n\n  getRotationPlan(planId: string): CropRotationPlan | undefined {\n    return this.rotationPlans.get(planId);\n  }\n\n  getAvailableTemplates(): RotationTemplate[] {\n    return this.rotationTemplates;\n  }\n}\n\ninterface CropCharacteristics {\n  cropName: string;\n  nitrogenDemand: string;\n  nitrogenConsumption: number;\n  nitrogenFixation: number;\n  phosphorusDemand: string;\n  potassiumDemand: string;\n  organicMatterAddition: number;\n  rootDepth: string;\n  allelopathicEffect: boolean;\n  pestAccumulation: string[];\n  diseaseAccumulation: string[];\n  soilCompaction: string;\n  soilStructureImpact: string;\n  compatibleFollowCrops: string[];\n}\n\nexport const cropRotationPlanner = new CropRotationPlanner();\n
