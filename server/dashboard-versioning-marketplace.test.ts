import { describe, it, expect, beforeEach, vi } from 'vitest';\nimport TemplateVersioningManager from './template-versioning';\nimport DataSourceMarketplace from './datasource-marketplace';\n\ndescribe('TemplateVersioningManager', () => {\n  let manager: TemplateVersioningManager;\n\n  beforeEach(() => {\n    manager = new TemplateVersioningManager();\n  });\n\n  describe('Template Creation', () => {\n    it('should create initial template', () => {\n      const template = manager.createTemplate('template-1', { title: 'Test' }, 'user-1');\n\n      expect(template).toBeDefined();\n      expect(template.version).toBe(1);\n      expect(template.author).toBe('user-1');\n      expect(template.content.title).toBe('Test');\n    });\n\n    it('should get current version', () => {\n      manager.createTemplate('template-1', { title: 'Test' }, 'user-1');\n      const current = manager.getCurrentVersion('template-1');\n\n      expect(current).toBeDefined();\n      expect(current?.version).toBe(1);\n    });\n  });\n\n  describe('Version Management', () => {\n    beforeEach(() => {\n      manager.createTemplate('template-1', { title: 'Test', color: 'blue' }, 'user-1');\n    });\n\n    it('should create new version', () => {\n      const v2 = manager.createVersion(\n        'template-1',\n        { title: 'Updated', color: 'red' },\n        'user-2',\n        'Updated colors'\n      );\n\n      expect(v2).toBeDefined();\n      expect(v2?.version).toBe(2);\n      expect(v2?.author).toBe('user-2');\n    });\n\n    it('should get specific version', () => {\n      manager.createVersion(\n        'template-1',\n        { title: 'Updated', color: 'red' },\n        'user-2',\n        'Updated colors'\n      );\n\n      const v1 = manager.getVersion('template-1', 1);\n      const v2 = manager.getVersion('template-1', 2);\n\n      expect(v1?.content.color).toBe('blue');\n      expect(v2?.content.color).toBe('red');\n    });\n\n    it('should get all versions', () => {\n      manager.createVersion(\n        'template-1',\n        { title: 'Updated', color: 'red' },\n        'user-2',\n        'Updated colors'\n      );\n      manager.createVersion(\n        'template-1',\n        { title: 'Final', color: 'green' },\n        'user-3',\n        'Final update'\n      );\n\n      const all = manager.getAllVersions('template-1');\n      expect(all).toHaveLength(3);\n    });\n  });\n\n  describe('Rollback', () => {\n    beforeEach(() => {\n      manager.createTemplate('template-1', { title: 'V1' }, 'user-1');\n      manager.createVersion('template-1', { title: 'V2' }, 'user-2', 'Update');\n      manager.createVersion('template-1', { title: 'V3' }, 'user-3', 'Update');\n    });\n\n    it('should rollback to previous version', () => {\n      const rollback = manager.rollback('template-1', 1, 'user-4', 'Revert to v1');\n\n      expect(rollback).toBeDefined();\n      expect(rollback?.version).toBe(4);\n      expect(rollback?.content.title).toBe('V1');\n    });\n\n    it('should emit rollback event', () => {\n      const listener = vi.fn();\n      manager.on('version:rolledback', listener);\n\n      manager.rollback('template-1', 1, 'user-4', 'Revert to v1');\n\n      expect(listener).toHaveBeenCalled();\n    });\n  });\n\n  describe('Version Comparison', () => {\n    beforeEach(() => {\n      manager.createTemplate('template-1', { title: 'V1', color: 'blue', size: 10 }, 'user-1');\n      manager.createVersion(\n        'template-1',\n        { title: 'V2', color: 'red', size: 10, width: 100 },\n        'user-2',\n        'Update'\n      );\n    });\n\n    it('should compare versions', () => {\n      const diff = manager.compareVersions('template-1', 1, 2);\n\n      expect(diff).toBeDefined();\n      expect(diff?.added).toHaveProperty('width');\n      expect(diff?.modified).toHaveProperty('title');\n      expect(diff?.modified).toHaveProperty('color');\n    });\n  });\n\n  describe('Branching', () => {\n    beforeEach(() => {\n      manager.createTemplate('template-1', { title: 'Main' }, 'user-1');\n    });\n\n    it('should create branch', () => {\n      const created = manager.createBranch('template-1', 'feature');\n      expect(created).toBe(true);\n    });\n\n    it('should get branch version', () => {\n      manager.createBranch('template-1', 'feature');\n      const version = manager.getBranchVersion('template-1', 'feature');\n\n      expect(version).toBeDefined();\n      expect(version?.content.title).toBe('Main');\n    });\n\n    it('should list branches', () => {\n      manager.createBranch('template-1', 'feature');\n      manager.createBranch('template-1', 'bugfix');\n\n      const branches = manager.listBranches('template-1');\n      expect(branches).toContain('main');\n      expect(branches).toContain('feature');\n      expect(branches).toContain('bugfix');\n    });\n\n    it('should merge branch', () => {\n      manager.createBranch('template-1', 'feature');\n      const featureBranch = manager.getBranchVersion('template-1', 'feature');\n\n      // Simulate changes on branch\n      manager.createVersion(\n        'template-1',\n        { title: 'Feature' },\n        'user-2',\n        'Feature work',\n        ['feature']\n      );\n\n      const merged = manager.mergeBranch('template-1', 'feature', 'user-3', 'Merge feature');\n\n      expect(merged).toBeDefined();\n      expect(merged?.message).toContain('Merge branch');\n    });\n\n    it('should delete branch', () => {\n      manager.createBranch('template-1', 'feature');\n      const deleted = manager.deleteBranch('template-1', 'feature');\n\n      expect(deleted).toBe(true);\n      const branches = manager.listBranches('template-1');\n      expect(branches).not.toContain('feature');\n    });\n  });\n\n  describe('Locking', () => {\n    beforeEach(() => {\n      manager.createTemplate('template-1', { title: 'Test' }, 'user-1');\n    });\n\n    it('should lock template', () => {\n      const locked = manager.lockTemplate('template-1', 'user-2', 'Under review');\n      expect(locked).toBe(true);\n      expect(manager.isLocked('template-1')).toBe(true);\n    });\n\n    it('should prevent version creation when locked', () => {\n      manager.lockTemplate('template-1', 'user-2', 'Under review');\n\n      expect(() => {\n        manager.createVersion('template-1', { title: 'New' }, 'user-3', 'Update');\n      }).toThrow();\n    });\n\n    it('should unlock template', () => {\n      manager.lockTemplate('template-1', 'user-2', 'Under review');\n      const unlocked = manager.unlockTemplate('template-1');\n\n      expect(unlocked).toBe(true);\n      expect(manager.isLocked('template-1')).toBe(false);\n    });\n  });\n\n  describe('Statistics', () => {\n    beforeEach(() => {\n      manager.createTemplate('template-1', { title: 'V1' }, 'user-1');\n      manager.createVersion('template-1', { title: 'V2' }, 'user-2', 'Update');\n      manager.createVersion('template-1', { title: 'V3' }, 'user-1', 'Update');\n      manager.tagAsRelease('template-1', 2);\n    });\n\n    it('should get statistics', () => {\n      const stats = manager.getStatistics('template-1');\n\n      expect(stats).toBeDefined();\n      expect(stats?.totalVersions).toBe(3);\n      expect(stats?.releases).toBe(1);\n      expect(stats?.contributors.size).toBe(2);\n    });\n  });\n});\n\ndescribe('DataSourceMarketplace', () => {\n  let marketplace: DataSourceMarketplace;\n\n  beforeEach(() => {\n    marketplace = new DataSourceMarketplace();\n  });\n\n  describe('Source Management', () => {\n    it('should have default sources', () => {\n      const all = marketplace.searchSources('');\n      expect(all.length).toBeGreaterThan(0);\n    });\n\n    it('should get source by ID', () => {\n      const source = marketplace.getSource('weather-openweather');\n      expect(source).toBeDefined();\n      expect(source?.name).toBe('OpenWeather API');\n    });\n\n    it('should add custom source', () => {\n      const source = marketplace.addSource({\n        name: 'Custom API',\n        description: 'Custom data source',\n        category: 'custom',\n        type: 'api',\n        rating: 0,\n        downloads: 0,\n        author: 'user-1',\n        version: '1.0',\n        config: {},\n        isPremium: false,\n        isVerified: false,\n        createdAt: Date.now(),\n        updatedAt: Date.now(),\n      });\n\n      expect(source).toBeDefined();\n      expect(source.name).toBe('Custom API');\n    });\n  });\n\n  describe('Search and Filtering', () => {\n    it('should search by query', () => {\n      const results = marketplace.searchSources('weather');\n      expect(results.length).toBeGreaterThan(0);\n      expect(results[0].name).toContain('Weather');\n    });\n\n    it('should filter by category', () => {\n      const results = marketplace.getSourcesByCategory('weather');\n      expect(results.length).toBeGreaterThan(0);\n      expect(results.every((s) => s.category === 'weather')).toBe(true);\n    });\n\n    it('should get trending sources', () => {\n      const trending = marketplace.getTrendingSources(5);\n      expect(trending.length).toBeGreaterThan(0);\n    });\n\n    it('should get top rated sources', () => {\n      const topRated = marketplace.getTopRatedSources(5);\n      expect(topRated.length).toBeGreaterThan(0);\n      expect(topRated[0].rating).toBeGreaterThanOrEqual(topRated[1].rating);\n    });\n  });\n\n  describe('Installation', () => {\n    it('should install source', () => {\n      const installation = marketplace.installSource(\n        'weather-openweather',\n        'user-1',\n        'farm-1'\n      );\n\n      expect(installation).toBeDefined();\n      expect(installation?.isActive).toBe(true);\n    });\n\n    it('should get user installations', () => {\n      marketplace.installSource('weather-openweather', 'user-1', 'farm-1');\n      marketplace.installSource('market-usda', 'user-1', 'farm-1');\n\n      const installations = marketplace.getUserInstallations('user-1');\n      expect(installations).toHaveLength(2);\n    });\n\n    it('should uninstall source', () => {\n      const installation = marketplace.installSource(\n        'weather-openweather',\n        'user-1',\n        'farm-1'\n      );\n\n      const uninstalled = marketplace.uninstallSource(installation!.id, 'user-1');\n      expect(uninstalled).toBe(true);\n\n      const remaining = marketplace.getUserInstallations('user-1');\n      expect(remaining).toHaveLength(0);\n    });\n  });\n\n  describe('Reviews', () => {\n    it('should add review', () => {\n      const review = marketplace.addReview(\n        'weather-openweather',\n        'user-1',\n        5,\n        'Great service!'\n      );\n\n      expect(review).toBeDefined();\n      expect(review?.rating).toBe(5);\n    });\n\n    it('should get reviews', () => {\n      marketplace.addReview('weather-openweather', 'user-1', 5, 'Great!');\n      marketplace.addReview('weather-openweather', 'user-2', 4, 'Good');\n\n      const reviews = marketplace.getReviews('weather-openweather');\n      expect(reviews.length).toBeGreaterThanOrEqual(2);\n    });\n\n    it('should update source rating', () => {\n      const source = marketplace.getSource('weather-openweather');\n      const originalRating = source?.rating || 0;\n\n      marketplace.addReview('weather-openweather', 'user-1', 1, 'Bad');\n\n      const updated = marketplace.getSource('weather-openweather');\n      expect(updated?.rating).toBeLessThan(originalRating);\n    });\n  });\n\n  describe('Favorites', () => {\n    it('should add to favorites', () => {\n      const added = marketplace.addToFavorites('user-1', 'weather-openweather');\n      expect(added).toBe(true);\n    });\n\n    it('should get favorites', () => {\n      marketplace.addToFavorites('user-1', 'weather-openweather');\n      marketplace.addToFavorites('user-1', 'market-usda');\n\n      const favorites = marketplace.getFavorites('user-1');\n      expect(favorites).toHaveLength(2);\n    });\n\n    it('should remove from favorites', () => {\n      marketplace.addToFavorites('user-1', 'weather-openweather');\n      const removed = marketplace.removeFromFavorites('user-1', 'weather-openweather');\n\n      expect(removed).toBe(true);\n      const favorites = marketplace.getFavorites('user-1');\n      expect(favorites).toHaveLength(0);\n    });\n  });\n\n  describe('Statistics', () => {\n    it('should get marketplace statistics', () => {\n      const stats = marketplace.getStatistics();\n\n      expect(stats).toBeDefined();\n      expect(stats.totalSources).toBeGreaterThan(0);\n      expect(stats.verifiedSources).toBeGreaterThan(0);\n      expect(stats.totalDownloads).toBeGreaterThanOrEqual(0);\n      expect(stats.averageRating).toBeGreaterThan(0);\n    });\n  });\n\n  describe('Events', () => {\n    it('should emit source:installed event', () => {\n      const listener = vi.fn();\n      marketplace.on('source:installed', listener);\n\n      marketplace.installSource('weather-openweather', 'user-1', 'farm-1');\n\n      expect(listener).toHaveBeenCalled();\n    });\n\n    it('should emit review:added event', () => {\n      const listener = vi.fn();\n      marketplace.on('review:added', listener);\n\n      marketplace.addReview('weather-openweather', 'user-1', 5, 'Great!');\n\n      expect(listener).toHaveBeenCalled();\n    });\n  });\n});\n
