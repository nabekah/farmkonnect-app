import { describe, it, expect, beforeEach } from 'vitest';\nimport { FinancialConsolidationDashboard } from './financial-consolidation';\nimport { SupplierManager } from './supplier';\n\n/**\n * Financial Consolidation Dashboard Tests\n */\ndescribe('Financial Consolidation Dashboard', () => {\n  let dashboard: FinancialConsolidationDashboard;\n\n  beforeEach(() => {\n    dashboard = new FinancialConsolidationDashboard();\n  });\n\n  it('should create consolidated metrics', () => {\n    const metrics = dashboard.createConsolidatedMetrics(\n      'farm-1',\n      100000,\n      20000,\n      30000,\n      15000,\n      10000,\n      5000,\n      Date.now() - 86400000,\n      Date.now()\n    );\n\n    expect(metrics).not.toBeNull();\n    expect(metrics.totalRevenue).toBe(100000);\n    expect(metrics.totalExpenses).toBe(80000);\n    expect(metrics.netProfit).toBe(20000);\n    expect(metrics.profitMargin).toBe(20);\n    expect(metrics.roi).toBe(25);\n  });\n\n  it('should create cost breakdown', () => {\n    const breakdown = dashboard.createCostBreakdown(20000, 30000, 15000, 10000, 5000, 3000, 2000, 5000);\n\n    expect(breakdown).not.toBeNull();\n    expect(breakdown.total).toBe(90000);\n    expect(breakdown.labor).toBe(30000);\n    expect(breakdown.equipment).toBe(20000);\n  });\n\n  it('should calculate revenue sources', () => {\n    const sources = dashboard.calculateRevenueSources(30000, 25000, 20000, 15000, 10000, 0);\n\n    expect(sources).not.toBeNull();\n    expect(sources.length).toBe(5);\n    expect(sources[0].source).toBe('Wheat');\n    expect(sources[0].percentage).toBeCloseTo(30, 1);\n  });\n\n  it('should generate KPIs', () => {\n    const metrics = dashboard.createConsolidatedMetrics(\n      'farm-1',\n      100000,\n      20000,\n      30000,\n      15000,\n      10000,\n      5000,\n      Date.now() - 86400000,\n      Date.now()\n    );\n\n    const kpis = dashboard.generateKPIs(metrics);\n\n    expect(kpis).not.toBeNull();\n    expect(kpis.length).toBe(4);\n    expect(kpis[0].name).toBe('Profit Margin');\n    expect(kpis[0].value).toBe(20);\n  });\n\n  it('should create financial snapshot', () => {\n    const metrics = dashboard.createConsolidatedMetrics(\n      'farm-1',\n      100000,\n      20000,\n      30000,\n      15000,\n      10000,\n      5000,\n      Date.now() - 86400000,\n      Date.now()\n    );\n    const breakdown = dashboard.createCostBreakdown(20000, 30000, 15000, 10000, 5000, 3000, 2000, 5000);\n    const sources = dashboard.calculateRevenueSources(30000, 25000, 20000, 15000, 10000, 0);\n    const kpis = dashboard.generateKPIs(metrics);\n\n    const snapshot = dashboard.createFinancialSnapshot('farm-1', metrics, breakdown, sources, kpis);\n\n    expect(snapshot).not.toBeNull();\n    expect(snapshot.farmId).toBe('farm-1');\n    expect(snapshot.alerts.length).toBeGreaterThanOrEqual(0);\n  });\n\n  it('should get financial snapshot', () => {\n    const metrics = dashboard.createConsolidatedMetrics(\n      'farm-1',\n      100000,\n      20000,\n      30000,\n      15000,\n      10000,\n      5000,\n      Date.now() - 86400000,\n      Date.now()\n    );\n    const breakdown = dashboard.createCostBreakdown(20000, 30000, 15000, 10000, 5000, 3000, 2000, 5000);\n    const sources = dashboard.calculateRevenueSources(30000, 25000, 20000, 15000, 10000, 0);\n    const kpis = dashboard.generateKPIs(metrics);\n\n    const snapshot = dashboard.createFinancialSnapshot('farm-1', metrics, breakdown, sources, kpis);\n    const retrieved = dashboard.getFinancialSnapshot(snapshot.id);\n\n    expect(retrieved).not.toBeNull();\n    expect(retrieved?.id).toBe(snapshot.id);\n  });\n\n  it('should record financial trend', () => {\n    const trend = dashboard.recordFinancialTrend('farm-1', 'Q1 2026', 100000, 80000, 20000);\n\n    expect(trend).not.toBeNull();\n    expect(trend.period).toBe('Q1 2026');\n    expect(trend.profitMargin).toBe(20);\n  });\n\n  it('should get financial trends', () => {\n    dashboard.recordFinancialTrend('farm-1', 'Q1 2026', 100000, 80000, 20000);\n    dashboard.recordFinancialTrend('farm-1', 'Q2 2026', 110000, 85000, 25000);\n\n    const trends = dashboard.getFinancialTrends('farm-1');\n    expect(trends.length).toBe(2);\n  });\n\n  it('should compare periods', () => {\n    dashboard.recordFinancialTrend('farm-1', 'Q1 2026', 100000, 80000, 20000);\n    dashboard.recordFinancialTrend('farm-1', 'Q2 2026', 110000, 85000, 25000);\n\n    const comparison = dashboard.comparePeriods('farm-1', 'Q1 2026', 'Q2 2026');\n\n    expect(comparison.period1).not.toBeNull();\n    expect(comparison.period2).not.toBeNull();\n    expect(comparison.comparison.revenueChange).toBeCloseTo(10, 0);\n  });\n});\n\n/**\n * Supplier Manager Tests\n */\ndescribe('Supplier Manager', () => {\n  let manager: SupplierManager;\n\n  beforeEach(() => {\n    manager = new SupplierManager();\n  });\n\n  it('should add supplier', () => {\n    const supplier = manager.addSupplier(\n      'farm-1',\n      'Seed Company A',\n      'seeds',\n      'John Doe',\n      'john@seedco.com',\n      '555-1234',\n      '123 Main St',\n      'Springfield',\n      'IL',\n      '62701',\n      'USA'\n    );\n\n    expect(supplier).not.toBeNull();\n    expect(supplier.name).toBe('Seed Company A');\n    expect(supplier.status).toBe('active');\n  });\n\n  it('should get supplier', () => {\n    const added = manager.addSupplier(\n      'farm-1',\n      'Seed Company A',\n      'seeds',\n      'John Doe',\n      'john@seedco.com',\n      '555-1234',\n      '123 Main St',\n      'Springfield',\n      'IL',\n      '62701',\n      'USA'\n    );\n\n    const retrieved = manager.getSupplier(added.id);\n    expect(retrieved).not.toBeNull();\n    expect(retrieved?.name).toBe('Seed Company A');\n  });\n\n  it('should get suppliers by farm', () => {\n    manager.addSupplier(\n      'farm-1',\n      'Seed Company A',\n      'seeds',\n      'John Doe',\n      'john@seedco.com',\n      '555-1234',\n      '123 Main St',\n      'Springfield',\n      'IL',\n      '62701',\n      'USA'\n    );\n    manager.addSupplier(\n      'farm-1',\n      'Fertilizer Co',\n      'fertilizer',\n      'Jane Smith',\n      'jane@fertco.com',\n      '555-5678',\n      '456 Oak Ave',\n      'Chicago',\n      'IL',\n      '60601',\n      'USA'\n    );\n\n    const suppliers = manager.getSuppliersByFarm('farm-1');\n    expect(suppliers.length).toBe(2);\n  });\n\n  it('should update supplier rating', () => {\n    const supplier = manager.addSupplier(\n      'farm-1',\n      'Seed Company A',\n      'seeds',\n      'John Doe',\n      'john@seedco.com',\n      '555-1234',\n      '123 Main St',\n      'Springfield',\n      'IL',\n      '62701',\n      'USA'\n    );\n\n    const updated = manager.updateSupplierRating(supplier.id, 4.5);\n    expect(updated?.rating).toBe(4.5);\n  });\n\n  it('should record pricing history', () => {\n    const supplier = manager.addSupplier(\n      'farm-1',\n      'Seed Company A',\n      'seeds',\n      'John Doe',\n      'john@seedco.com',\n      '555-1234',\n      '123 Main St',\n      'Springfield',\n      'IL',\n      '62701',\n      'USA'\n    );\n\n    const pricing = manager.recordPricingHistory(supplier.id, 'Wheat Seeds', 50, 100, 'kg', 'Bulk discount');\n\n    expect(pricing).not.toBeNull();\n    expect(pricing.price).toBe(50);\n    expect(pricing.productName).toBe('Wheat Seeds');\n  });\n\n  it('should create order', () => {\n    const supplier = manager.addSupplier(\n      'farm-1',\n      'Seed Company A',\n      'seeds',\n      'John Doe',\n      'john@seedco.com',\n      '555-1234',\n      '123 Main St',\n      'Springfield',\n      'IL',\n      '62701',\n      'USA'\n    );\n\n    const order = manager.createOrder(\n      supplier.id,\n      'farm-1',\n      [\n        { productName: 'Wheat Seeds', quantity: 100, unit: 'kg', unitPrice: 50 },\n        { productName: 'Corn Seeds', quantity: 50, unit: 'kg', unitPrice: 60 },\n      ],\n      7,\n      'Urgent delivery needed'\n    );\n\n    expect(order).not.toBeNull();\n    expect(order.totalAmount).toBe(8000);\n    expect(order.status).toBe('pending');\n  });\n\n  it('should update order status', () => {\n    const supplier = manager.addSupplier(\n      'farm-1',\n      'Seed Company A',\n      'seeds',\n      'John Doe',\n      'john@seedco.com',\n      '555-1234',\n      '123 Main St',\n      'Springfield',\n      'IL',\n      '62701',\n      'USA'\n    );\n\n    const order = manager.createOrder(\n      supplier.id,\n      'farm-1',\n      [{ productName: 'Wheat Seeds', quantity: 100, unit: 'kg', unitPrice: 50 }],\n      7\n    );\n\n    const updated = manager.updateOrderStatus(order.id, 'delivered');\n    expect(updated?.status).toBe('delivered');\n    expect(updated?.actualDeliveryDate).not.toBeUndefined();\n  });\n\n  it('should calculate supplier performance', () => {\n    const supplier = manager.addSupplier(\n      'farm-1',\n      'Seed Company A',\n      'seeds',\n      'John Doe',\n      'john@seedco.com',\n      '555-1234',\n      '123 Main St',\n      'Springfield',\n      'IL',\n      '62701',\n      'USA'\n    );\n\n    manager.createOrder(\n      supplier.id,\n      'farm-1',\n      [{ productName: 'Wheat Seeds', quantity: 100, unit: 'kg', unitPrice: 50 }],\n      7\n    );\n\n    const performance = manager.calculateSupplierPerformance(supplier.id);\n\n    expect(performance).not.toBeNull();\n    expect(performance.totalOrders).toBe(1);\n    expect(performance.overallScore).toBeGreaterThanOrEqual(0);\n  });\n\n  it('should compare suppliers', () => {\n    const supplier1 = manager.addSupplier(\n      'farm-1',\n      'Seed Company A',\n      'seeds',\n      'John Doe',\n      'john@seedco.com',\n      '555-1234',\n      '123 Main St',\n      'Springfield',\n      'IL',\n      '62701',\n      'USA'\n    );\n\n    const supplier2 = manager.addSupplier(\n      'farm-1',\n      'Seed Company B',\n      'seeds',\n      'Jane Smith',\n      'jane@seedco.com',\n      '555-5678',\n      '456 Oak Ave',\n      'Chicago',\n      'IL',\n      '60601',\n      'USA'\n    );\n\n    manager.recordPricingHistory(supplier1.id, 'Wheat Seeds', 50, 100, 'kg');\n    manager.recordPricingHistory(supplier2.id, 'Wheat Seeds', 45, 100, 'kg');\n\n    const comparison = manager.compareSuppliers('farm-1', 'Wheat Seeds');\n\n    expect(comparison).not.toBeNull();\n    expect(comparison.suppliers.length).toBe(2);\n    expect(comparison.bestPrice.price).toBe(45);\n  });\n});\n\n/**\n * Integration Tests\n */\ndescribe('Integration Tests', () => {\n  it('should work with Financial and Supplier systems together', () => {\n    const financial = new FinancialConsolidationDashboard();\n    const supplier = new SupplierManager();\n\n    // Create supplier\n    const supplierRecord = supplier.addSupplier(\n      'farm-1',\n      'Seed Company A',\n      'seeds',\n      'John Doe',\n      'john@seedco.com',\n      '555-1234',\n      '123 Main St',\n      'Springfield',\n      'IL',\n      '62701',\n      'USA'\n    );\n\n    // Create order\n    const order = supplier.createOrder(\n      supplierRecord.id,\n      'farm-1',\n      [{ productName: 'Wheat Seeds', quantity: 100, unit: 'kg', unitPrice: 50 }],\n      7\n    );\n\n    // Create financial metrics including supplier costs\n    const metrics = financial.createConsolidatedMetrics(\n      'farm-1',\n      100000,\n      20000,\n      30000,\n      order.totalAmount,\n      10000,\n      5000,\n      Date.now() - 86400000,\n      Date.now()\n    );\n\n    // Verify integration\n    expect(metrics.totalExpenses).toBe(20000 + 30000 + order.totalAmount + 10000 + 5000);\n    expect(metrics.netProfit).toBe(100000 - metrics.totalExpenses);\n  });\n});\n
