import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';\nimport { WebhookEventHandler, WebhookEventType } from './webhook-handlers';\nimport { WidgetDataSourceManager, DataSourceType } from './widget-datasources';\n\ndescribe('WebhookEventHandler', () => {\n  let webhookHandler: WebhookEventHandler;\n\n  beforeEach(() => {\n    webhookHandler = new WebhookEventHandler();\n  });\n\n  afterEach(() => {\n    webhookHandler.destroy();\n  });\n\n  describe('Subscription Management', () => {\n    it('should subscribe to webhook events', () => {\n      const subscription = webhookHandler.subscribe(\n        'https://example.com/webhook',\n        ['report.generated', 'report.sent']\n      );\n\n      expect(subscription.id).toBeDefined();\n      expect(subscription.url).toBe('https://example.com/webhook');\n      expect(subscription.events).toContain('report.generated');\n      expect(subscription.active).toBe(true);\n    });\n\n    it('should unsubscribe from webhook events', () => {\n      const subscription = webhookHandler.subscribe(\n        'https://example.com/webhook',\n        ['report.generated']\n      );\n\n      const result = webhookHandler.unsubscribe(subscription.id);\n      expect(result).toBe(true);\n\n      const retrieved = webhookHandler.getSubscription(subscription.id);\n      expect(retrieved).toBeUndefined();\n    });\n\n    it('should update subscription configuration', () => {\n      const subscription = webhookHandler.subscribe(\n        'https://example.com/webhook',\n        ['report.generated']\n      );\n\n      const updated = webhookHandler.updateSubscription(subscription.id, {\n        events: ['report.generated', 'report.sent'],\n        active: false,\n      });\n\n      expect(updated?.events).toContain('report.sent');\n      expect(updated?.active).toBe(false);\n    });\n\n    it('should get all subscriptions', () => {\n      webhookHandler.subscribe('https://example.com/webhook1', ['report.generated']);\n      webhookHandler.subscribe('https://example.com/webhook2', ['widget.created']);\n\n      const subscriptions = webhookHandler.getAllSubscriptions();\n      expect(subscriptions).toHaveLength(2);\n    });\n\n    it('should get subscriptions by event', () => {\n      webhookHandler.subscribe('https://example.com/webhook1', ['report.generated']);\n      webhookHandler.subscribe('https://example.com/webhook2', ['report.generated', 'widget.created']);\n\n      const subscriptions = webhookHandler.getSubscriptionsByEvent('report.generated');\n      expect(subscriptions).toHaveLength(2);\n    });\n  });\n\n  describe('Event Emission', () => {\n    it('should emit report generated event', async () => {\n      const listener = vi.fn();\n      webhookHandler.on('event:emitted', listener);\n\n      webhookHandler.subscribe('https://example.com/webhook', ['report.generated']);\n      await webhookHandler.emitReportGenerated('report-123', 'financial', { data: 'test' });\n\n      expect(listener).toHaveBeenCalled();\n    });\n\n    it('should emit widget created event', async () => {\n      const listener = vi.fn();\n      webhookHandler.on('event:emitted', listener);\n\n      webhookHandler.subscribe('https://example.com/webhook', ['widget.created']);\n      await webhookHandler.emitWidgetCreated('widget-123', 'chart', { type: 'bar' });\n\n      expect(listener).toHaveBeenCalled();\n    });\n\n    it('should only emit to matching subscriptions', async () => {\n      const listener = vi.fn();\n      webhookHandler.on('event:emitted', listener);\n\n      webhookHandler.subscribe('https://example.com/webhook1', ['report.generated']);\n      webhookHandler.subscribe('https://example.com/webhook2', ['widget.created']);\n\n      await webhookHandler.emitReportGenerated('report-123', 'financial', {});\n\n      const call = listener.mock.calls[0][0];\n      expect(call.subscriptionCount).toBe(1);\n    });\n  });\n\n  describe('Delivery Management', () => {\n    it('should track delivery attempts', async () => {\n      webhookHandler.subscribe('https://example.com/webhook', ['report.generated']);\n      await webhookHandler.emitReportGenerated('report-123', 'financial', {});\n\n      const deliveries = webhookHandler.getAllDeliveries();\n      expect(deliveries.length).toBeGreaterThan(0);\n    });\n\n    it('should retry failed deliveries', async () => {\n      webhookHandler.subscribe('https://example.com/webhook', ['report.generated'], {\n        maxRetries: 3,\n        initialDelay: 100,\n      });\n\n      await webhookHandler.emitReportGenerated('report-123', 'financial', {});\n\n      const deliveries = webhookHandler.getAllDeliveries();\n      expect(deliveries[0]?.retryPolicy.maxRetries).toBe(3);\n    });\n  });\n\n  describe('Statistics', () => {\n    it('should calculate webhook statistics', async () => {\n      webhookHandler.subscribe('https://example.com/webhook1', ['report.generated']);\n      webhookHandler.subscribe('https://example.com/webhook2', ['widget.created']);\n\n      const stats = webhookHandler.getStatistics();\n      expect(stats.totalSubscriptions).toBe(2);\n      expect(stats.activeSubscriptions).toBe(2);\n    });\n  });\n});\n\ndescribe('WidgetDataSourceManager', () => {\n  let dataSourceManager: WidgetDataSourceManager;\n\n  beforeEach(() => {\n    dataSourceManager = new WidgetDataSourceManager();\n  });\n\n  afterEach(() => {\n    dataSourceManager.destroy();\n  });\n\n  describe('Data Source Registration', () => {\n    it('should register API data source', () => {\n      const source = dataSourceManager.registerDataSource({\n        name: 'Farm API',\n        type: 'api',\n        endpoint: 'https://api.example.com/farms',\n        refreshMode: 'interval',\n        refreshInterval: 5000,\n        cacheEnabled: true,\n        cacheTTL: 10000,\n        errorHandling: {\n          retryOnFailure: true,\n          maxRetries: 3,\n        },\n      });\n\n      expect(source.id).toBeDefined();\n      expect(source.type).toBe('api');\n      expect(source.endpoint).toBe('https://api.example.com/farms');\n    });\n\n    it('should register database data source', () => {\n      const source = dataSourceManager.registerDataSource({\n        name: 'Farm DB',\n        type: 'database',\n        query: 'SELECT * FROM farms',\n        refreshMode: 'manual',\n        cacheEnabled: false,\n        errorHandling: {\n          retryOnFailure: false,\n          maxRetries: 0,\n        },\n      });\n\n      expect(source.type).toBe('database');\n      expect(source.query).toBe('SELECT * FROM farms');\n    });\n\n    it('should update data source', () => {\n      const source = dataSourceManager.registerDataSource({\n        name: 'Farm API',\n        type: 'api',\n        endpoint: 'https://api.example.com/farms',\n        refreshMode: 'manual',\n        cacheEnabled: true,\n        cacheTTL: 5000,\n        errorHandling: {\n          retryOnFailure: true,\n          maxRetries: 3,\n        },\n      });\n\n      const updated = dataSourceManager.updateDataSource(source.id, {\n        refreshMode: 'interval',\n        refreshInterval: 10000,\n      });\n\n      expect(updated?.refreshMode).toBe('interval');\n      expect(updated?.refreshInterval).toBe(10000);\n    });\n\n    it('should remove data source', () => {\n      const source = dataSourceManager.registerDataSource({\n        name: 'Farm API',\n        type: 'api',\n        endpoint: 'https://api.example.com/farms',\n        refreshMode: 'manual',\n        cacheEnabled: true,\n        cacheTTL: 5000,\n        errorHandling: {\n          retryOnFailure: true,\n          maxRetries: 3,\n        },\n      });\n\n      const result = dataSourceManager.removeDataSource(source.id);\n      expect(result).toBe(true);\n\n      const retrieved = dataSourceManager.getDataSource(source.id);\n      expect(retrieved).toBeUndefined();\n    });\n  });\n\n  describe('Data Fetching', () => {\n    it('should fetch data from source', async () => {\n      const source = dataSourceManager.registerDataSource({\n        name: 'Farm API',\n        type: 'api',\n        endpoint: 'https://api.example.com/farms',\n        refreshMode: 'manual',\n        cacheEnabled: true,\n        cacheTTL: 5000,\n        errorHandling: {\n          retryOnFailure: true,\n          maxRetries: 3,\n        },\n      });\n\n      const data = await dataSourceManager.fetchData(source.id);\n      expect(data.id).toBeDefined();\n      expect(data.sourceId).toBe(source.id);\n      expect(data.status).toBe('success');\n    });\n\n    it('should cache fetched data', async () => {\n      const source = dataSourceManager.registerDataSource({\n        name: 'Farm API',\n        type: 'api',\n        endpoint: 'https://api.example.com/farms',\n        refreshMode: 'manual',\n        cacheEnabled: true,\n        cacheTTL: 5000,\n        errorHandling: {\n          retryOnFailure: true,\n          maxRetries: 3,\n        },\n      });\n\n      await dataSourceManager.fetchData(source.id);\n      const cachedData = await dataSourceManager.fetchData(source.id);\n\n      expect(cachedData.cacheHit).toBe(true);\n    });\n\n    it('should force refresh bypassing cache', async () => {\n      const source = dataSourceManager.registerDataSource({\n        name: 'Farm API',\n        type: 'api',\n        endpoint: 'https://api.example.com/farms',\n        refreshMode: 'manual',\n        cacheEnabled: true,\n        cacheTTL: 5000,\n        errorHandling: {\n          retryOnFailure: true,\n          maxRetries: 3,\n        },\n      });\n\n      await dataSourceManager.fetchData(source.id);\n      const refreshedData = await dataSourceManager.fetchData(source.id, true);\n\n      expect(refreshedData.cacheHit).toBe(false);\n    });\n  });\n\n  describe('Widget Binding', () => {\n    it('should bind widget to data source', () => {\n      const source = dataSourceManager.registerDataSource({\n        name: 'Farm API',\n        type: 'api',\n        endpoint: 'https://api.example.com/farms',\n        refreshMode: 'manual',\n        cacheEnabled: true,\n        cacheTTL: 5000,\n        errorHandling: {\n          retryOnFailure: true,\n          maxRetries: 3,\n        },\n      });\n\n      const binding = dataSourceManager.bindWidgetToSource(\n        'widget-123',\n        source.id,\n        {\n          'farmName': 'name',\n          'farmArea': 'area',\n        },\n        true\n      );\n\n      expect(binding.widgetId).toBe('widget-123');\n      expect(binding.sourceId).toBe(source.id);\n      expect(binding.fieldMappings['farmName']).toBe('name');\n    });\n\n    it('should retrieve widget binding', () => {\n      const source = dataSourceManager.registerDataSource({\n        name: 'Farm API',\n        type: 'api',\n        endpoint: 'https://api.example.com/farms',\n        refreshMode: 'manual',\n        cacheEnabled: true,\n        cacheTTL: 5000,\n        errorHandling: {\n          retryOnFailure: true,\n          maxRetries: 3,\n        },\n      });\n\n      dataSourceManager.bindWidgetToSource(\n        'widget-123',\n        source.id,\n        { 'farmName': 'name' },\n        true\n      );\n\n      const binding = dataSourceManager.getBinding('widget-123');\n      expect(binding?.widgetId).toBe('widget-123');\n    });\n  });\n\n  describe('Statistics', () => {\n    it('should calculate data source statistics', () => {\n      dataSourceManager.registerDataSource({\n        name: 'Farm API',\n        type: 'api',\n        endpoint: 'https://api.example.com/farms',\n        refreshMode: 'manual',\n        cacheEnabled: true,\n        cacheTTL: 5000,\n        errorHandling: {\n          retryOnFailure: true,\n          maxRetries: 3,\n        },\n      });\n\n      dataSourceManager.registerDataSource({\n        name: 'Farm DB',\n        type: 'database',\n        query: 'SELECT * FROM farms',\n        refreshMode: 'manual',\n        cacheEnabled: false,\n        errorHandling: {\n          retryOnFailure: false,\n          maxRetries: 0,\n        },\n      });\n\n      const stats = dataSourceManager.getStatistics();\n      expect(stats.totalSources).toBe(2);\n      expect(stats.sourcesByType.api).toBe(1);\n      expect(stats.sourcesByType.database).toBe(1);\n    });\n  });\n});\n\ndescribe('Integration Tests', () => {\n  let webhookHandler: WebhookEventHandler;\n  let dataSourceManager: WidgetDataSourceManager;\n\n  beforeEach(() => {\n    webhookHandler = new WebhookEventHandler();\n    dataSourceManager = new WidgetDataSourceManager();\n  });\n\n  afterEach(() => {\n    webhookHandler.destroy();\n    dataSourceManager.destroy();\n  });\n\n  it('should emit webhook when data source is updated', async () => {\n    const listener = vi.fn();\n    webhookHandler.on('event:emitted', listener);\n\n    webhookHandler.subscribe('https://example.com/webhook', ['widget.data_updated']);\n\n    const source = dataSourceManager.registerDataSource({\n      name: 'Farm API',\n      type: 'api',\n      endpoint: 'https://api.example.com/farms',\n      refreshMode: 'manual',\n      cacheEnabled: true,\n      cacheTTL: 5000,\n      errorHandling: {\n        retryOnFailure: true,\n        maxRetries: 3,\n      },\n    });\n\n    const data = await dataSourceManager.fetchData(source.id);\n    await webhookHandler.emitWidgetDataUpdated('widget-123', data.data);\n\n    expect(listener).toHaveBeenCalled();\n  });\n\n  it('should handle complete workflow', async () => {\n    // Register data source\n    const source = dataSourceManager.registerDataSource({\n      name: 'Farm API',\n      type: 'api',\n      endpoint: 'https://api.example.com/farms',\n      refreshMode: 'manual',\n      cacheEnabled: true,\n      cacheTTL: 5000,\n      errorHandling: {\n        retryOnFailure: true,\n        maxRetries: 3,\n      },\n    });\n\n    // Bind widget\n    const binding = dataSourceManager.bindWidgetToSource(\n      'widget-123',\n      source.id,\n      { 'farmName': 'name' },\n      true\n    );\n\n    // Subscribe to webhooks\n    const subscription = webhookHandler.subscribe(\n      'https://example.com/webhook',\n      ['widget.data_updated']\n    );\n\n    // Fetch data\n    const data = await dataSourceManager.fetchData(source.id);\n\n    // Emit webhook\n    await webhookHandler.emitWidgetDataUpdated('widget-123', data.data);\n\n    // Verify\n    expect(binding).toBeDefined();\n    expect(subscription).toBeDefined();\n    expect(data.status).toBe('success');\n  });\n});\n
