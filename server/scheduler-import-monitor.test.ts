import { describe, it, expect, beforeEach, afterEach } from 'vitest';\nimport CampaignScheduler from './campaign-scheduler';\nimport RecipientImportExport from './recipient-import-export';\n\ndescribe('CampaignScheduler', () => {\n  let scheduler: CampaignScheduler;\n\n  beforeEach(() => {\n    scheduler = new CampaignScheduler();\n  });\n\n  afterEach(() => {\n    scheduler.destroy();\n  });\n\n  describe('Schedule Management', () => {\n    it('should create schedule', () => {\n      const schedule = scheduler.createSchedule('camp-1', {\n        frequency: 'once',\n        time: '14:30',\n        timezone: 'America/New_York',\n      });\n\n      expect(schedule).toBeDefined();\n      expect(schedule.campaignId).toBe('camp-1');\n      expect(schedule.status).toBe('active');\n    });\n\n    it('should get schedule', () => {\n      const created = scheduler.createSchedule('camp-1', {\n        frequency: 'daily',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      const retrieved = scheduler.getSchedule(created.id);\n      expect(retrieved?.campaignId).toBe('camp-1');\n    });\n\n    it('should get schedules for campaign', () => {\n      scheduler.createSchedule('camp-1', {\n        frequency: 'daily',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n      scheduler.createSchedule('camp-1', {\n        frequency: 'weekly',\n        time: '14:00',\n        timezone: 'UTC',\n      });\n      scheduler.createSchedule('camp-2', {\n        frequency: 'once',\n        time: '10:00',\n        timezone: 'UTC',\n      });\n\n      const schedules = scheduler.getSchedulesForCampaign('camp-1');\n      expect(schedules.length).toBe(2);\n    });\n\n    it('should update schedule', () => {\n      const schedule = scheduler.createSchedule('camp-1', {\n        frequency: 'daily',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      const updated = scheduler.updateSchedule(schedule.id, {\n        scheduleRule: { ...schedule.scheduleRule, time: '10:00' },\n      });\n\n      expect(updated).toBe(true);\n      const retrieved = scheduler.getSchedule(schedule.id);\n      expect(retrieved?.scheduleRule.time).toBe('10:00');\n    });\n\n    it('should pause schedule', () => {\n      const schedule = scheduler.createSchedule('camp-1', {\n        frequency: 'daily',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      const paused = scheduler.pauseSchedule(schedule.id);\n      expect(paused).toBe(true);\n\n      const retrieved = scheduler.getSchedule(schedule.id);\n      expect(retrieved?.status).toBe('paused');\n    });\n\n    it('should resume schedule', () => {\n      const schedule = scheduler.createSchedule('camp-1', {\n        frequency: 'daily',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      scheduler.pauseSchedule(schedule.id);\n      const resumed = scheduler.resumeSchedule(schedule.id);\n\n      expect(resumed).toBe(true);\n      const retrieved = scheduler.getSchedule(schedule.id);\n      expect(retrieved?.status).toBe('active');\n    });\n\n    it('should delete schedule', () => {\n      const schedule = scheduler.createSchedule('camp-1', {\n        frequency: 'once',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      const deleted = scheduler.deleteSchedule(schedule.id);\n      expect(deleted).toBe(true);\n\n      const retrieved = scheduler.getSchedule(schedule.id);\n      expect(retrieved).toBeUndefined();\n    });\n  });\n\n  describe('Send Time Optimization', () => {\n    it('should calculate optimal send times', () => {\n      const schedule = scheduler.createSchedule('camp-1', {\n        frequency: 'daily',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      const recipients = [\n        { id: 'user-1', email: 'user1@example.com' },\n        { id: 'user-2', email: 'user2@example.com' },\n      ];\n\n      // Record some engagement\n      scheduler.recordEngagement('user-1', 5, 2);\n      scheduler.recordEngagement('user-1', 3, 1);\n\n      const optimalTimes = scheduler.calculateOptimalSendTimes(schedule.id, recipients);\n      expect(optimalTimes.length).toBe(2);\n    });\n\n    it('should record engagement', () => {\n      scheduler.recordEngagement('user-1', 10, 5);\n      scheduler.recordEngagement('user-1', 8, 3);\n\n      // Just verify it doesn't throw\n      expect(true).toBe(true);\n    });\n  });\n\n  describe('Scheduled Sends', () => {\n    it('should create scheduled send', () => {\n      const schedule = scheduler.createSchedule('camp-1', {\n        frequency: 'once',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      const send = scheduler.createScheduledSend(schedule.id, 'camp-1', 1000);\n      expect(send).toBeDefined();\n      expect(send.status).toBe('pending');\n      expect(send.recipientCount).toBe(1000);\n    });\n\n    it('should get scheduled send', () => {\n      const schedule = scheduler.createSchedule('camp-1', {\n        frequency: 'once',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      const created = scheduler.createScheduledSend(schedule.id, 'camp-1', 500);\n      const retrieved = scheduler.getScheduledSend(created.id);\n\n      expect(retrieved?.recipientCount).toBe(500);\n    });\n\n    it('should update scheduled send', () => {\n      const schedule = scheduler.createSchedule('camp-1', {\n        frequency: 'once',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      const send = scheduler.createScheduledSend(schedule.id, 'camp-1', 1000);\n      const updated = scheduler.updateScheduledSend(send.id, {\n        status: 'processing',\n        sentCount: 100,\n      });\n\n      expect(updated).toBe(true);\n      const retrieved = scheduler.getScheduledSend(send.id);\n      expect(retrieved?.status).toBe('processing');\n    });\n\n    it('should get pending sends', () => {\n      const schedule = scheduler.createSchedule('camp-1', {\n        frequency: 'once',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      scheduler.createScheduledSend(schedule.id, 'camp-1', 500);\n      scheduler.createScheduledSend(schedule.id, 'camp-1', 300);\n\n      const pending = scheduler.getPendingSends();\n      expect(pending.length).toBeGreaterThanOrEqual(2);\n    });\n  });\n\n  describe('Conflict Detection', () => {\n    it('should detect schedule conflicts', () => {\n      const schedule1 = scheduler.createSchedule('camp-1', {\n        frequency: 'once',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      const schedule2 = scheduler.createSchedule('camp-2', {\n        frequency: 'once',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      const conflicts = scheduler.checkConflicts(schedule1.id);\n      // Conflicts may or may not exist depending on timing\n      expect(Array.isArray(conflicts)).toBe(true);\n    });\n  });\n\n  describe('Statistics', () => {\n    it('should get schedule statistics', () => {\n      const schedule = scheduler.createSchedule('camp-1', {\n        frequency: 'daily',\n        time: '09:00',\n        timezone: 'UTC',\n      });\n\n      scheduler.createScheduledSend(schedule.id, 'camp-1', 1000);\n\n      const stats = scheduler.getScheduleStatistics(schedule.id);\n      expect(stats).toBeDefined();\n      expect(stats?.totalSends).toBeGreaterThanOrEqual(1);\n    });\n  });\n});\n\ndescribe('RecipientImportExport', () => {\n  let importer: RecipientImportExport;\n\n  beforeEach(() => {\n    importer = new RecipientImportExport();\n  });\n\n  afterEach(() => {\n    importer.destroy();\n  });\n\n  describe('Import Jobs', () => {\n    it('should create import job', () => {\n      const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', [\n        {\n          csvColumn: 'Email',\n          recipientField: 'email',\n          dataType: 'email',\n          required: true,\n        },\n      ]);\n\n      expect(job).toBeDefined();\n      expect(job.status).toBe('pending');\n      expect(job.fileName).toBe('recipients.csv');\n    });\n\n    it('should get import job', () => {\n      const created = importer.createImportJob('camp-1', 'recipients.csv', 'csv', []);\n      const retrieved = importer.getImportJob(created.id);\n\n      expect(retrieved?.fileName).toBe('recipients.csv');\n    });\n\n    it('should complete import job', () => {\n      const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', []);\n      const completed = importer.completeImportJob(job.id, true);\n\n      expect(completed).toBe(true);\n      const retrieved = importer.getImportJob(job.id);\n      expect(retrieved?.status).toBe('completed');\n    });\n  });\n\n  describe('Import Processing', () => {\n    it('should process import row', () => {\n      const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', [\n        {\n          csvColumn: 'Email',\n          recipientField: 'email',\n          dataType: 'email',\n          required: true,\n        },\n        {\n          csvColumn: 'FirstName',\n          recipientField: 'firstName',\n          dataType: 'string',\n          required: false,\n        },\n      ]);\n\n      const result = importer.processImportRow(job.id, 1, {\n        Email: 'john@example.com',\n        FirstName: 'John',\n      });\n\n      expect(result.success).toBe(true);\n      expect(result.recipientId).toBeDefined();\n    });\n\n    it('should reject invalid email', () => {\n      const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', [\n        {\n          csvColumn: 'Email',\n          recipientField: 'email',\n          dataType: 'email',\n          required: true,\n        },\n      ]);\n\n      const result = importer.processImportRow(job.id, 1, {\n        Email: 'invalid-email',\n      });\n\n      expect(result.success).toBe(false);\n      expect(result.error).toBeDefined();\n    });\n\n    it('should detect duplicate recipients', () => {\n      const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', [\n        {\n          csvColumn: 'Email',\n          recipientField: 'email',\n          dataType: 'email',\n          required: true,\n        },\n      ]);\n\n      // First import\n      importer.processImportRow(job.id, 1, { Email: 'john@example.com' });\n\n      // Second import (duplicate)\n      const result = importer.processImportRow(job.id, 2, { Email: 'john@example.com' });\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain('Duplicate');\n    });\n  });\n\n  describe('Export Jobs', () => {\n    it('should create export job', () => {\n      const job = importer.createExportJob('camp-1', 'csv');\n\n      expect(job).toBeDefined();\n      expect(job.status).toBe('pending');\n      expect(job.format).toBe('csv');\n    });\n\n    it('should get export job', () => {\n      const created = importer.createExportJob('camp-1', 'json');\n      const retrieved = importer.getExportJob(created.id);\n\n      expect(retrieved?.format).toBe('json');\n    });\n\n    it('should complete export job', () => {\n      const job = importer.createExportJob('camp-1', 'csv');\n      const completed = importer.completeExportJob(\n        job.id,\n        100,\n        5000,\n        'https://example.com/export.csv'\n      );\n\n      expect(completed).toBe(true);\n      const retrieved = importer.getExportJob(job.id);\n      expect(retrieved?.status).toBe('completed');\n      expect(retrieved?.downloadUrl).toBe('https://example.com/export.csv');\n    });\n  });\n\n  describe('Export Processing', () => {\n    it('should export recipients to CSV', () => {\n      const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', [\n        {\n          csvColumn: 'Email',\n          recipientField: 'email',\n          dataType: 'email',\n          required: true,\n        },\n      ]);\n\n      importer.processImportRow(job.id, 1, { Email: 'john@example.com' });\n      importer.processImportRow(job.id, 2, { Email: 'jane@example.com' });\n\n      const csv = importer.exportRecipientsToCsv('camp-1');\n      expect(csv).toContain('john@example.com');\n      expect(csv).toContain('jane@example.com');\n    });\n\n    it('should export recipients to JSON', () => {\n      const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', [\n        {\n          csvColumn: 'Email',\n          recipientField: 'email',\n          dataType: 'email',\n          required: true,\n        },\n      ]);\n\n      importer.processImportRow(job.id, 1, { Email: 'john@example.com' });\n\n      const json = importer.exportRecipientsToJson('camp-1');\n      const parsed = JSON.parse(json);\n      expect(Array.isArray(parsed)).toBe(true);\n      expect(parsed[0].email).toBe('john@example.com');\n    });\n  });\n\n  describe('Recipient Management', () => {\n    it('should get recipient by email', () => {\n      const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', [\n        {\n          csvColumn: 'Email',\n          recipientField: 'email',\n          dataType: 'email',\n          required: true,\n        },\n      ]);\n\n      importer.processImportRow(job.id, 1, { Email: 'john@example.com' });\n      const recipient = importer.getRecipientByEmail('john@example.com');\n\n      expect(recipient).toBeDefined();\n      expect(recipient?.email).toBe('john@example.com');\n    });\n\n    it('should update recipient', () => {\n      const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', [\n        {\n          csvColumn: 'Email',\n          recipientField: 'email',\n          dataType: 'email',\n          required: true,\n        },\n      ]);\n\n      const result = importer.processImportRow(job.id, 1, { Email: 'john@example.com' });\n      if (result.recipientId) {\n        const updated = importer.updateRecipient(result.recipientId, {\n          firstName: 'John',\n        });\n        expect(updated).toBe(true);\n      }\n    });\n\n    it('should delete recipient', () => {\n      const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', [\n        {\n          csvColumn: 'Email',\n          recipientField: 'email',\n          dataType: 'email',\n          required: true,\n        },\n      ]);\n\n      const result = importer.processImportRow(job.id, 1, { Email: 'john@example.com' });\n      if (result.recipientId) {\n        const deleted = importer.deleteRecipient(result.recipientId);\n        expect(deleted).toBe(true);\n\n        const retrieved = importer.getRecipientByEmail('john@example.com');\n        expect(retrieved).toBeUndefined();\n      }\n    });\n  });\n\n  describe('Statistics', () => {\n    it('should get import statistics', () => {\n      const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', [\n        {\n          csvColumn: 'Email',\n          recipientField: 'email',\n          dataType: 'email',\n          required: true,\n        },\n      ]);\n\n      importer.processImportRow(job.id, 1, { Email: 'john@example.com' });\n      importer.processImportRow(job.id, 2, { Email: 'jane@example.com' });\n\n      const stats = importer.getImportStatistics(job.id);\n      expect(stats).toBeDefined();\n      expect(stats?.successRate).toBeGreaterThan(0);\n    });\n  });\n});\n\ndescribe('Integration Tests', () => {\n  let scheduler: CampaignScheduler;\n  let importer: RecipientImportExport;\n\n  beforeEach(() => {\n    scheduler = new CampaignScheduler();\n    importer = new RecipientImportExport();\n  });\n\n  afterEach(() => {\n    scheduler.destroy();\n    importer.destroy();\n  });\n\n  it('should integrate scheduler with import/export', () => {\n    // Create schedule\n    const schedule = scheduler.createSchedule('camp-1', {\n      frequency: 'daily',\n      time: '09:00',\n      timezone: 'UTC',\n    });\n\n    // Import recipients\n    const job = importer.createImportJob('camp-1', 'recipients.csv', 'csv', [\n      {\n        csvColumn: 'Email',\n        recipientField: 'email',\n        dataType: 'email',\n        required: true,\n      },\n    ]);\n\n    importer.processImportRow(job.id, 1, { Email: 'john@example.com' });\n    importer.processImportRow(job.id, 2, { Email: 'jane@example.com' });\n\n    // Create scheduled send\n    const send = scheduler.createScheduledSend(schedule.id, 'camp-1', 2);\n\n    expect(schedule).toBeDefined();\n    expect(send).toBeDefined();\n    expect(send.recipientCount).toBe(2);\n  });\n});\n
