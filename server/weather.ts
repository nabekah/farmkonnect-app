import { EventEmitter } from 'events';\n\nexport type AlertSeverity = 'info' | 'warning' | 'critical';\nexport type WeatherCondition = 'clear' | 'cloudy' | 'rainy' | 'stormy' | 'snowy' | 'foggy' | 'hail';\n\nexport interface WeatherData {\n  id: string;\n  location: string;\n  latitude: number;\n  longitude: number;\n  timestamp: number;\n  temperature: number; // Celsius\n  humidity: number; // Percentage\n  rainfall: number; // mm\n  windSpeed: number; // km/h\n  windDirection: string;\n  uvIndex: number;\n  condition: WeatherCondition;\n  feelsLike: number;\n  dewPoint: number;\n  pressure: number; // hPa\n}\n\nexport interface WeatherForecast {\n  id: string;\n  location: string;\n  date: number;\n  high: number;\n  low: number;\n  condition: WeatherCondition;\n  rainfall: number;\n  windSpeed: number;\n  humidity: number;\n  uvIndex: number;\n}\n\nexport interface WeatherAlert {\n  id: string;\n  farmId: string;\n  type: 'frost' | 'heavy_rain' | 'drought' | 'extreme_heat' | 'extreme_cold' | 'hail' | 'strong_wind' | 'flood';\n  severity: AlertSeverity;\n  title: string;\n  description: string;\n  affectedCrops: string[];\n  recommendedActions: string[];\n  startTime: number;\n  endTime?: number;\n  isActive: boolean;\n  createdAt: number;\n}\n\nexport interface FarmWeatherProfile {\n  id: string;\n  farmId: string;\n  location: string;\n  latitude: number;\n  longitude: number;\n  altitude: number;\n  soilType: string;\n  microclimate: string;\n  alertThresholds: {\n    frostTemperature: number;\n    extremeHeatTemperature: number;\n    extremeColdTemperature: number;\n    heavyRainfallMm: number;\n    droughtDays: number;\n    windSpeedKmh: number;\n  };\n}\n\n/**\n * Weather Integration Manager\n */\nexport class WeatherManager extends EventEmitter {\n  private weatherData: Map<string, WeatherData> = new Map();\n  private forecasts: Map<string, WeatherForecast> = new Map();\n  private alerts: Map<string, WeatherAlert> = new Map();\n  private farmProfiles: Map<string, FarmWeatherProfile> = new Map();\n  private weatherHistory: Array<{ timestamp: number; data: WeatherData }> = [];\n\n  constructor() {\n    super();\n  }\n\n  /**\n   * Register farm weather profile\n   */\n  registerFarmProfile(\n    farmId: string,\n    location: string,\n    latitude: number,\n    longitude: number,\n    altitude: number = 0,\n    soilType: string = 'loamy',\n    microclimate: string = 'temperate'\n  ): FarmWeatherProfile {\n    const profileId = `profile_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const profile: FarmWeatherProfile = {\n      id: profileId,\n      farmId,\n      location,\n      latitude,\n      longitude,\n      altitude,\n      soilType,\n      microclimate,\n      alertThresholds: {\n        frostTemperature: 0,\n        extremeHeatTemperature: 35,\n        extremeColdTemperature: -10,\n        heavyRainfallMm: 50,\n        droughtDays: 14,\n        windSpeedKmh: 50,\n      },\n    };\n\n    this.farmProfiles.set(farmId, profile);\n    this.emit('profile:registered', { farmId, location });\n    return profile;\n  }\n\n  /**\n   * Get farm profile\n   */\n  getFarmProfile(farmId: string): FarmWeatherProfile | null {\n    return this.farmProfiles.get(farmId) || null;\n  }\n\n  /**\n   * Record weather data\n   */\n  recordWeatherData(\n    location: string,\n    latitude: number,\n    longitude: number,\n    temperature: number,\n    humidity: number,\n    rainfall: number,\n    windSpeed: number,\n    windDirection: string,\n    uvIndex: number,\n    condition: WeatherCondition,\n    feelsLike: number,\n    dewPoint: number,\n    pressure: number\n  ): WeatherData {\n    const dataId = `weather_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const data: WeatherData = {\n      id: dataId,\n      location,\n      latitude,\n      longitude,\n      timestamp: Date.now(),\n      temperature,\n      humidity,\n      rainfall,\n      windSpeed,\n      windDirection,\n      uvIndex,\n      condition,\n      feelsLike,\n      dewPoint,\n      pressure,\n    };\n\n    this.weatherData.set(dataId, data);\n    this.weatherHistory.push({ timestamp: Date.now(), data });\n\n    // Keep only last 30 days of history\n    const thirtyDaysAgo = Date.now() - 30 * 86400000;\n    this.weatherHistory = this.weatherHistory.filter((h) => h.timestamp > thirtyDaysAgo);\n\n    this.emit('weather:recorded', { location, temperature, condition });\n    return data;\n  }\n\n  /**\n   * Get latest weather data\n   */\n  getLatestWeatherData(location: string): WeatherData | null {\n    const allData = Array.from(this.weatherData.values()).filter((d) => d.location === location);\n    if (allData.length === 0) return null;\n    return allData.sort((a, b) => b.timestamp - a.timestamp)[0];\n  }\n\n  /**\n   * Create weather forecast\n   */\n  createForecast(\n    location: string,\n    date: number,\n    high: number,\n    low: number,\n    condition: WeatherCondition,\n    rainfall: number,\n    windSpeed: number,\n    humidity: number,\n    uvIndex: number\n  ): WeatherForecast {\n    const forecastId = `forecast_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const forecast: WeatherForecast = {\n      id: forecastId,\n      location,\n      date,\n      high,\n      low,\n      condition,\n      rainfall,\n      windSpeed,\n      humidity,\n      uvIndex,\n    };\n\n    this.forecasts.set(forecastId, forecast);\n    this.emit('forecast:created', { location, date, condition });\n    return forecast;\n  }\n\n  /**\n   * Get forecast for location\n   */\n  getForecast(location: string, days: number = 7): WeatherForecast[] {\n    const now = Date.now();\n    return Array.from(this.forecasts.values())\n      .filter((f) => f.location === location && f.date >= now && f.date <= now + days * 86400000)\n      .sort((a, b) => a.date - b.date);\n  }\n\n  /**\n   * Create weather alert\n   */\n  createAlert(\n    farmId: string,\n    type: WeatherAlert['type'],\n    severity: AlertSeverity,\n    title: string,\n    description: string,\n    affectedCrops: string[] = [],\n    recommendedActions: string[] = [],\n    endTime?: number\n  ): WeatherAlert {\n    const alertId = `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const alert: WeatherAlert = {\n      id: alertId,\n      farmId,\n      type,\n      severity,\n      title,\n      description,\n      affectedCrops,\n      recommendedActions,\n      startTime: Date.now(),\n      endTime,\n      isActive: true,\n      createdAt: Date.now(),\n    };\n\n    this.alerts.set(alertId, alert);\n    this.emit('alert:created', { alertId, farmId, type, severity });\n    return alert;\n  }\n\n  /**\n   * Get active alerts for farm\n   */\n  getActiveAlerts(farmId: string): WeatherAlert[] {\n    return Array.from(this.alerts.values())\n      .filter((a) => a.farmId === farmId && a.isActive)\n      .sort((a, b) => {\n        const severityOrder = { critical: 0, warning: 1, info: 2 };\n        return severityOrder[a.severity] - severityOrder[b.severity];\n      });\n  }\n\n  /**\n   * Resolve alert\n   */\n  resolveAlert(alertId: string): WeatherAlert | null {\n    const alert = this.alerts.get(alertId);\n    if (!alert) return null;\n\n    alert.isActive = false;\n    alert.endTime = Date.now();\n    this.emit('alert:resolved', { alertId });\n    return alert;\n  }\n\n  /**\n   * Check weather conditions and generate alerts\n   */\n  checkWeatherConditions(farmId: string): WeatherAlert[] {\n    const profile = this.getFarmProfile(farmId);\n    if (!profile) return [];\n\n    const weather = this.getLatestWeatherData(profile.location);\n    if (!weather) return [];\n\n    const newAlerts: WeatherAlert[] = [];\n    const thresholds = profile.alertThresholds;\n\n    // Check frost risk\n    if (weather.temperature <= thresholds.frostTemperature) {\n      const alert = this.createAlert(\n        farmId,\n        'frost',\n        'critical',\n        'Frost Alert',\n        `Temperature is at or below ${thresholds.frostTemperature}°C`,\n        [],\n        ['Cover sensitive crops', 'Run irrigation to warm soil', 'Monitor overnight temperatures']\n      );\n      newAlerts.push(alert);\n    }\n\n    // Check extreme heat\n    if (weather.temperature >= thresholds.extremeHeatTemperature) {\n      const alert = this.createAlert(\n        farmId,\n        'extreme_heat',\n        'warning',\n        'Extreme Heat Alert',\n        `Temperature reached ${weather.temperature}°C`,\n        [],\n        ['Increase irrigation', 'Provide shade for sensitive crops', 'Monitor for heat stress']\n      );\n      newAlerts.push(alert);\n    }\n\n    // Check extreme cold\n    if (weather.temperature <= thresholds.extremeColdTemperature) {\n      const alert = this.createAlert(\n        farmId,\n        'extreme_cold',\n        'critical',\n        'Extreme Cold Alert',\n        `Temperature dropped to ${weather.temperature}°C`,\n        [],\n        ['Protect crops from freezing', 'Ensure adequate drainage', 'Monitor for damage']\n      );\n      newAlerts.push(alert);\n    }\n\n    // Check heavy rainfall\n    if (weather.rainfall >= thresholds.heavyRainfallMm) {\n      const alert = this.createAlert(\n        farmId,\n        'heavy_rain',\n        'warning',\n        'Heavy Rainfall Alert',\n        `Rainfall: ${weather.rainfall}mm`,\n        [],\n        ['Ensure proper drainage', 'Check for waterlogging', 'Monitor for diseases']\n      );\n      newAlerts.push(alert);\n    }\n\n    // Check strong wind\n    if (weather.windSpeed >= thresholds.windSpeedKmh) {\n      const alert = this.createAlert(\n        farmId,\n        'strong_wind',\n        'warning',\n        'Strong Wind Alert',\n        `Wind speed: ${weather.windSpeed} km/h`,\n        [],\n        ['Secure loose items', 'Check for crop damage', 'Protect young plants']\n      );\n      newAlerts.push(alert);\n    }\n\n    // Check hail risk\n    if (weather.condition === 'hail') {\n      const alert = this.createAlert(\n        farmId,\n        'hail',\n        'critical',\n        'Hail Alert',\n        'Hail storm detected',\n        [],\n        ['Seek shelter', 'Protect crops if possible', 'Assess damage after storm']\n      );\n      newAlerts.push(alert);\n    }\n\n    return newAlerts;\n  }\n\n  /**\n   * Get weather history\n   */\n  getWeatherHistory(location: string, days: number = 7): WeatherData[] {\n    const cutoffTime = Date.now() - days * 86400000;\n    return this.weatherHistory\n      .filter((h) => h.data.location === location && h.timestamp > cutoffTime)\n      .map((h) => h.data)\n      .sort((a, b) => a.timestamp - b.timestamp);\n  }\n\n  /**\n   * Get weather statistics\n   */\n  getWeatherStats(): {\n    totalRecords: number;\n    totalForecasts: number;\n    activeAlerts: number;\n    registeredFarms: number;\n  } {\n    return {\n      totalRecords: this.weatherData.size,\n      totalForecasts: this.forecasts.size,\n      activeAlerts: Array.from(this.alerts.values()).filter((a) => a.isActive).length,\n      registeredFarms: this.farmProfiles.size,\n    };\n  }\n}\n
