/**
 * Irrigation Scheduling System\n * Optimizes irrigation schedules based on crop, soil, and weather conditions\n */\n\nexport interface IrrigationSchedule {\n  fieldId: string;\n  cropName: string;\n  growthStage: number;\n  scheduledDate: Date;\n  waterRequirement: number; // mm\n  irrigationMethod: 'flood' | 'sprinkler' | 'drip' | 'furrow';\n  duration: number; // minutes\n  flowRate: number; // liters/minute\n  totalWaterVolume: number; // liters\n  soilMoisture: number; // percentage\n  weatherForecast: WeatherData;\n  recommendations: string[];\n  status: 'scheduled' | 'completed' | 'cancelled';\n}\n\nexport interface WeatherData {\n  temperature: number;\n  rainfall: number; // mm\n  humidity: number; // percentage\n  windSpeed: number; // km/h\n  evapotranspiration: number; // mm/day\n}\n\nexport interface SoilMoistureData {\n  fieldId: string;\n  timestamp: Date;\n  moisture: number; // percentage\n  depth: number; // cm\n}\n\nexport interface CropWaterRequirement {\n  cropName: string;\n  stage: number;\n  baseWaterRequirement: number; // mm/day\n  criticalStages: string[];\n}\n\n/**\n * Irrigation Scheduling Implementation\n */\nexport class IrrigationScheduler {\n  private schedules: Map<string, IrrigationSchedule> = new Map();\n  private waterRequirements: Map<string, CropWaterRequirement[]> = new Map();\n  private soilMoistureData: Map<string, SoilMoistureData[]> = new Map();\n\n  constructor() {\n    this.initializeWaterRequirements();\n  }\n\n  private initializeWaterRequirements(): void {\n    // Rice water requirements\n    this.waterRequirements.set('rice', [\n      {\n        cropName: 'rice',\n        stage: 1,\n        baseWaterRequirement: 2,\n        criticalStages: ['germination'],\n      },\n      {\n        cropName: 'rice',\n        stage: 2,\n        baseWaterRequirement: 4,\n        criticalStages: ['seedling'],\n      },\n      {\n        cropName: 'rice',\n        stage: 3,\n        baseWaterRequirement: 6,\n        criticalStages: ['vegetative', 'tillering'],\n      },\n      {\n        cropName: 'rice',\n        stage: 4,\n        baseWaterRequirement: 7,\n        criticalStages: ['panicle_initiation'],\n      },\n      {\n        cropName: 'rice',\n        stage: 5,\n        baseWaterRequirement: 6,\n        criticalStages: ['booting', 'flowering'],\n      },\n      {\n        cropName: 'rice',\n        stage: 6,\n        baseWaterRequirement: 4,\n        criticalStages: ['grain_filling'],\n      },\n    ]);\n\n    // Wheat water requirements\n    this.waterRequirements.set('wheat', [\n      {\n        cropName: 'wheat',\n        stage: 1,\n        baseWaterRequirement: 1,\n        criticalStages: ['germination'],\n      },\n      {\n        cropName: 'wheat',\n        stage: 2,\n        baseWaterRequirement: 2,\n        criticalStages: ['seedling'],\n      },\n      {\n        cropName: 'wheat',\n        stage: 3,\n        baseWaterRequirement: 3,\n        criticalStages: ['tillering'],\n      },\n      {\n        cropName: 'wheat',\n        stage: 4,\n        baseWaterRequirement: 4,\n        criticalStages: ['heading', 'flowering'],\n      },\n      {\n        cropName: 'wheat',\n        stage: 5,\n        baseWaterRequirement: 2,\n        criticalStages: ['grain_filling'],\n      },\n    ]);\n\n    // Corn water requirements\n    this.waterRequirements.set('corn', [\n      {\n        cropName: 'corn',\n        stage: 1,\n        baseWaterRequirement: 2,\n        criticalStages: ['germination'],\n      },\n      {\n        cropName: 'corn',\n        stage: 2,\n        baseWaterRequirement: 3,\n        criticalStages: ['seedling'],\n      },\n      {\n        cropName: 'corn',\n        stage: 3,\n        baseWaterRequirement: 5,\n        criticalStages: ['vegetative'],\n      },\n      {\n        cropName: 'corn',\n        stage: 4,\n        baseWaterRequirement: 7,\n        criticalStages: ['tasseling', 'silking'],\n      },\n      {\n        cropName: 'corn',\n        stage: 5,\n        baseWaterRequirement: 5,\n        criticalStages: ['grain_filling'],\n      },\n    ]);\n  }\n\n  generateSchedule(\n    fieldId: string,\n    cropName: string,\n    growthStage: number,\n    soilMoisture: number,\n    weatherData: WeatherData,\n    irrigationMethod: 'flood' | 'sprinkler' | 'drip' | 'furrow' = 'drip'\n  ): IrrigationSchedule | null {\n    const waterReqs = this.waterRequirements.get(cropName.toLowerCase());\n    if (!waterReqs) return null;\n\n    const stageReq = waterReqs.find(wr => wr.stage === growthStage);\n    if (!stageReq) return null;\n\n    // Calculate water requirement\n    const baseRequirement = stageReq.baseWaterRequirement;\n    const etAdjustment = weatherData.evapotranspiration / 5; // Normalize ET\n    const totalWaterRequirement = baseRequirement * etAdjustment;\n\n    // Check if irrigation is needed\n    const criticalMoisture = this.getCriticalMoisture(cropName, growthStage);\n    if (soilMoisture > criticalMoisture) {\n      return null; // No irrigation needed\n    }\n\n    // Calculate irrigation parameters\n    const { duration, flowRate, totalVolume } = this.calculateIrrigationParameters(\n      totalWaterRequirement,\n      irrigationMethod,\n      100 // Assume 1 hectare field\n    );\n\n    // Check weather conditions\n    const recommendations = this.generateRecommendations(\n      weatherData,\n      stageReq.criticalStages,\n      soilMoisture\n    );\n\n    const schedule: IrrigationSchedule = {\n      fieldId,\n      cropName,\n      growthStage,\n      scheduledDate: this.getOptimalIrrigationDate(weatherData),\n      waterRequirement: totalWaterRequirement,\n      irrigationMethod,\n      duration,\n      flowRate,\n      totalWaterVolume: totalVolume,\n      soilMoisture,\n      weatherForecast: weatherData,\n      recommendations,\n      status: 'scheduled',\n    };\n\n    const scheduleId = `schedule-${fieldId}-${Date.now()}`;\n    this.schedules.set(scheduleId, schedule);\n\n    return schedule;\n  }\n\n  private getCriticalMoisture(cropName: string, stage: number): number {\n    // Critical soil moisture levels (percentage)\n    const criticalLevels: { [key: string]: number } = {\n      'rice-1': 70,\n      'rice-2': 75,\n      'rice-3': 80,\n      'rice-4': 85,\n      'rice-5': 75,\n      'rice-6': 60,\n      'wheat-1': 50,\n      'wheat-2': 60,\n      'wheat-3': 65,\n      'wheat-4': 70,\n      'wheat-5': 50,\n      'corn-1': 55,\n      'corn-2': 60,\n      'corn-3': 65,\n      'corn-4': 75,\n      'corn-5': 60,\n    };\n\n    return criticalLevels[`${cropName.toLowerCase()}-${stage}`] || 60;\n  }\n\n  private calculateIrrigationParameters(\n    waterRequirement: number,\n    method: string,\n    fieldArea: number\n  ): { duration: number; flowRate: number; totalVolume: number } {\n    // Convert mm to liters (1mm = 10 liters/mÂ²)\n    const totalVolume = waterRequirement * 10 * fieldArea * 100; // in liters\n\n    const methodParameters: { [key: string]: { flowRate: number; efficiency: number } } = {\n      flood: { flowRate: 1000, efficiency: 0.6 },\n      sprinkler: { flowRate: 500, efficiency: 0.75 },\n      drip: { flowRate: 200, efficiency: 0.9 },\n      furrow: { flowRate: 800, efficiency: 0.65 },\n    };\n\n    const params = methodParameters[method] || methodParameters.drip;\n    const adjustedVolume = totalVolume / params.efficiency;\n    const duration = Math.round(adjustedVolume / params.flowRate);\n\n    return {\n      duration,\n      flowRate: params.flowRate,\n      totalVolume: Math.round(adjustedVolume),\n    };\n  }\n\n  private getOptimalIrrigationDate(weatherData: WeatherData): Date {\n    const date = new Date();\n\n    // Avoid irrigation during rain or high wind\n    if (weatherData.rainfall > 5 || weatherData.windSpeed > 20) {\n      date.setDate(date.getDate() + 1); // Schedule for next day\n    }\n\n    // Schedule early morning for best results\n    date.setHours(5, 0, 0, 0);\n\n    return date;\n  }\n\n  private generateRecommendations(\n    weatherData: WeatherData,\n    criticalStages: string[],\n    soilMoisture: number\n  ): string[] {\n    const recommendations: string[] = [];\n\n    if (weatherData.rainfall > 10) {\n      recommendations.push('High rainfall expected - consider postponing irrigation');\n    }\n\n    if (weatherData.windSpeed > 15) {\n      recommendations.push('High wind speed - use drip or furrow irrigation to minimize evaporation');\n    }\n\n    if (weatherData.temperature > 35) {\n      recommendations.push('High temperature - increase irrigation frequency');\n    }\n\n    if (weatherData.humidity < 30) {\n      recommendations.push('Low humidity - increase water application');\n    }\n\n    if (soilMoisture < 40) {\n      recommendations.push('Critical soil moisture - irrigate immediately');\n    }\n\n    if (criticalStages.length > 0) {\n      recommendations.push(`Critical stage(s): ${criticalStages.join(', ')} - ensure adequate water`);\n    }\n\n    if (recommendations.length === 0) {\n      recommendations.push('Conditions are favorable for irrigation');\n    }\n\n    return recommendations;\n  }\n\n  recordSoilMoisture(fieldId: string, moisture: number, depth: number): void {\n    const data: SoilMoistureData = {\n      fieldId,\n      timestamp: new Date(),\n      moisture,\n      depth,\n    };\n\n    if (!this.soilMoistureData.has(fieldId)) {\n      this.soilMoistureData.set(fieldId, []);\n    }\n\n    this.soilMoistureData.get(fieldId)!.push(data);\n  }\n\n  completeIrrigation(scheduleId: string): void {\n    const schedule = this.schedules.get(scheduleId);\n    if (schedule) {\n      schedule.status = 'completed';\n    }\n  }\n\n  getSchedule(scheduleId: string): IrrigationSchedule | undefined {\n    return this.schedules.get(scheduleId);\n  }\n\n  getAllSchedules(fieldId: string): IrrigationSchedule[] {\n    return Array.from(this.schedules.values()).filter(s => s.fieldId === fieldId);\n  }\n}\n\nexport const irrigationScheduler = new IrrigationScheduler();\n
