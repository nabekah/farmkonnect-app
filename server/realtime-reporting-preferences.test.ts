import { describe, it, expect, beforeEach } from 'vitest';\nimport { RealtimeCollaborationManager } from './realtime-collaboration';\nimport { AdvancedReportingManager } from './advanced-reporting';\nimport { UserPreferencesManager } from './user-preferences';\n\n/**\n * Real-time Collaboration Tests\n */\ndescribe('Real-time Collaboration Manager', () => {\n  let collaboration: RealtimeCollaborationManager;\n\n  beforeEach(() => {\n    collaboration = new RealtimeCollaborationManager();\n  });\n\n  it('should add user to collaboration', () => {\n    const user = collaboration.userJoin('user-1', 'farm-1', 'John');\n    expect(user).not.toBeNull();\n    expect(user.userId).toBe('user-1');\n    expect(user.color).not.toBeNull();\n  });\n\n  it('should get active users', () => {\n    collaboration.userJoin('user-1', 'farm-1', 'John');\n    collaboration.userJoin('user-2', 'farm-1', 'Jane');\n\n    const users = collaboration.getActiveUsers();\n    expect(users.length).toBe(2);\n  });\n\n  it('should update cursor position', () => {\n    collaboration.userJoin('user-1', 'farm-1', 'John');\n    collaboration.updateCursor('user-1', 100, 200);\n\n    const cursors = collaboration.getCursorPositions();\n    expect(cursors.get('user-1')).toEqual({ x: 100, y: 200 });\n  });\n\n  it('should broadcast task update', () => {\n    collaboration.userJoin('user-1', 'farm-1', 'John');\n    const update = collaboration.broadcastTaskUpdate('task-1', 'status', 'pending', 'in-progress', 'user-1');\n\n    expect(update).not.toBeNull();\n    expect(update.field).toBe('status');\n    expect(update.newValue).toBe('in-progress');\n  });\n\n  it('should lock task', () => {\n    collaboration.userJoin('user-1', 'farm-1', 'John');\n    const locked = collaboration.lockTask('task-1', 'user-1');\n\n    expect(locked).toBe(true);\n    const lock = collaboration.getTaskLock('task-1');\n    expect(lock?.userId).toBe('user-1');\n  });\n\n  it('should prevent concurrent task locks', () => {\n    collaboration.userJoin('user-1', 'farm-1', 'John');\n    collaboration.userJoin('user-2', 'farm-1', 'Jane');\n\n    const lock1 = collaboration.lockTask('task-1', 'user-1');\n    const lock2 = collaboration.lockTask('task-1', 'user-2');\n\n    expect(lock1).toBe(true);\n    expect(lock2).toBe(false);\n  });\n\n  it('should unlock task', () => {\n    collaboration.userJoin('user-1', 'farm-1', 'John');\n    collaboration.lockTask('task-1', 'user-1');\n    const unlocked = collaboration.unlockTask('task-1', 'user-1');\n\n    expect(unlocked).toBe(true);\n    expect(collaboration.getTaskLock('task-1')).toBeNull();\n  });\n\n  it('should get collaboration stats', () => {\n    collaboration.userJoin('user-1', 'farm-1', 'John');\n    collaboration.userJoin('user-2', 'farm-1', 'Jane');\n    collaboration.broadcastTaskUpdate('task-1', 'status', 'pending', 'in-progress', 'user-1');\n\n    const stats = collaboration.getCollaborationStats();\n    expect(stats.activeUsers).toBe(2);\n    expect(stats.totalUpdates).toBe(1);\n  });\n});\n\n/**\n * Advanced Reporting Tests\n */\ndescribe('Advanced Reporting Manager', () => {\n  let reporting: AdvancedReportingManager;\n\n  beforeEach(() => {\n    reporting = new AdvancedReportingManager();\n  });\n\n  it('should generate performance report', () => {\n    const report = reporting.generateReport(\n      'farm-1',\n      'user-1',\n      'performance',\n      'Monthly Performance Report',\n      { dateRange: 'month' },\n      'pdf'\n    );\n\n    expect(report).not.toBeNull();\n    expect(report.type).toBe('performance');\n    expect(report.data.metrics).not.toBeNull();\n  });\n\n  it('should generate financial report', () => {\n    const report = reporting.generateReport(\n      'farm-1',\n      'user-1',\n      'financial',\n      'Financial Report',\n      { dateRange: 'month' },\n      'excel'\n    );\n\n    expect(report.type).toBe('financial');\n    expect(report.data.revenue).toBeGreaterThan(0);\n    expect(report.data.profit).toBeGreaterThan(0);\n  });\n\n  it('should get report', () => {\n    const generated = reporting.generateReport(\n      'farm-1',\n      'user-1',\n      'performance',\n      'Report',\n      { dateRange: 'month' },\n      'pdf'\n    );\n\n    const retrieved = reporting.getReport(generated.id);\n    expect(retrieved).not.toBeNull();\n    expect(retrieved?.id).toBe(generated.id);\n  });\n\n  it('should get reports by farm', () => {\n    reporting.generateReport('farm-1', 'user-1', 'performance', 'Report 1', { dateRange: 'month' }, 'pdf');\n    reporting.generateReport('farm-1', 'user-1', 'financial', 'Report 2', { dateRange: 'month' }, 'pdf');\n    reporting.generateReport('farm-2', 'user-1', 'performance', 'Report 3', { dateRange: 'month' }, 'pdf');\n\n    const farm1Reports = reporting.getReports('farm-1');\n    expect(farm1Reports.length).toBe(2);\n  });\n\n  it('should create report schedule', () => {\n    const schedule = reporting.createSchedule(\n      'farm-1',\n      'performance',\n      'weekly',\n      ['user-1@example.com'],\n      { dateRange: 'week' },\n      'pdf'\n    );\n\n    expect(schedule).not.toBeNull();\n    expect(schedule.frequency).toBe('weekly');\n    expect(schedule.enabled).toBe(true);\n  });\n\n  it('should get schedules', () => {\n    reporting.createSchedule('farm-1', 'performance', 'daily', ['user@example.com'], { dateRange: 'day' }, 'pdf');\n    reporting.createSchedule('farm-1', 'financial', 'monthly', ['user@example.com'], { dateRange: 'month' }, 'excel');\n\n    const schedules = reporting.getSchedules('farm-1');\n    expect(schedules.length).toBe(2);\n  });\n\n  it('should export report as JSON', () => {\n    const generated = reporting.generateReport(\n      'farm-1',\n      'user-1',\n      'performance',\n      'Report',\n      { dateRange: 'month' },\n      'json'\n    );\n\n    const exported = reporting.exportReport(generated.id, 'json');\n    expect(exported).toContain('performance');\n  });\n\n  it('should get report metrics', () => {\n    reporting.generateReport('farm-1', 'user-1', 'performance', 'Report 1', { dateRange: 'month' }, 'pdf');\n    reporting.generateReport('farm-1', 'user-1', 'financial', 'Report 2', { dateRange: 'month' }, 'pdf');\n\n    const metrics = reporting.getReportMetrics();\n    expect(metrics.totalReports).toBe(2);\n    expect(metrics.reportsByType.performance).toBe(1);\n    expect(metrics.reportsByType.financial).toBe(1);\n  });\n});\n\n/**\n * User Preferences Tests\n */\ndescribe('User Preferences Manager', () => {\n  let preferences: UserPreferencesManager;\n\n  beforeEach(() => {\n    preferences = new UserPreferencesManager();\n  });\n\n  it('should get default preferences', () => {\n    const prefs = preferences.getUserPreferences('user-1');\n    expect(prefs).not.toBeNull();\n    expect(prefs.theme).toBe('auto');\n    expect(prefs.language).toBe('en');\n  });\n\n  it('should set theme', () => {\n    preferences.setTheme('user-1', 'dark');\n    const prefs = preferences.getUserPreferences('user-1');\n    expect(prefs.theme).toBe('dark');\n  });\n\n  it('should set language', () => {\n    preferences.setLanguage('user-1', 'es');\n    const prefs = preferences.getUserPreferences('user-1');\n    expect(prefs.language).toBe('es');\n  });\n\n  it('should update notification preferences', () => {\n    preferences.updateNotificationPreferences('user-1', {\n      email: false,\n      sms: true,\n    });\n\n    const prefs = preferences.getUserPreferences('user-1');\n    expect(prefs.notifications.email).toBe(false);\n    expect(prefs.notifications.sms).toBe(true);\n  });\n\n  it('should update dashboard preferences', () => {\n    preferences.updateDashboardPreferences('user-1', {\n      layout: 'list',\n      itemsPerPage: 20,\n    });\n\n    const prefs = preferences.getUserPreferences('user-1');\n    expect(prefs.dashboard.layout).toBe('list');\n    expect(prefs.dashboard.itemsPerPage).toBe(20);\n  });\n\n  it('should update privacy preferences', () => {\n    preferences.updatePrivacyPreferences('user-1', {\n      profileVisibility: 'private',\n    });\n\n    const prefs = preferences.getUserPreferences('user-1');\n    expect(prefs.privacy.profileVisibility).toBe('private');\n  });\n\n  it('should reset to defaults', () => {\n    preferences.setTheme('user-1', 'dark');\n    preferences.setLanguage('user-1', 'es');\n    preferences.resetToDefaults('user-1');\n\n    const prefs = preferences.getUserPreferences('user-1');\n    expect(prefs.theme).toBe('auto');\n    expect(prefs.language).toBe('en');\n  });\n\n  it('should get preferences history', () => {\n    preferences.setTheme('user-1', 'dark');\n    preferences.setLanguage('user-1', 'es');\n\n    const history = preferences.getPreferenceHistory('user-1');\n    expect(history.length).toBeGreaterThan(0);\n  });\n\n  it('should export preferences', () => {\n    preferences.setTheme('user-1', 'dark');\n    const exported = preferences.exportPreferences('user-1');\n    expect(exported).toContain('dark');\n  });\n\n  it('should get preferences summary', () => {\n    const summary = preferences.getPreferencesSummary('user-1');\n    expect(summary.theme).toBe('auto');\n    expect(summary.language).toBe('en');\n    expect(summary.notificationsEnabled).toBeGreaterThan(0);\n  });\n});\n\n/**\n * Integration Tests\n */\ndescribe('Integration Tests', () => {\n  it('should work with all three systems', () => {\n    const collaboration = new RealtimeCollaborationManager();\n    const reporting = new AdvancedReportingManager();\n    const preferences = new UserPreferencesManager();\n\n    // Setup collaboration\n    collaboration.userJoin('user-1', 'farm-1', 'John');\n    collaboration.broadcastTaskUpdate('task-1', 'status', 'pending', 'in-progress', 'user-1');\n\n    // Generate report\n    const report = reporting.generateReport(\n      'farm-1',\n      'user-1',\n      'performance',\n      'Report',\n      { dateRange: 'month' },\n      'pdf'\n    );\n\n    // Set preferences\n    preferences.setTheme('user-1', 'dark');\n    preferences.setLanguage('user-1', 'es');\n\n    // Verify all systems work\n    const users = collaboration.getActiveUsers();\n    const prefs = preferences.getUserPreferences('user-1');\n    const retrieved = reporting.getReport(report.id);\n\n    expect(users.length).toBe(1);\n    expect(prefs.theme).toBe('dark');\n    expect(retrieved).not.toBeNull();\n  });\n});\n
