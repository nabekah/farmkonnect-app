import { EventEmitter } from 'events';\n\nexport type HttpMethod = 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';\nexport type ParameterLocation = 'query' | 'path' | 'body' | 'header';\n\nexport interface Parameter {\n  name: string;\n  type: string;\n  location: ParameterLocation;\n  required: boolean;\n  description: string;\n  example?: any;\n  schema?: Record<string, any>;\n}\n\nexport interface Response {\n  status: number;\n  description: string;\n  schema?: Record<string, any>;\n  example?: any;\n}\n\nexport interface ApiEndpoint {\n  id: string;\n  method: HttpMethod;\n  path: string;\n  summary: string;\n  description: string;\n  tags: string[];\n  parameters: Parameter[];\n  requestBody?: {\n    description: string;\n    required: boolean;\n    schema: Record<string, any>;\n    example?: any;\n  };\n  responses: Response[];\n  authentication?: 'none' | 'bearer' | 'oauth2';\n  rateLimit?: {\n    requests: number;\n    window: number; // in seconds\n  };\n  examples?: Array<{\n    title: string;\n    request: any;\n    response: any;\n  }>;\n}\n\nexport interface ApiTag {\n  name: string;\n  description: string;\n  endpoints: string[]; // endpoint IDs\n}\n\nexport interface ApiDocumentation {\n  title: string;\n  version: string;\n  description: string;\n  baseUrl: string;\n  endpoints: ApiEndpoint[];\n  tags: ApiTag[];\n  authentication: {\n    type: string;\n    description: string;\n    location: string;\n  };\n  generatedAt: number;\n}\n\n/**\n * API Documentation Manager\n */\nexport class ApiDocumentationManager extends EventEmitter {\n  private endpoints: Map<string, ApiEndpoint> = new Map();\n  private tags: Map<string, ApiTag> = new Map();\n  private documentation: ApiDocumentation | null = null;\n  private accessLogs: Array<{ endpoint: string; timestamp: number; userId?: string }> = [];\n\n  constructor(private baseUrl: string = 'https://api.farmkonnect.com') {\n    super();\n    this.initializeEndpoints();\n  }\n\n  /**\n   * Initialize default endpoints\n   */\n  private initializeEndpoints(): void {\n    // Farms endpoints\n    this.registerEndpoint({\n      id: 'farms-list',\n      method: 'GET',\n      path: '/api/farms',\n      summary: 'List all farms',\n      description: 'Retrieve a paginated list of all farms for the authenticated user',\n      tags: ['Farms'],\n      parameters: [\n        {\n          name: 'page',\n          type: 'integer',\n          location: 'query',\n          required: false,\n          description: 'Page number (default: 1)',\n          example: 1,\n        },\n        {\n          name: 'limit',\n          type: 'integer',\n          location: 'query',\n          required: false,\n          description: 'Items per page (default: 10)',\n          example: 10,\n        },\n      ],\n      responses: [\n        {\n          status: 200,\n          description: 'Successfully retrieved farms',\n          example: {\n            data: [\n              { id: 'farm-1', name: 'North Field', area: 50, crops: ['wheat', 'corn'] },\n            ],\n            total: 1,\n          },\n        },\n        { status: 401, description: 'Unauthorized' },\n      ],\n      authentication: 'bearer',\n      rateLimit: { requests: 100, window: 3600 },\n    });\n\n    // Create farm endpoint\n    this.registerEndpoint({\n      id: 'farms-create',\n      method: 'POST',\n      path: '/api/farms',\n      summary: 'Create a new farm',\n      description: 'Create a new farm for the authenticated user',\n      tags: ['Farms'],\n      parameters: [],\n      requestBody: {\n        description: 'Farm data',\n        required: true,\n        schema: {\n          type: 'object',\n          properties: {\n            name: { type: 'string', description: 'Farm name' },\n            location: { type: 'string', description: 'Farm location' },\n            area: { type: 'number', description: 'Farm area in acres' },\n          },\n          required: ['name', 'location', 'area'],\n        },\n        example: { name: 'South Field', location: 'Iowa', area: 75 },\n      },\n      responses: [\n        {\n          status: 201,\n          description: 'Farm created successfully',\n          example: { id: 'farm-2', name: 'South Field', location: 'Iowa', area: 75 },\n        },\n        { status: 400, description: 'Invalid request' },\n        { status: 401, description: 'Unauthorized' },\n      ],\n      authentication: 'bearer',\n      rateLimit: { requests: 50, window: 3600 },\n    });\n\n    // Tasks endpoints\n    this.registerEndpoint({\n      id: 'tasks-list',\n      method: 'GET',\n      path: '/api/tasks',\n      summary: 'List tasks',\n      description: 'Retrieve tasks for a specific farm',\n      tags: ['Tasks'],\n      parameters: [\n        {\n          name: 'farmId',\n          type: 'string',\n          location: 'query',\n          required: true,\n          description: 'Farm ID',\n          example: 'farm-1',\n        },\n        {\n          name: 'status',\n          type: 'string',\n          location: 'query',\n          required: false,\n          description: 'Filter by status (pending, in-progress, completed)',\n          example: 'pending',\n        },\n      ],\n      responses: [\n        {\n          status: 200,\n          description: 'Tasks retrieved successfully',\n          example: {\n            data: [\n              { id: 'task-1', title: 'Irrigation', status: 'pending', dueDate: '2026-02-20' },\n            ],\n          },\n        },\n      ],\n      authentication: 'bearer',\n      rateLimit: { requests: 200, window: 3600 },\n    });\n\n    // Analytics endpoints\n    this.registerEndpoint({\n      id: 'analytics-metrics',\n      method: 'GET',\n      path: '/api/analytics/metrics',\n      summary: 'Get farm metrics',\n      description: 'Retrieve analytics metrics for a farm',\n      tags: ['Analytics'],\n      parameters: [\n        {\n          name: 'farmId',\n          type: 'string',\n          location: 'query',\n          required: true,\n          description: 'Farm ID',\n          example: 'farm-1',\n        },\n        {\n          name: 'dateRange',\n          type: 'string',\n          location: 'query',\n          required: false,\n          description: 'Date range (day, week, month, year)',\n          example: 'month',\n        },\n      ],\n      responses: [\n        {\n          status: 200,\n          description: 'Metrics retrieved successfully',\n          example: {\n            yieldPerAcre: 95.5,\n            soilHealth: 8.2,\n            waterUsage: 1250,\n          },\n        },\n      ],\n      authentication: 'bearer',\n    });\n\n    // Register tags\n    this.registerTag({\n      name: 'Farms',\n      description: 'Farm management endpoints',\n      endpoints: ['farms-list', 'farms-create'],\n    });\n\n    this.registerTag({\n      name: 'Tasks',\n      description: 'Task management endpoints',\n      endpoints: ['tasks-list'],\n    });\n\n    this.registerTag({\n      name: 'Analytics',\n      description: 'Analytics and reporting endpoints',\n      endpoints: ['analytics-metrics'],\n    });\n  }\n\n  /**\n   * Register endpoint\n   */\n  registerEndpoint(endpoint: ApiEndpoint): void {\n    this.endpoints.set(endpoint.id, endpoint);\n    this.emit('endpoint:registered', { id: endpoint.id, path: endpoint.path });\n  }\n\n  /**\n   * Register tag\n   */\n  registerTag(tag: ApiTag): void {\n    this.tags.set(tag.name, tag);\n  }\n\n  /**\n   * Get endpoint\n   */\n  getEndpoint(endpointId: string): ApiEndpoint | null {\n    return this.endpoints.get(endpointId) || null;\n  }\n\n  /**\n   * Get endpoints by tag\n   */\n  getEndpointsByTag(tagName: string): ApiEndpoint[] {\n    const tag = this.tags.get(tagName);\n    if (!tag) return [];\n\n    return tag.endpoints\n      .map((id) => this.endpoints.get(id))\n      .filter((endpoint): endpoint is ApiEndpoint => endpoint !== undefined);\n  }\n\n  /**\n   * Get all endpoints\n   */\n  getAllEndpoints(): ApiEndpoint[] {\n    return Array.from(this.endpoints.values());\n  }\n\n  /**\n   * Get all tags\n   */\n  getAllTags(): ApiTag[] {\n    return Array.from(this.tags.values());\n  }\n\n  /**\n   * Generate OpenAPI spec\n   */\n  generateOpenAPISpec(): Record<string, any> {\n    const spec = {\n      openapi: '3.0.0',\n      info: {\n        title: 'FarmKonnect API',\n        version: '1.0.0',\n        description: 'Farm management and analytics API',\n      },\n      servers: [{ url: this.baseUrl }],\n      paths: {} as Record<string, any>,\n      components: {\n        securitySchemes: {\n          bearerAuth: {\n            type: 'http',\n            scheme: 'bearer',\n            bearerFormat: 'JWT',\n          },\n        },\n      },\n      tags: this.getAllTags().map((tag) => ({\n        name: tag.name,\n        description: tag.description,\n      })),\n    };\n\n    // Build paths\n    for (const endpoint of this.getAllEndpoints()) {\n      if (!spec.paths[endpoint.path]) {\n        spec.paths[endpoint.path] = {};\n      }\n\n      const method = endpoint.method.toLowerCase();\n      spec.paths[endpoint.path][method] = {\n        summary: endpoint.summary,\n        description: endpoint.description,\n        tags: endpoint.tags,\n        parameters: endpoint.parameters.map((p) => ({\n          name: p.name,\n          in: p.location,\n          required: p.required,\n          description: p.description,\n          schema: { type: p.type },\n        })),\n        requestBody: endpoint.requestBody,\n        responses: endpoint.responses.reduce(\n          (acc, r) => {\n            acc[r.status] = {\n              description: r.description,\n              content: { 'application/json': { schema: r.schema, example: r.example } },\n            };\n            return acc;\n          },\n          {} as Record<number, any>\n        ),\n        security: endpoint.authentication !== 'none' ? [{ bearerAuth: [] }] : [],\n      };\n    }\n\n    return spec;\n  }\n\n  /**\n   * Generate HTML documentation\n   */\n  generateHTMLDocumentation(): string {\n    let html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <title>FarmKonnect API Documentation</title>\n  <style>\n    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }\n    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }\n    h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }\n    h2 { color: #4CAF50; margin-top: 30px; }\n    .endpoint { border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 4px; }\n    .method { display: inline-block; padding: 5px 10px; border-radius: 4px; font-weight: bold; color: white; }\n    .get { background: #61affe; }\n    .post { background: #49cc90; }\n    .put { background: #fca130; }\n    .delete { background: #f93e3e; }\n    .path { font-family: monospace; background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0; }\n    .parameter { margin: 10px 0; padding: 10px; background: #f9f9f9; border-left: 3px solid #4CAF50; }\n    .response { margin: 10px 0; padding: 10px; background: #f9f9f9; border-left: 3px solid #2196F3; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <h1>FarmKonnect API Documentation</h1>\n    <p>Complete API reference for FarmKonnect farm management system</p>\n    <p><strong>Base URL:</strong> ${this.baseUrl}</p>\n    <p><strong>Authentication:</strong> Bearer token (JWT)</p>\n`;\n\n    for (const tag of this.getAllTags()) {\n      html += `<h2>${tag.name}</h2><p>${tag.description}</p>`;\n\n      for (const endpoint of this.getEndpointsByTag(tag.name)) {\n        html += `\n    <div class=\"endpoint\">\n      <div>\n        <span class=\"method ${endpoint.method.toLowerCase()}\">${endpoint.method}</span>\n        <span class=\"path\">${endpoint.path}</span>\n      </div>\n      <p><strong>${endpoint.summary}</strong></p>\n      <p>${endpoint.description}</p>\n`;\n\n        if (endpoint.parameters.length > 0) {\n          html += '<h4>Parameters:</h4>';\n          for (const param of endpoint.parameters) {\n            html += `\n      <div class=\"parameter\">\n        <strong>${param.name}</strong> (${param.type})${param.required ? ' *' : ''}<br>\n        ${param.description}\n      </div>\n`;\n          }\n        }\n\n        if (endpoint.responses.length > 0) {\n          html += '<h4>Responses:</h4>';\n          for (const response of endpoint.responses) {\n            html += `\n      <div class=\"response\">\n        <strong>${response.status}</strong> - ${response.description}\n      </div>\n`;\n          }\n        }\n\n        html += '</div>';\n      }\n    }\n\n    html += `\n  </div>\n</body>\n</html>\n`;\n\n    return html;\n  }\n\n  /**\n   * Generate Markdown documentation\n   */\n  generateMarkdownDocumentation(): string {\n    let md = `# FarmKonnect API Documentation\\n\\n`;\n    md += `**Base URL:** \\`${this.baseUrl}\\`\\n\\n`;\n    md += `**Authentication:** Bearer token (JWT)\\n\\n`;\n\n    for (const tag of this.getAllTags()) {\n      md += `## ${tag.name}\\n\\n${tag.description}\\n\\n`;\n\n      for (const endpoint of this.getEndpointsByTag(tag.name)) {\n        md += `### ${endpoint.summary}\\n\\n`;\n        md += `\\`\\`\\`\\n${endpoint.method} ${endpoint.path}\\n\\`\\`\\`\\n\\n`;\n        md += `${endpoint.description}\\n\\n`;\n\n        if (endpoint.parameters.length > 0) {\n          md += `#### Parameters\\n\\n`;\n          md += `| Name | Type | Required | Description |\\n`;\n          md += `|------|------|----------|-------------|\\n`;\n          for (const param of endpoint.parameters) {\n            md += `| ${param.name} | ${param.type} | ${param.required ? 'Yes' : 'No'} | ${param.description} |\\n`;\n          }\n          md += `\\n`;\n        }\n\n        if (endpoint.responses.length > 0) {\n          md += `#### Responses\\n\\n`;\n          for (const response of endpoint.responses) {\n            md += `- **${response.status}**: ${response.description}\\n`;\n          }\n          md += `\\n`;\n        }\n      }\n    }\n\n    return md;\n  }\n\n  /**\n   * Log API access\n   */\n  logAccess(endpoint: string, userId?: string): void {\n    this.accessLogs.push({\n      endpoint,\n      timestamp: Date.now(),\n      userId,\n    });\n  }\n\n  /**\n   * Get access statistics\n   */\n  getAccessStats(): {\n    totalAccesses: number;\n    byEndpoint: Record<string, number>;\n    last24Hours: number;\n  } {\n    const byEndpoint: Record<string, number> = {};\n    const now = Date.now();\n    const oneDayAgo = now - 86400000;\n\n    let last24Hours = 0;\n\n    for (const log of this.accessLogs) {\n      byEndpoint[log.endpoint] = (byEndpoint[log.endpoint] || 0) + 1;\n      if (log.timestamp > oneDayAgo) {\n        last24Hours++;\n      }\n    }\n\n    return {\n      totalAccesses: this.accessLogs.length,\n      byEndpoint,\n      last24Hours,\n    };\n  }\n}\n
