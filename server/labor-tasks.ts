import { EventEmitter } from 'events';\n\nexport type TaskStatus = 'pending' | 'assigned' | 'in_progress' | 'completed' | 'cancelled';\nexport type TaskPriority = 'low' | 'medium' | 'high' | 'urgent';\nexport type WorkerRole = 'manager' | 'supervisor' | 'operator' | 'laborer' | 'specialist';\n\nexport interface Worker {\n  id: string;\n  farmId: string;\n  name: string;\n  email: string;\n  phone: string;\n  role: WorkerRole;\n  hourlyRate: number;\n  startDate: number;\n  endDate?: number;\n  skills: string[];\n  isActive: boolean;\n}\n\nexport interface Task {\n  id: string;\n  farmId: string;\n  fieldId: string;\n  title: string;\n  description: string;\n  status: TaskStatus;\n  priority: TaskPriority;\n  assignedTo?: string; // worker ID\n  createdBy: string; // worker ID\n  createdAt: number;\n  dueDate: number;\n  startDate?: number;\n  completedDate?: number;\n  estimatedHours: number;\n  actualHours?: number;\n  cropType?: string;\n  equipment?: string[];\n  notes: string;\n}\n\nexport interface TimeLog {\n  id: string;\n  farmId: string;\n  workerId: string;\n  taskId: string;\n  date: number;\n  startTime: number;\n  endTime: number;\n  hoursWorked: number;\n  breakTime: number; // minutes\n  notes: string;\n}\n\nexport interface Shift {\n  id: string;\n  farmId: string;\n  workerId: string;\n  date: number;\n  startTime: number;\n  endTime: number;\n  duration: number; // hours\n  tasks: string[]; // task IDs\n  status: 'scheduled' | 'completed' | 'cancelled';\n  notes: string;\n}\n\nexport interface Payroll {\n  id: string;\n  farmId: string;\n  workerId: string;\n  period: { start: number; end: number };\n  regularHours: number;\n  overtimeHours: number;\n  hourlyRate: number;\n  regularPay: number;\n  overtimePay: number;\n  totalPay: number;\n  deductions: number;\n  netPay: number;\n  status: 'pending' | 'processed' | 'paid';\n}\n\nexport interface LaborCost {\n  workerId: string;\n  totalHours: number;\n  totalPay: number;\n  averageHourlyRate: number;\n  tasksCompleted: number;\n  productivityScore: number; // 0-100\n}\n\n/**\n * Labor & Task Management System\n */\nexport class LaborTaskManager extends EventEmitter {\n  private workers: Map<string, Worker> = new Map();\n  private tasks: Map<string, Task> = new Map();\n  private timeLogs: Map<string, TimeLog> = new Map();\n  private shifts: Map<string, Shift> = new Map();\n  private payrolls: Map<string, Payroll> = new Map();\n\n  constructor() {\n    super();\n  }\n\n  /**\n   * Register worker\n   */\n  registerWorker(\n    farmId: string,\n    name: string,\n    email: string,\n    phone: string,\n    role: WorkerRole,\n    hourlyRate: number,\n    skills: string[] = []\n  ): Worker {\n    const workerId = `worker_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const worker: Worker = {\n      id: workerId,\n      farmId,\n      name,\n      email,\n      phone,\n      role,\n      hourlyRate,\n      startDate: Date.now(),\n      skills,\n      isActive: true,\n    };\n\n    this.workers.set(workerId, worker);\n    this.emit('worker:registered', { workerId, farmId, name });\n    return worker;\n  }\n\n  /**\n   * Get worker\n   */\n  getWorker(workerId: string): Worker | null {\n    return this.workers.get(workerId) || null;\n  }\n\n  /**\n   * Get workers by farm\n   */\n  getWorkersByFarm(farmId: string): Worker[] {\n    return Array.from(this.workers.values()).filter((w) => w.farmId === farmId && w.isActive);\n  }\n\n  /**\n   * Create task\n   */\n  createTask(\n    farmId: string,\n    fieldId: string,\n    title: string,\n    description: string,\n    priority: TaskPriority,\n    dueDate: number,\n    estimatedHours: number,\n    createdBy: string,\n    cropType?: string,\n    equipment?: string[],\n    notes: string = ''\n  ): Task {\n    const taskId = `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const task: Task = {\n      id: taskId,\n      farmId,\n      fieldId,\n      title,\n      description,\n      status: 'pending',\n      priority,\n      createdBy,\n      createdAt: Date.now(),\n      dueDate,\n      estimatedHours,\n      cropType,\n      equipment,\n      notes,\n    };\n\n    this.tasks.set(taskId, task);\n    this.emit('task:created', { taskId, farmId, priority });\n    return task;\n  }\n\n  /**\n   * Get task\n   */\n  getTask(taskId: string): Task | null {\n    return this.tasks.get(taskId) || null;\n  }\n\n  /**\n   * Get tasks by farm\n   */\n  getTasksByFarm(farmId: string, status?: TaskStatus): Task[] {\n    let tasks = Array.from(this.tasks.values()).filter((t) => t.farmId === farmId);\n    if (status) {\n      tasks = tasks.filter((t) => t.status === status);\n    }\n    return tasks.sort((a, b) => a.dueDate - b.dueDate);\n  }\n\n  /**\n   * Assign task to worker\n   */\n  assignTask(taskId: string, workerId: string): Task | null {\n    const task = this.tasks.get(taskId);\n    if (!task) return null;\n\n    task.assignedTo = workerId;\n    task.status = 'assigned';\n    this.emit('task:assigned', { taskId, workerId });\n    return task;\n  }\n\n  /**\n   * Start task\n   */\n  startTask(taskId: string): Task | null {\n    const task = this.tasks.get(taskId);\n    if (!task) return null;\n\n    task.status = 'in_progress';\n    task.startDate = Date.now();\n    this.emit('task:started', { taskId });\n    return task;\n  }\n\n  /**\n   * Complete task\n   */\n  completeTask(taskId: string, actualHours: number): Task | null {\n    const task = this.tasks.get(taskId);\n    if (!task) return null;\n\n    task.status = 'completed';\n    task.completedDate = Date.now();\n    task.actualHours = actualHours;\n    this.emit('task:completed', { taskId, actualHours });\n    return task;\n  }\n\n  /**\n   * Record time log\n   */\n  recordTimeLog(\n    farmId: string,\n    workerId: string,\n    taskId: string,\n    startTime: number,\n    endTime: number,\n    breakTime: number = 0,\n    notes: string = ''\n  ): TimeLog {\n    const logId = `timelog_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const hoursWorked = (endTime - startTime) / 3600000 - breakTime / 60;\n\n    const log: TimeLog = {\n      id: logId,\n      farmId,\n      workerId,\n      taskId,\n      date: Date.now(),\n      startTime,\n      endTime,\n      hoursWorked,\n      breakTime,\n      notes,\n    };\n\n    this.timeLogs.set(logId, log);\n    this.emit('timelog:recorded', { logId, workerId, hoursWorked });\n    return log;\n  }\n\n  /**\n   * Get time logs for worker\n   */\n  getTimeLogsByWorker(workerId: string, startDate?: number, endDate?: number): TimeLog[] {\n    let logs = Array.from(this.timeLogs.values()).filter((l) => l.workerId === workerId);\n\n    if (startDate && endDate) {\n      logs = logs.filter((l) => l.date >= startDate && l.date <= endDate);\n    }\n\n    return logs.sort((a, b) => b.date - a.date);\n  }\n\n  /**\n   * Schedule shift\n   */\n  scheduleShift(\n    farmId: string,\n    workerId: string,\n    date: number,\n    startTime: number,\n    endTime: number,\n    tasks: string[] = [],\n    notes: string = ''\n  ): Shift {\n    const shiftId = `shift_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const duration = (endTime - startTime) / 3600000;\n\n    const shift: Shift = {\n      id: shiftId,\n      farmId,\n      workerId,\n      date,\n      startTime,\n      endTime,\n      duration,\n      tasks,\n      status: 'scheduled',\n      notes,\n    };\n\n    this.shifts.set(shiftId, shift);\n    this.emit('shift:scheduled', { shiftId, workerId, duration });\n    return shift;\n  }\n\n  /**\n   * Get shifts for worker\n   */\n  getShiftsByWorker(workerId: string): Shift[] {\n    return Array.from(this.shifts.values())\n      .filter((s) => s.workerId === workerId)\n      .sort((a, b) => b.date - a.date);\n  }\n\n  /**\n   * Generate payroll\n   */\n  generatePayroll(\n    farmId: string,\n    workerId: string,\n    periodStart: number,\n    periodEnd: number\n  ): Payroll {\n    const payrollId = `payroll_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const worker = this.workers.get(workerId);\n    if (!worker) throw new Error('Worker not found');\n\n    const timeLogs = this.getTimeLogsByWorker(workerId, periodStart, periodEnd);\n    const totalHours = timeLogs.reduce((sum, log) => sum + log.hoursWorked, 0);\n\n    const regularHours = Math.min(totalHours, 40); // Assume 40-hour week\n    const overtimeHours = Math.max(0, totalHours - 40);\n\n    const regularPay = regularHours * worker.hourlyRate;\n    const overtimePay = overtimeHours * worker.hourlyRate * 1.5; // 1.5x for overtime\n    const totalPay = regularPay + overtimePay;\n    const deductions = totalPay * 0.15; // 15% deductions (taxes, insurance, etc.)\n    const netPay = totalPay - deductions;\n\n    const payroll: Payroll = {\n      id: payrollId,\n      farmId,\n      workerId,\n      period: { start: periodStart, end: periodEnd },\n      regularHours,\n      overtimeHours,\n      hourlyRate: worker.hourlyRate,\n      regularPay,\n      overtimePay,\n      totalPay,\n      deductions,\n      netPay,\n      status: 'pending',\n    };\n\n    this.payrolls.set(payrollId, payroll);\n    this.emit('payroll:generated', { payrollId, workerId, netPay });\n    return payroll;\n  }\n\n  /**\n   * Get payroll\n   */\n  getPayroll(payrollId: string): Payroll | null {\n    return this.payrolls.get(payrollId) || null;\n  }\n\n  /**\n   * Calculate labor costs\n   */\n  calculateLaborCosts(workerId: string): LaborCost {\n    const timeLogs = Array.from(this.timeLogs.values()).filter((l) => l.workerId === workerId);\n    const completedTasks = Array.from(this.tasks.values()).filter(\n      (t) => t.assignedTo === workerId && t.status === 'completed'\n    );\n\n    const totalHours = timeLogs.reduce((sum, log) => sum + log.hoursWorked, 0);\n    const worker = this.workers.get(workerId);\n    const totalPay = totalHours * (worker?.hourlyRate || 0);\n    const averageHourlyRate = worker?.hourlyRate || 0;\n    const productivityScore = completedTasks.length > 0 ? Math.min(100, (completedTasks.length / (totalHours / 8)) * 100) : 0;\n\n    return {\n      workerId,\n      totalHours,\n      totalPay,\n      averageHourlyRate,\n      tasksCompleted: completedTasks.length,\n      productivityScore,\n    };\n  }\n\n  /**\n   * Get statistics\n   */\n  getStatistics(farmId: string): {\n    totalWorkers: number;\n    totalTasks: number;\n    completedTasks: number;\n    totalHoursWorked: number;\n    totalLaborCost: number;\n    averageProductivity: number;\n  } {\n    const workers = this.getWorkersByFarm(farmId);\n    const tasks = this.getTasksByFarm(farmId);\n    const completedTasks = tasks.filter((t) => t.status === 'completed');\n    const timeLogs = Array.from(this.timeLogs.values()).filter((l) => l.farmId === farmId);\n\n    const totalHoursWorked = timeLogs.reduce((sum, log) => sum + log.hoursWorked, 0);\n    const totalLaborCost = workers.reduce((sum, w) => {\n      const costs = this.calculateLaborCosts(w.id);\n      return sum + costs.totalPay;\n    }, 0);\n\n    const avgProductivity = workers.length > 0 ? workers.reduce((sum, w) => sum + this.calculateLaborCosts(w.id).productivityScore, 0) / workers.length : 0;\n\n    return {\n      totalWorkers: workers.length,\n      totalTasks: tasks.length,\n      completedTasks: completedTasks.length,\n      totalHoursWorked,\n      totalLaborCost,\n      averageProductivity: Math.round(avgProductivity),\n    };\n  }\n}\n
