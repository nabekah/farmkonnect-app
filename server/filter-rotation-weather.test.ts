import { describe, it, expect, beforeEach } from 'vitest';\nimport { CropRotationManager } from './crop-rotation';\nimport { WeatherManager } from './weather';\n\n/**\n * Crop Rotation Manager Tests\n */\ndescribe('Crop Rotation Manager', () => {\n  let manager: CropRotationManager;\n\n  beforeEach(() => {\n    manager = new CropRotationManager();\n  });\n\n  it('should initialize with default crops', () => {\n    const crops = manager.getAllCrops();\n    expect(crops.length).toBeGreaterThan(0);\n    expect(crops.some((c) => c.name === 'Wheat')).toBe(true);\n  });\n\n  it('should get crop by id', () => {\n    const crop = manager.getCrop('crop-wheat');\n    expect(crop).not.toBeNull();\n    expect(crop?.name).toBe('Wheat');\n  });\n\n  it('should get crops by family', () => {\n    const legumes = manager.getCropsByFamily('legume');\n    expect(legumes.length).toBeGreaterThan(0);\n    expect(legumes[0].family).toBe('legume');\n  });\n\n  it('should create rotation plan', () => {\n    const plan = manager.createRotationPlan('farm-1', 'field-1', 2026, {\n      nitrogen: 50,\n      phosphorus: 30,\n      potassium: 40,\n      pH: 6.5,\n    });\n\n    expect(plan).not.toBeNull();\n    expect(plan.farmId).toBe('farm-1');\n    expect(plan.year).toBe(2026);\n  });\n\n  it('should add crop to rotation plan', () => {\n    const plan = manager.createRotationPlan('farm-1', 'field-1', 2026, {\n      nitrogen: 50,\n      phosphorus: 30,\n      potassium: 40,\n      pH: 6.5,\n    });\n\n    const updated = manager.addCropToRotationPlan(\n      plan.id,\n      'spring',\n      'crop-wheat',\n      Date.now(),\n      Date.now() + 150 * 86400000,\n      5000\n    );\n\n    expect(updated).not.toBeNull();\n    expect(updated?.crops.length).toBe(1);\n    expect(updated?.crops[0].cropName).toBe('Wheat');\n  });\n\n  it('should get rotation plan', () => {\n    const created = manager.createRotationPlan('farm-1', 'field-1', 2026, {\n      nitrogen: 50,\n      phosphorus: 30,\n      potassium: 40,\n      pH: 6.5,\n    });\n\n    const retrieved = manager.getRotationPlan(created.id);\n    expect(retrieved).not.toBeNull();\n    expect(retrieved?.id).toBe(created.id);\n  });\n\n  it('should get rotation plans by field', () => {\n    manager.createRotationPlan('farm-1', 'field-1', 2026, {\n      nitrogen: 50,\n      phosphorus: 30,\n      potassium: 40,\n      pH: 6.5,\n    });\n    manager.createRotationPlan('farm-1', 'field-1', 2027, {\n      nitrogen: 55,\n      phosphorus: 32,\n      potassium: 42,\n      pH: 6.6,\n    });\n    manager.createRotationPlan('farm-1', 'field-2', 2026, {\n      nitrogen: 48,\n      phosphorus: 28,\n      potassium: 38,\n      pH: 6.4,\n    });\n\n    const plans = manager.getRotationPlansByField('field-1');\n    expect(plans.length).toBe(2);\n  });\n\n  it('should generate rotation recommendations', () => {\n    const rec = manager.generateRotationRecommendations('field-1', 'crop-wheat');\n\n    expect(rec).not.toBeNull();\n    expect(rec.currentCrop).toBe('Wheat');\n    expect(rec.recommendedCrops.length).toBeGreaterThan(0);\n    expect(rec.recommendedCrops[0].score).toBeGreaterThanOrEqual(0);\n    expect(rec.recommendedCrops[0].score).toBeLessThanOrEqual(100);\n  });\n\n  it('should prioritize legumes after high-N crops', () => {\n    const rec = manager.generateRotationRecommendations('field-1', 'crop-corn');\n\n    const legumes = rec.recommendedCrops.filter((c) => c.cropName.includes('Soybean'));\n    expect(legumes.length).toBeGreaterThan(0);\n    expect(legumes[0].score).toBeGreaterThan(50);\n  });\n\n  it('should record crop history', () => {\n    const history = manager.recordCropHistory(\n      'field-1',\n      'crop-wheat',\n      2025,\n      5000,\n      85,\n      ['armyworm'],\n      ['rust'],\n      'Good yield despite pest pressure'\n    );\n\n    expect(history).not.toBeNull();\n    expect(history.fieldId).toBe('field-1');\n    expect(history.yield).toBe(5000);\n  });\n\n  it('should get crop history for field', () => {\n    manager.recordCropHistory('field-1', 'crop-wheat', 2025, 5000, 85, [], [], '');\n    manager.recordCropHistory('field-1', 'crop-corn', 2024, 6000, 88, [], [], '');\n    manager.recordCropHistory('field-2', 'crop-wheat', 2025, 4500, 80, [], [], '');\n\n    const history = manager.getCropHistory('field-1');\n    expect(history.length).toBe(2);\n    expect(history[0].year).toBeGreaterThanOrEqual(history[1].year);\n  });\n\n  it('should get rotation statistics', () => {\n    manager.createRotationPlan('farm-1', 'field-1', 2026, {\n      nitrogen: 50,\n      phosphorus: 30,\n      potassium: 40,\n      pH: 6.5,\n    });\n    manager.generateRotationRecommendations('field-1', 'crop-wheat');\n\n    const stats = manager.getRotationStats();\n    expect(stats.totalCrops).toBeGreaterThan(0);\n    expect(stats.totalPlans).toBeGreaterThan(0);\n    expect(stats.totalRecommendations).toBeGreaterThan(0);\n    expect(stats.cropFamilies.legume).toBeGreaterThan(0);\n  });\n\n  it('should emit events', (done) => {\n    manager.on('plan:created', ({ planId, farmId }) => {\n      expect(planId).not.toBeUndefined();\n      expect(farmId).toBe('farm-1');\n      done();\n    });\n\n    manager.createRotationPlan('farm-1', 'field-1', 2026, {\n      nitrogen: 50,\n      phosphorus: 30,\n      potassium: 40,\n      pH: 6.5,\n    });\n  });\n});\n\n/**\n * Weather Manager Tests\n */\ndescribe('Weather Manager', () => {\n  let manager: WeatherManager;\n\n  beforeEach(() => {\n    manager = new WeatherManager();\n  });\n\n  it('should register farm weather profile', () => {\n    const profile = manager.registerFarmProfile('farm-1', 'North Field', 40.7128, -74.006, 10);\n\n    expect(profile).not.toBeNull();\n    expect(profile.farmId).toBe('farm-1');\n    expect(profile.location).toBe('North Field');\n  });\n\n  it('should get farm profile', () => {\n    manager.registerFarmProfile('farm-1', 'North Field', 40.7128, -74.006);\n    const profile = manager.getFarmProfile('farm-1');\n\n    expect(profile).not.toBeNull();\n    expect(profile?.location).toBe('North Field');\n  });\n\n  it('should record weather data', () => {\n    const data = manager.recordWeatherData(\n      'North Field',\n      40.7128,\n      -74.006,\n      22,\n      65,\n      5,\n      15,\n      'N',\n      6,\n      'cloudy',\n      20,\n      12,\n      1013\n    );\n\n    expect(data).not.toBeNull();\n    expect(data.temperature).toBe(22);\n    expect(data.condition).toBe('cloudy');\n  });\n\n  it('should get latest weather data', () => {\n    manager.recordWeatherData('North Field', 40.7128, -74.006, 22, 65, 5, 15, 'N', 6, 'cloudy', 20, 12, 1013);\n    manager.recordWeatherData('North Field', 40.7128, -74.006, 25, 60, 0, 10, 'NE', 7, 'clear', 23, 10, 1015);\n\n    const latest = manager.getLatestWeatherData('North Field');\n    expect(latest).not.toBeNull();\n    expect(latest?.temperature).toBe(25);\n  });\n\n  it('should create forecast', () => {\n    const tomorrow = Date.now() + 86400000;\n    const forecast = manager.createForecast('North Field', tomorrow, 28, 18, 'sunny', 0, 10, 55, 7);\n\n    expect(forecast).not.toBeNull();\n    expect(forecast.high).toBe(28);\n    expect(forecast.low).toBe(18);\n  });\n\n  it('should get forecast for location', () => {\n    const tomorrow = Date.now() + 86400000;\n    const dayAfter = Date.now() + 2 * 86400000;\n\n    manager.createForecast('North Field', tomorrow, 28, 18, 'sunny', 0, 10, 55, 7);\n    manager.createForecast('North Field', dayAfter, 25, 15, 'cloudy', 5, 12, 60, 6);\n\n    const forecasts = manager.getForecast('North Field', 7);\n    expect(forecasts.length).toBe(2);\n  });\n\n  it('should create weather alert', () => {\n    const alert = manager.createAlert(\n      'farm-1',\n      'frost',\n      'critical',\n      'Frost Alert',\n      'Temperature dropping below freezing',\n      ['wheat', 'corn'],\n      ['Cover crops', 'Run irrigation']\n    );\n\n    expect(alert).not.toBeNull();\n    expect(alert.type).toBe('frost');\n    expect(alert.severity).toBe('critical');\n    expect(alert.isActive).toBe(true);\n  });\n\n  it('should get active alerts for farm', () => {\n    manager.createAlert('farm-1', 'frost', 'critical', 'Frost Alert', 'Temperature dropping', [], []);\n    manager.createAlert('farm-1', 'heavy_rain', 'warning', 'Rain Alert', 'Heavy rainfall expected', [], []);\n    manager.createAlert('farm-2', 'drought', 'warning', 'Drought Alert', 'Dry conditions', [], []);\n\n    const alerts = manager.getActiveAlerts('farm-1');\n    expect(alerts.length).toBe(2);\n    expect(alerts[0].severity).toBe('critical');\n  });\n\n  it('should resolve alert', () => {\n    const alert = manager.createAlert('farm-1', 'frost', 'critical', 'Frost Alert', 'Temperature dropping', [], []);\n    const resolved = manager.resolveAlert(alert.id);\n\n    expect(resolved).not.toBeNull();\n    expect(resolved?.isActive).toBe(false);\n    expect(resolved?.endTime).not.toBeUndefined();\n  });\n\n  it('should check weather conditions and generate alerts', () => {\n    manager.registerFarmProfile('farm-1', 'North Field', 40.7128, -74.006);\n    manager.recordWeatherData('North Field', 40.7128, -74.006, -5, 65, 5, 15, 'N', 6, 'cloudy', -7, 12, 1013);\n\n    const alerts = manager.checkWeatherConditions('farm-1');\n    expect(alerts.length).toBeGreaterThan(0);\n    expect(alerts[0].type).toBe('frost');\n  });\n\n  it('should detect extreme heat', () => {\n    manager.registerFarmProfile('farm-1', 'North Field', 40.7128, -74.006);\n    manager.recordWeatherData('North Field', 40.7128, -74.006, 40, 30, 0, 20, 'S', 9, 'clear', 45, 10, 1010);\n\n    const alerts = manager.checkWeatherConditions('farm-1');\n    expect(alerts.some((a) => a.type === 'extreme_heat')).toBe(true);\n  });\n\n  it('should detect heavy rainfall', () => {\n    manager.registerFarmProfile('farm-1', 'North Field', 40.7128, -74.006);\n    manager.recordWeatherData('North Field', 40.7128, -74.006, 15, 90, 75, 30, 'W', 3, 'rainy', 14, 14, 990);\n\n    const alerts = manager.checkWeatherConditions('farm-1');\n    expect(alerts.some((a) => a.type === 'heavy_rain')).toBe(true);\n  });\n\n  it('should get weather history', () => {\n    manager.recordWeatherData('North Field', 40.7128, -74.006, 22, 65, 5, 15, 'N', 6, 'cloudy', 20, 12, 1013);\n    manager.recordWeatherData('North Field', 40.7128, -74.006, 25, 60, 0, 10, 'NE', 7, 'clear', 23, 10, 1015);\n    manager.recordWeatherData('North Field', 40.7128, -74.006, 20, 70, 10, 20, 'W', 5, 'rainy', 18, 14, 1008);\n\n    const history = manager.getWeatherHistory('North Field', 7);\n    expect(history.length).toBe(3);\n  });\n\n  it('should get weather statistics', () => {\n    manager.registerFarmProfile('farm-1', 'North Field', 40.7128, -74.006);\n    manager.recordWeatherData('North Field', 40.7128, -74.006, 22, 65, 5, 15, 'N', 6, 'cloudy', 20, 12, 1013);\n    manager.createForecast(Date.now() + 86400000, 'North Field', 28, 18, 'sunny', 0, 10, 55, 7);\n    manager.createAlert('farm-1', 'frost', 'critical', 'Frost Alert', 'Temperature dropping', [], []);\n\n    const stats = manager.getWeatherStats();\n    expect(stats.totalRecords).toBeGreaterThan(0);\n    expect(stats.registeredFarms).toBe(1);\n    expect(stats.activeAlerts).toBeGreaterThan(0);\n  });\n\n  it('should emit events', (done) => {\n    manager.on('profile:registered', ({ farmId, location }) => {\n      expect(farmId).toBe('farm-1');\n      expect(location).toBe('North Field');\n      done();\n    });\n\n    manager.registerFarmProfile('farm-1', 'North Field', 40.7128, -74.006);\n  });\n});\n\n/**\n * Integration Tests\n */\ndescribe('Integration Tests', () => {\n  it('should work with crop rotation and weather together', () => {\n    const cropManager = new CropRotationManager();\n    const weatherManager = new WeatherManager();\n\n    // Setup farm\n    weatherManager.registerFarmProfile('farm-1', 'Main Field', 40.7128, -74.006);\n\n    // Create rotation plan\n    const plan = cropManager.createRotationPlan('farm-1', 'field-1', 2026, {\n      nitrogen: 50,\n      phosphorus: 30,\n      potassium: 40,\n      pH: 6.5,\n    });\n    expect(plan).not.toBeNull();\n\n    // Record weather\n    const weather = weatherManager.recordWeatherData(\n      'Main Field',\n      40.7128,\n      -74.006,\n      22,\n      65,\n      5,\n      15,\n      'N',\n      6,\n      'cloudy',\n      20,\n      12,\n      1013\n    );\n    expect(weather).not.toBeNull();\n\n    // Get recommendations\n    const rec = cropManager.generateRotationRecommendations('field-1', 'crop-wheat');\n    expect(rec.recommendedCrops.length).toBeGreaterThan(0);\n\n    // Check weather conditions\n    const alerts = weatherManager.checkWeatherConditions('farm-1');\n    expect(alerts).toBeDefined();\n\n    // Both systems working together\n    const cropStats = cropManager.getRotationStats();\n    const weatherStats = weatherManager.getWeatherStats();\n\n    expect(cropStats.totalCrops).toBeGreaterThan(0);\n    expect(weatherStats.registeredFarms).toBeGreaterThan(0);\n  });\n});\n
