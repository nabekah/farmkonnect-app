import { EventEmitter } from 'events';\n\nexport type EmailTemplateType =\n  | 'payment_receipt'\n  | 'subscription_confirmation'\n  | 'achievement_unlocked'\n  | 'farm_invitation'\n  | 'yield_prediction'\n  | 'pest_alert'\n  | 'irrigation_reminder'\n  | 'harvest_ready'\n  | 'weekly_report'\n  | 'password_reset';\n\nexport interface EmailTemplate {\n  id: string;\n  type: EmailTemplateType;\n  name: string;\n  subject: string;\n  htmlContent: string;\n  textContent: string;\n  variables: string[];\n  category: string;\n}\n\nexport interface EmailMessage {\n  id: string;\n  to: string;\n  from: string;\n  subject: string;\n  htmlContent: string;\n  textContent: string;\n  templateType: EmailTemplateType;\n  variables: Record<string, any>;\n  status: 'pending' | 'sent' | 'failed' | 'bounced';\n  createdAt: number;\n  sentAt?: number;\n  failureReason?: string;\n}\n\nexport interface EmailCampaign {\n  id: string;\n  name: string;\n  templateType: EmailTemplateType;\n  recipients: string[];\n  variables: Record<string, any>;\n  status: 'draft' | 'scheduled' | 'sending' | 'completed' | 'failed';\n  createdAt: number;\n  scheduledAt?: number;\n  startedAt?: number;\n  completedAt?: number;\n  stats: {\n    total: number;\n    sent: number;\n    failed: number;\n    bounced: number;\n  };\n}\n\n/**\n * Email Templates Manager\n */\nexport class EmailTemplatesManager extends EventEmitter {\n  private templates: Map<string, EmailTemplate> = new Map();\n  private messages: Map<string, EmailMessage> = new Map();\n  private campaigns: Map<string, EmailCampaign> = new Map();\n  private deliveryLogs: Array<{ messageId: string; status: string; timestamp: number }> = [];\n\n  constructor(private sendgridApiKey: string = 'SG.test_key') {\n    super();\n    this.initializeTemplates();\n  }\n\n  /**\n   * Initialize default email templates\n   */\n  private initializeTemplates(): void {\n    const templates: EmailTemplate[] = [\n      {\n        id: 'tpl-payment-receipt',\n        type: 'payment_receipt',\n        name: 'Payment Receipt',\n        subject: 'Payment Confirmation - {{planName}}',\n        htmlContent: `\n          <h2>Payment Received</h2>\n          <p>Thank you for your payment, {{userName}}!</p>\n          <p><strong>Plan:</strong> {{planName}}</p>\n          <p><strong>Amount:</strong> ${{amount}}</p>\n          <p><strong>Date:</strong> {{date}}</p>\n          <p><strong>Receipt ID:</strong> {{receiptId}}</p>\n          <p>Your subscription is now active. <a href=\"{{dashboardUrl}}\">View your dashboard</a></p>\n        `,\n        textContent: `Payment Confirmation\\nThank you for your payment, {{userName}}!\\nPlan: {{planName}}\\nAmount: ${{amount}}\\nDate: {{date}}\\nReceipt ID: {{receiptId}}`,\n        variables: ['userName', 'planName', 'amount', 'date', 'receiptId', 'dashboardUrl'],\n        category: 'payments',\n      },\n      {\n        id: 'tpl-achievement',\n        type: 'achievement_unlocked',\n        name: 'Achievement Unlocked',\n        subject: 'üéâ Congratulations! You Unlocked: {{achievementTitle}}',\n        htmlContent: `\n          <h2>Achievement Unlocked!</h2>\n          <p>Great job, {{userName}}!</p>\n          <p>You've earned the <strong>{{achievementTitle}}</strong> achievement!</p>\n          <p>{{achievementDescription}}</p>\n          <p><strong>Points Earned:</strong> {{points}}</p>\n          <p><a href=\"{{shareUrl}}\">Share your achievement on social media</a></p>\n        `,\n        textContent: `Achievement Unlocked!\\nGreat job, {{userName}}!\\nYou've earned: {{achievementTitle}}\\n{{achievementDescription}}\\nPoints: {{points}}`,\n        variables: ['userName', 'achievementTitle', 'achievementDescription', 'points', 'shareUrl'],\n        category: 'achievements',\n      },\n      {\n        id: 'tpl-farm-invitation',\n        type: 'farm_invitation',\n        name: 'Farm Invitation',\n        subject: '{{inviterName}} invited you to manage {{farmName}}',\n        htmlContent: `\n          <h2>Farm Invitation</h2>\n          <p>{{inviterName}} has invited you to collaborate on {{farmName}}!</p>\n          <p><strong>Your Role:</strong> {{role}}</p>\n          <p><strong>Invitation expires in:</strong> {{expiresIn}} days</p>\n          <p><a href=\"{{acceptUrl}}\">Accept Invitation</a> | <a href=\"{{declineUrl}}\">Decline</a></p>\n        `,\n        textContent: `Farm Invitation\\n{{inviterName}} invited you to {{farmName}}\\nRole: {{role}}\\nExpires in: {{expiresIn}} days`,\n        variables: ['inviterName', 'farmName', 'role', 'expiresIn', 'acceptUrl', 'declineUrl'],\n        category: 'invitations',\n      },\n      {\n        id: 'tpl-yield-prediction',\n        type: 'yield_prediction',\n        name: 'Yield Prediction Report',\n        subject: 'Yield Prediction for {{cropType}} - {{farmName}}',\n        htmlContent: `\n          <h2>Yield Prediction Report</h2>\n          <p>Farm: {{farmName}}</p>\n          <p>Crop: {{cropType}}</p>\n          <p><strong>Predicted Yield:</strong> {{predictedYield}} units/acre</p>\n          <p><strong>Confidence:</strong> {{confidence}}%</p>\n          <p>{{reasoning}}</p>\n          <p><a href=\"{{reportUrl}}\">View detailed report</a></p>\n        `,\n        textContent: `Yield Prediction\\nFarm: {{farmName}}\\nCrop: {{cropType}}\\nPredicted Yield: {{predictedYield}} units/acre\\nConfidence: {{confidence}}%`,\n        variables: ['farmName', 'cropType', 'predictedYield', 'confidence', 'reasoning', 'reportUrl'],\n        category: 'predictions',\n      },\n      {\n        id: 'tpl-pest-alert',\n        type: 'pest_alert',\n        name: 'Pest Alert',\n        subject: '‚ö†Ô∏è Pest Alert for {{farmName}}',\n        htmlContent: `\n          <h2>Pest Alert</h2>\n          <p>Farm: {{farmName}}</p>\n          <p>Crop: {{cropType}}</p>\n          <p><strong>Alert Level:</strong> {{alertLevel}}</p>\n          <p>{{description}}</p>\n          <p><strong>Recommended Action:</strong> {{recommendedAction}}</p>\n          <p><a href=\"{{actionUrl}}\">Take Action</a></p>\n        `,\n        textContent: `Pest Alert\\nFarm: {{farmName}}\\nCrop: {{cropType}}\\nAlert Level: {{alertLevel}}\\n{{description}}`,\n        variables: ['farmName', 'cropType', 'alertLevel', 'description', 'recommendedAction', 'actionUrl'],\n        category: 'alerts',\n      },\n      {\n        id: 'tpl-irrigation-reminder',\n        type: 'irrigation_reminder',\n        name: 'Irrigation Reminder',\n        subject: 'üíß Irrigation Reminder for {{farmName}}',\n        htmlContent: `\n          <h2>Irrigation Reminder</h2>\n          <p>Farm: {{farmName}}</p>\n          <p>It's time to irrigate your {{cropType}}!</p>\n          <p><strong>Recommended Frequency:</strong> {{frequency}} times per week</p>\n          <p><strong>Soil Moisture:</strong> {{soilMoisture}}%</p>\n          <p><strong>Weather Forecast:</strong> {{weatherForecast}}</p>\n          <p><a href=\"{{scheduleUrl}}\">Schedule Irrigation</a></p>\n        `,\n        textContent: `Irrigation Reminder\\nFarm: {{farmName}}\\nCrop: {{cropType}}\\nFrequency: {{frequency}} times/week\\nSoil Moisture: {{soilMoisture}}%`,\n        variables: ['farmName', 'cropType', 'frequency', 'soilMoisture', 'weatherForecast', 'scheduleUrl'],\n        category: 'reminders',\n      },\n      {\n        id: 'tpl-harvest-ready',\n        type: 'harvest_ready',\n        name: 'Harvest Ready Notification',\n        subject: 'üåæ Your {{cropType}} is Ready for Harvest!',\n        htmlContent: `\n          <h2>Harvest Ready</h2>\n          <p>Farm: {{farmName}}</p>\n          <p>Your {{cropType}} is ready for harvest!</p>\n          <p><strong>Optimal Harvest Date:</strong> {{harvestDate}}</p>\n          <p><strong>Expected Yield:</strong> {{expectedYield}} units</p>\n          <p><strong>Weather Conditions:</strong> {{weatherConditions}}</p>\n          <p><a href=\"{{harvestPlanUrl}}\">Create Harvest Plan</a></p>\n        `,\n        textContent: `Harvest Ready\\nFarm: {{farmName}}\\nCrop: {{cropType}}\\nHarvest Date: {{harvestDate}}\\nExpected Yield: {{expectedYield}} units`,\n        variables: ['farmName', 'cropType', 'harvestDate', 'expectedYield', 'weatherConditions', 'harvestPlanUrl'],\n        category: 'harvest',\n      },\n      {\n        id: 'tpl-weekly-report',\n        type: 'weekly_report',\n        name: 'Weekly Farm Report',\n        subject: 'Weekly Report - {{farmName}}',\n        htmlContent: `\n          <h2>Weekly Farm Report</h2>\n          <p>Farm: {{farmName}}</p>\n          <p><strong>Week of:</strong> {{weekStart}} - {{weekEnd}}</p>\n          <p><strong>Tasks Completed:</strong> {{tasksCompleted}}</p>\n          <p><strong>Average Soil Moisture:</strong> {{avgSoilMoisture}}%</p>\n          <p><strong>Average Temperature:</strong> {{avgTemperature}}¬∞C</p>\n          <p><strong>Rainfall:</strong> {{rainfall}}mm</p>\n          <p><a href=\"{{reportUrl}}\">View Full Report</a></p>\n        `,\n        textContent: `Weekly Report\\nFarm: {{farmName}}\\nWeek: {{weekStart}} - {{weekEnd}}\\nTasks: {{tasksCompleted}}\\nSoil Moisture: {{avgSoilMoisture}}%`,\n        variables: ['farmName', 'weekStart', 'weekEnd', 'tasksCompleted', 'avgSoilMoisture', 'avgTemperature', 'rainfall', 'reportUrl'],\n        category: 'reports',\n      },\n    ];\n\n    for (const template of templates) {\n      this.templates.set(template.id, template);\n    }\n  }\n\n  /**\n   * Get template by ID\n   */\n  getTemplate(templateId: string): EmailTemplate | null {\n    return this.templates.get(templateId) || null;\n  }\n\n  /**\n   * Get templates by type\n   */\n  getTemplatesByType(type: EmailTemplateType): EmailTemplate[] {\n    return Array.from(this.templates.values()).filter((t) => t.type === type);\n  }\n\n  /**\n   * Get all templates\n   */\n  getAllTemplates(): EmailTemplate[] {\n    return Array.from(this.templates.values());\n  }\n\n  /**\n   * Render template with variables\n   */\n  renderTemplate(templateId: string, variables: Record<string, any>): { html: string; text: string } {\n    const template = this.getTemplate(templateId);\n    if (!template) throw new Error('Template not found');\n\n    let html = template.htmlContent;\n    let text = template.textContent;\n\n    for (const [key, value] of Object.entries(variables)) {\n      const placeholder = `{{${key}}}`;\n      html = html.replaceAll(placeholder, String(value));\n      text = text.replaceAll(placeholder, String(value));\n    }\n\n    return { html, text };\n  }\n\n  /**\n   * Send email\n   */\n  async sendEmail(\n    to: string,\n    templateId: string,\n    variables: Record<string, any>,\n    from: string = 'noreply@farmkonnect.com'\n  ): Promise<EmailMessage> {\n    const template = this.getTemplate(templateId);\n    if (!template) throw new Error('Template not found');\n\n    const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const rendered = this.renderTemplate(templateId, variables);\n    const subject = this.renderTemplate(templateId, variables).html.match(/<title>(.*?)<\\/title>/) \n      ? template.subject.replace(/{{\\w+}}/g, (match) => variables[match.slice(2, -2)] || match)\n      : template.subject;\n\n    const message: EmailMessage = {\n      id: messageId,\n      to,\n      from,\n      subject,\n      htmlContent: rendered.html,\n      textContent: rendered.text,\n      templateType: template.type,\n      variables,\n      status: 'pending',\n      createdAt: Date.now(),\n    };\n\n    this.messages.set(messageId, message);\n\n    // Simulate SendGrid API call\n    setTimeout(() => {\n      const success = Math.random() > 0.05; // 95% success rate\n      if (success) {\n        message.status = 'sent';\n        message.sentAt = Date.now();\n        this.emit('email:sent', { messageId, to, templateType: template.type });\n      } else {\n        message.status = 'failed';\n        message.failureReason = 'SMTP connection failed';\n        this.emit('email:failed', { messageId, to, reason: message.failureReason });\n      }\n      this.deliveryLogs.push({ messageId, status: message.status, timestamp: Date.now() });\n    }, 100);\n\n    return message;\n  }\n\n  /**\n   * Get message\n   */\n  getMessage(messageId: string): EmailMessage | null {\n    return this.messages.get(messageId) || null;\n  }\n\n  /**\n   * Get messages by recipient\n   */\n  getMessagesByRecipient(to: string): EmailMessage[] {\n    return Array.from(this.messages.values()).filter((m) => m.to === to);\n  }\n\n  /**\n   * Create email campaign\n   */\n  createCampaign(\n    name: string,\n    templateType: EmailTemplateType,\n    recipients: string[],\n    variables: Record<string, any>,\n    scheduledAt?: number\n  ): EmailCampaign {\n    const campaignId = `camp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const campaign: EmailCampaign = {\n      id: campaignId,\n      name,\n      templateType,\n      recipients,\n      variables,\n      status: scheduledAt ? 'scheduled' : 'draft',\n      createdAt: Date.now(),\n      scheduledAt,\n      stats: {\n        total: recipients.length,\n        sent: 0,\n        failed: 0,\n        bounced: 0,\n      },\n    };\n\n    this.campaigns.set(campaignId, campaign);\n    this.emit('campaign:created', { campaignId, name, recipientCount: recipients.length });\n    return campaign;\n  }\n\n  /**\n   * Send campaign\n   */\n  async sendCampaign(campaignId: string): Promise<EmailCampaign> {\n    const campaign = this.campaigns.get(campaignId);\n    if (!campaign) throw new Error('Campaign not found');\n\n    campaign.status = 'sending';\n    campaign.startedAt = Date.now();\n\n    const templateId = this.templates.get(`tpl-${campaign.templateType.replace(/_/g, '-')}`)?.id;\n    if (!templateId) throw new Error('Template not found');\n\n    for (const recipient of campaign.recipients) {\n      try {\n        await this.sendEmail(recipient, templateId, campaign.variables);\n        campaign.stats.sent++;\n      } catch (error) {\n        campaign.stats.failed++;\n      }\n    }\n\n    campaign.status = 'completed';\n    campaign.completedAt = Date.now();\n    this.emit('campaign:completed', { campaignId, stats: campaign.stats });\n    return campaign;\n  }\n\n  /**\n   * Get campaign\n   */\n  getCampaign(campaignId: string): EmailCampaign | null {\n    return this.campaigns.get(campaignId) || null;\n  }\n\n  /**\n   * Get email statistics\n   */\n  getEmailStats(): {\n    totalSent: number;\n    totalFailed: number;\n    successRate: number;\n    byTemplate: Record<string, number>;\n  } {\n    let totalSent = 0;\n    let totalFailed = 0;\n    const byTemplate: Record<string, number> = {};\n\n    for (const message of this.messages.values()) {\n      if (message.status === 'sent') {\n        totalSent++;\n      } else if (message.status === 'failed') {\n        totalFailed++;\n      }\n\n      byTemplate[message.templateType] = (byTemplate[message.templateType] || 0) + 1;\n    }\n\n    const total = totalSent + totalFailed;\n    const successRate = total > 0 ? (totalSent / total) * 100 : 0;\n\n    return {\n      totalSent,\n      totalFailed,\n      successRate: Math.round(successRate),\n      byTemplate,\n    };\n  }\n}\n
